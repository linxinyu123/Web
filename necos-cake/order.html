<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Orders</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{--primary:#102940;--accent:#F4C04B;--bg:#F5F5F7;--white:#fff;--muted:#667085;--radius:16px;--shadow:0 4px 20px rgba(0,0,0,.05);--shadow2:0 8px 30px rgba(16,41,64,.12);--danger:#DC2626;--ok:#137333;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Nunito,sans-serif;background:var(--bg);color:var(--primary)}
    .smart-header{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
    .logo-img{height:34px;width:auto}
    .lang-switch{display:flex;gap:8px}
    .lang-btn{border:none;border-radius:999px;padding:10px 12px;font-weight:900;cursor:pointer;background:#F3F4F6;color:var(--primary)}
    .lang-btn.active{background:var(--primary);color:#fff}
    .container{max-width:980px;margin:0 auto;padding:18px}
    .card{background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .title{font-size:20px;font-weight:900;margin:0}
    .small{font-size:12px;color:var(--muted);font-weight:800}
    .inp{flex:1;min-width:220px;border-radius:14px;border:2px solid #E5E7EB;padding:14px 14px;font-weight:900}
    .btn{border:none;border-radius:999px;padding:12px 14px;font-weight:900;cursor:pointer}
    .btn.primary{background:var(--accent);color:var(--primary)}
    .btn.ghost{background:#fff;color:var(--primary);box-shadow:var(--shadow)}
    .btn.danger{background:#fff;color:var(--danger);border:2px solid #FEE2E2}
    .list{display:flex;flex-direction:column;gap:12px;margin-top:14px}
    .orderCard{display:flex;gap:14px;align-items:flex-start;background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:14px}
    .left{flex:1;min-width:0}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tag{font-size:12px;font-weight:900;border-radius:999px;padding:6px 10px}
    .tag.paid{background:#E6F4EA;color:var(--ok)}
    .tag.pending,.tag.draft{background:#F3F4F6;color:#666}
    .tag.failed,.tag.refunded{background:#FEF2F2;color:var(--danger)}
    .tag.fs{background:#FFF7E6;color:#8a5b00}
    .btnRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    /* modal */
    .ov{position:fixed;inset:0;background:rgba(16,41,64,.55);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{width:min(760px,92vw);background:#fff;border-radius:20px;box-shadow:var(--shadow2);overflow:hidden}
    .mHead{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eee}
    .mTitle{font-weight:900}
    .x{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#F3F4F6;cursor:pointer;font-weight:900}
    .mBody{padding:16px;max-height:70vh;overflow:auto}
    .items{display:flex;flex-direction:column;gap:10px}
    .it{display:flex;gap:12px;align-items:center;background:#F9FAFB;border-radius:14px;padding:10px}
    .it img{width:52px;height:52px;border-radius:12px;object-fit:cover;background:#eee}
    .it .t{font-weight:900}
    .it .s{font-size:12px;color:var(--muted);font-weight:800}
    @media(max-width:820px){.orderCard{flex-direction:column}}
  </style>
</head>
<body>
<div class="smart-header">
  <div class="header-left">
    <img src="https://i.ibb.co/sJtMRwDB/IMG-20251219-091347.png" class="logo-img" alt="Neco's">
  </div>
  <div class="lang-switch">
    <button class="lang-btn" id="btn-en" onclick="setLang('en')">EN</button>
    <button class="lang-btn" id="btn-pt" onclick="setLang('pt')">PT</button>
    <button class="lang-btn" id="btn-cn" onclick="setLang('cn')">CN</button>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <h1 class="title" id="t-title">My Orders</h1>
      <button class="btn ghost" onclick="reloadAll()" id="t-refresh">Refresh</button>
    </div>
    <div class="small" id="t-sub" style="margin-top:6px;">Enter order number + phone to view your order.</div>

    <div class="row" style="margin-top:14px;">
      <input class="inp" id="inp-order" placeholder="Order No (NC251230-4F9K)" autocomplete="off">
      <input class="inp" id="inp-phone" placeholder="Phone (required)" autocomplete="off">
      <button class="btn primary" onclick="addOrder()" id="t-add">Add</button>
    </div>
  </div>

  <div class="list" id="list"></div>
  <div class="small" id="empty" style="text-align:center;margin-top:18px;display:none;">No orders yet.</div>
</div>

<div class="ov" id="ov">
  <div class="modal">
    <div class="mHead">
      <div class="mTitle" id="m-title">Order</div>
      <div class="x" onclick="closeModal()">✕</div>
    </div>
    <div class="mBody">
      <div class="row" style="gap:12px;flex-wrap:wrap;margin-bottom:10px;">
        <div class="card" style="padding:10px 12px;border-radius:14px;box-shadow:none;background:#F9FAFB;">
          <div class="small" id="t-mpay">Payment</div><div style="font-weight:900" id="m-pay"></div>
        </div>
        <div class="card" style="padding:10px 12px;border-radius:14px;box-shadow:none;background:#F9FAFB;">
          <div class="small" id="t-mful">Status</div><div style="font-weight:900" id="m-ful"></div>
        </div>
        <div class="card" style="padding:10px 12px;border-radius:14px;box-shadow:none;background:#F9FAFB;">
          <div class="small" id="t-mtotal">Total</div><div style="font-weight:900" id="m-total"></div>
        </div>
      </div>

      <div class="small" id="m-meta" style="margin-bottom:10px;"></div>
      <div class="items" id="m-items"></div>

      <div style="height:10px"></div>
      <button class="btn danger" style="width:100%" onclick="requestRefund()" id="t-refreq">Request refund</button>
      <div class="small" style="margin-top:8px;" id="t-refinfo">Refunds are handled by our WhatsApp support.</div>
    </div>
  </div>
</div>

<div class="ov" id="ov2">
  <div class="modal">
    <div class="mHead">
      <div class="mTitle" id="t-whTitle">Contact WhatsApp Support</div>
      <div class="x" onclick="closeRefund()">✕</div>
    </div>
    <div class="mBody">
      <div style="font-weight:900;margin-bottom:8px;" id="t-whMsg">Please contact our WhatsApp support to request a refund.</div>
      <div class="small" id="wh-text"></div>
      <div style="height:14px"></div>
      <a id="wh-link" class="btn primary" style="display:inline-block;text-decoration:none;" target="_blank" rel="noopener">Open WhatsApp</a>
      <button class="btn ghost" style="margin-left:8px;" onclick="closeRefund()">Close</button>
    </div>
  </div>
</div>

<script>
  const BASE_API = 'https://necosapi.lestoy.com/necos/v1';
  const KEY_TRACK = 'neco_tracked_orders_v2';
  const LANG_KEY = 'neco_lang_v1';

  // TODO: 替换成你的 WhatsApp 客服号码（含国家码，不要加 +）
  const WHATSAPP_NUMBER = '351XXXXXXXXX';

  let state = { lang: localStorage.getItem(LANG_KEY) || 'en' };
  let tracked = [];
  let activeForRefund = null;

  const TXT = {
    en:{
      title:'My Orders', sub:'Enter order number + phone to view your order.',
      add:'Add', refresh:'Refresh', empty:'No orders yet.',
      phOrder:'Order No (NC251230-4F9K)', phPhone:'Phone (required)',
      view:'View', remove:'Remove', refund:'Request refund',
      refinfo:'Refunds are handled by our WhatsApp support.',
      whTitle:'Contact WhatsApp Support',
      whMsg:'Please contact our WhatsApp support to request a refund.',
      openwa:'Open WhatsApp'
    },
    pt:{
      title:'Meus Pedidos', sub:'Digite número do pedido + telefone para ver seu pedido.',
      add:'Adicionar', refresh:'Atualizar', empty:'Sem pedidos.',
      phOrder:'Nº do Pedido (NC251230-4F9K)', phPhone:'Telefone (obrigatório)',
      view:'Ver', remove:'Remover', refund:'Pedir reembolso',
      refinfo:'Reembolsos são tratados pelo WhatsApp.',
      whTitle:'Falar no WhatsApp',
      whMsg:'Fale com nosso suporte no WhatsApp para pedir reembolso.',
      openwa:'Abrir WhatsApp'
    },
    cn:{
      title:'我的订单', sub:'请输入 订单号 + 手机号 查询订单。',
      add:'添加', refresh:'刷新', empty:'暂无订单。',
      phOrder:'订单号 (NC251230-4F9K)', phPhone:'手机号（必填）',
      view:'查看', remove:'移除', refund:'申请退款',
      refinfo:'退款请通过 WhatsApp 客服处理。',
      whTitle:'联系 WhatsApp 客服',
      whMsg:'请联系 WhatsApp 客服申请退款。',
      openwa:'打开 WhatsApp'
    }
  };

  function setLang(l){
    state.lang=l;
    localStorage.setItem(LANG_KEY, l);
    ['en','pt','cn'].forEach(x=>document.getElementById('btn-'+x).classList.toggle('active', x===l));
    const t=TXT[l];
    document.getElementById('t-title').innerText=t.title;
    document.getElementById('t-sub').innerText=t.sub;
    document.getElementById('t-add').innerText=t.add;
    document.getElementById('t-refresh').innerText=t.refresh;
    document.getElementById('inp-order').placeholder=t.phOrder;
    document.getElementById('inp-phone').placeholder=t.phPhone;
    document.getElementById('empty').innerText=t.empty;
    document.getElementById('t-refreq').innerText=t.refund;
    document.getElementById('t-refinfo').innerText=t.refinfo;
    document.getElementById('t-whTitle').innerText=t.whTitle;
    document.getElementById('t-whMsg').innerText=t.whMsg;
    document.getElementById('wh-link').innerText=t.openwa;
    render();
  }

  function money(c){ const n=Number(c||0); return '€'+(n/100).toFixed(2); }
  function safeJson(s, fb){ try{return s?JSON.parse(s):fb}catch(e){return fb} }
  function normPhone(p){ return String(p||'').trim().replace(/\s+/g,'').replace(/[^\d+]/g,'').slice(0,32); }

  function payClass(s){
    s=String(s||'').toLowerCase();
    if(s==='paid')return 'paid';
    if(s==='pending')return 'pending';
    if(s==='draft')return 'draft';
    if(s==='failed')return 'failed';
    if(s==='refunded')return 'refunded';
    return 'pending';
  }
  function fulLabel(v){
    v=String(v||'accepted').toLowerCase();
    const map = {
      en:{accepted:'Accepted',baking:'Baking',ready:'Ready',completed:'Completed',cancelled:'Cancelled'},
      pt:{accepted:'Aceite',baking:'A preparar',ready:'Pronto',completed:'Concluído',cancelled:'Cancelado'},
      cn:{accepted:'已接单',baking:'制作中',ready:'待领取',completed:'已完成',cancelled:'已取消'},
    };
    return (map[state.lang] && map[state.lang][v]) || v;
  }

  function load(){
    try{ tracked = JSON.parse(localStorage.getItem(KEY_TRACK)||'[]'); }catch(e){ tracked=[]; }
  }
  function save(){ localStorage.setItem(KEY_TRACK, JSON.stringify(tracked)); }

  async function fetchOrder(order_no, phone){
    const u = new URL(BASE_API + '/public/order');
    u.searchParams.set('order_no', order_no);
    u.searchParams.set('phone', phone);
    const r = await fetch(u.toString());
    const j = await r.json();
    if(!j.success) throw new Error(j.error||'not found');
    return j.data;
  }

  async function addOrder(){
    const orderNo = document.getElementById('inp-order').value.trim().toUpperCase();
    const phone = normPhone(document.getElementById('inp-phone').value.trim());
    if(!orderNo || !phone){ alert('Order No + Phone required'); return; }

    const exists = tracked.find(x=>x.order_no===orderNo && x.phone===phone);
    if(exists){ await reloadOne(orderNo, phone); return; }

    const data = await fetchOrder(orderNo, phone);
    tracked.unshift({ order_no: data.order_no, phone, cache: data, ts: Date.now() });
    save();
    document.getElementById('inp-order').value='';
    render();
  }

  async function reloadOne(orderNo, phone){
    const it = tracked.find(x=>x.order_no===orderNo && x.phone===phone);
    if(!it) return;
    const data = await fetchOrder(orderNo, phone);
    it.cache = data;
    it.ts = Date.now();
    save();
    render();
  }

  async function reloadAll(){
    for(const it of tracked){
      try{
        const data = await fetchOrder(it.order_no, it.phone);
        it.cache=data; it.ts=Date.now();
      }catch(e){}
    }
    save(); render();
  }

  function removeOrder(orderNo, phone){
    tracked = tracked.filter(x=>!(x.order_no===orderNo && x.phone===phone));
    save(); render();
  }

  function render(){
    const el=document.getElementById('list');
    const empty=document.getElementById('empty');
    if(!tracked.length){ el.innerHTML=''; empty.style.display='block'; return; }
    empty.style.display='none';
    const t=TXT[state.lang];

    el.innerHTML = tracked.map(x=>{
      const o=x.cache||{};
      const pay = o.status || '';
      const fs = o.fulfillment_status || 'accepted';
      const created = String(o.created_at||'').slice(0,16).replace('T',' ');
      const delivery = o.delivery_date||'';
      const items = safeJson(o.items_json, []);
      const first = items[0]||{};
      const title = safeJson(first.title_json,{})[state.lang] || safeJson(first.title_json,{})['en'] || 'Item';
      const name = safeJson(first.name_json,{})[state.lang] || safeJson(first.name_json,{})['en'] || '';
      const summary = items.length?`${title} · ${name} · x${first.qty||1}${items.length>1?` +${items.length-1}`:''}`:'—';

      return `
        <div class="orderCard">
          <div class="left">
            <div class="row">
              <div style="font-weight:900;">${o.order_no||x.order_no}</div>
              <div class="small">${created}</div>
            </div>
            <div class="tags">
              <div class="tag ${payClass(pay)}">${String(pay).toUpperCase()}</div>
              <div class="tag fs">${fulLabel(fs)}</div>
              ${delivery?`<div class="tag fs">PICKUP ${delivery}</div>`:''}
            </div>
            <div class="small" style="margin-top:8px;">${summary}</div>
            <div class="btnRow">
              <button class="btn ghost" onclick="openModal('${x.order_no}','${x.phone}')">${t.view}</button>
              <button class="btn danger" onclick="removeOrder('${x.order_no}','${x.phone}')">${t.remove}</button>
            </div>
          </div>
          <div style="font-weight:900;">${money(o.amount_cents||0)}</div>
        </div>`;
    }).join('');
  }

  function openModal(orderNo, phone){
    const it = tracked.find(x=>x.order_no===orderNo && x.phone===phone);
    if(!it) return;
    const o = it.cache||{};
    activeForRefund = { orderNo: o.order_no || orderNo, phone };

    document.getElementById('m-title').innerText = o.order_no || orderNo;
    document.getElementById('m-pay').innerText = String(o.status||'');
    document.getElementById('m-ful').innerText = fulLabel(o.fulfillment_status||'accepted');
    document.getElementById('m-total').innerText = money(o.amount_cents||0);

    const meta = [
      o.customer_name?`${o.customer_name}`:'',
      o.delivery_date?`Pickup: ${o.delivery_date}`:'',
      o.note?`Note: ${o.note}`:''
    ].filter(Boolean).join(' · ');
    document.getElementById('m-meta').innerText = meta;

    const items = safeJson(o.items_json, []);
    document.getElementById('m-items').innerHTML = (items||[]).map(it=>{
      const title = safeJson(it.title_json,{})[state.lang] || safeJson(it.title_json,{})['en'] || 'Item';
      const name = safeJson(it.name_json,{})[state.lang] || safeJson(it.name_json,{})['en'] || '';
      return `
        <div class="it">
          <img src="${it.img_url||''}" onerror="this.style.display='none'">
          <div style="min-width:0;flex:1;">
            <div class="t">${title}</div>
            <div class="s">${name} · x${it.qty||1}</div>
          </div>
          <div style="font-weight:900;">${money((it.price_cents||0)*(it.qty||1))}</div>
        </div>`;
    }).join('');

    document.getElementById('ov').style.display='flex';
  }

  function requestRefund(){
    if(!activeForRefund) return;
    const orderNo = activeForRefund.orderNo;
    const phone = activeForRefund.phone;

    const msg = `Hello, I would like to request a refund.\nOrder: ${orderNo}\nPhone: ${phone}`;
    document.getElementById('wh-text').innerText = msg;

    const link = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
    document.getElementById('wh-link').href = link;

    document.getElementById('ov2').style.display='flex';
  }

  function closeModal(){ document.getElementById('ov').style.display='none'; }
  function closeRefund(){ document.getElementById('ov2').style.display='none'; }

  // init
  load();
  setLang(state.lang);

  // 支付成功跳转过来自动 add（要求带 phone）
  (async ()=>{
    const p = new URLSearchParams(location.search);
    const add = (p.get('add')||'').trim().toUpperCase();
    const phone = normPhone((p.get('phone')||'').trim());
    if(add && phone){
      document.getElementById('inp-order').value = add;
      document.getElementById('inp-phone').value = phone;
      try{ await addOrder(); }catch(e){}
      history.replaceState({}, "", location.pathname);
    }
  })();
</script>
</body>
</html>
