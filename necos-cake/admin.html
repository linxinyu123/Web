<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Neco Admin</title>
<link rel="icon" type="image/png" href="https://lestoy.com/necos/f.png" />
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

<style>
  /* --- 1. Design System --- */
  :root {
    --primary: #102940;
    --accent: #F4C04B;
    --bg: #F5F5F7;
    --white: #FFFFFF;
    --text-gray: #666666;
    --border: #F0F0F0;
    --border-strong: #E5E7EB;
    --radius-box: 20px;
    --radius-btn: 50px;
    --radius-input: 14px;
    --shadow: 0 8px 24px rgba(16, 41, 64, 0.08);
    --header-h: 70px;

    --field-bg: #F9FAFB;
    --field-bg-focus: #FFFFFF;
    --muted: #999;
    --danger: #EF4444;
    --danger-bg: #FEE2E2;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body, button, input, select, textarea { font-family: 'Nunito', sans-serif; }

  body {
    background: var(--bg);
    color: var(--primary);
    margin: 0;
    padding-top: var(--header-h);
    overflow-x: hidden;
  }
  body.modal-open{
    overflow:hidden;
    position:fixed;
    width:100%;
  }

  /* --- Header --- */
  .smart-header {
    position: fixed; top: 0; left: 0; right: 0; height: var(--header-h);
    background: var(--white); z-index: 900;
    box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px;
    border-bottom: 2px solid var(--border);
  }
  .header-left { display: flex; align-items: center; gap: 15px; }
  .logo-img { height: 44px; width: auto; }
  .header-title { font-weight: 900; font-size: 18px; }

  /* Lang Switcher */
  .lang-switch { display: flex; background: #F3F4F6; border-radius: 20px; padding: 3px; margin-right: 0px; }
  .lang-btn {
    border: none; background: transparent; padding: 6px 10px;
    border-radius: 16px; font-size: 12px; font-weight: 800; color: #999;
    cursor: pointer; transition: all 0.2s;
  }
  .lang-btn.active { background: var(--accent); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  .header-actions { display: flex; align-items: center; }

  /* --- Layout --- */
  .container {
    max-width: 1200px; margin: 0 auto; padding: 20px;
    height: calc(100dvh - var(--header-h));
  }
  .grid-layout {
    display: grid; grid-template-columns: 380px 1fr; gap: 20px;
    height: 100%;
  }

  /* --- Panels --- */
  .panel {
    background: var(--white); border-radius: var(--radius-box);
    box-shadow: var(--shadow); display: flex; flex-direction: column;
    overflow: hidden; height: 100%; position: relative;
  }

  .panel-head {
    padding: 18px 20px; border-bottom: 2px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(255,255,255,0.98); z-index: 10;
  }
  .panel-title { font-size: 18px; font-weight: 900; }
  .panel-body { padding: 20px; padding-top: 10px; overflow-y: auto; flex: 1; position: relative;
    padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
  }

  /* Mobile: editor slides */
  .back-btn {
    display: none; align-items: center; justify-content: center;
    width: 32px; height: 32px; border-radius: 50%; background: #F3F4F6;
    margin-right: 10px; cursor: pointer; border:none;
  }
  .back-icon {
    width: 18px; height: 18px; background-color: var(--primary);
    -webkit-mask: url("https://lestoy.com/love/icones/back.svg") no-repeat center;
    -webkit-mask-size: contain;
    mask: url("https://lestoy.com/love/icones/back.svg") no-repeat center;
    mask-size: contain; display: inline-block;
  }
  @media (max-width: 900px) {
    .grid-layout { display: block; }
    .container { padding: 0; height: calc(100dvh - var(--header-h)); }
    #listPanel {
      position: fixed;
      top: var(--header-h);
      left: 0; right: 0; bottom: 0;
      border-radius: 0 !important;
      box-shadow: none !important;
      z-index: 950;
      display:flex;flex-direction:column;
    }
    .panel-body {padding-bottom: calc(108px + env(safe-area-inset-bottom, 0px));
  }
    #listPanel .panel-body { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; }
    .editor-panel {
      position: fixed; inset: 0; top: 0; z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
      border-radius: 0 !important; height: 100vh;
    }
    .editor-panel.open { transform: translateX(0); }
    .back-btn { display: flex; }
    .panel-head { padding: 20px 20px 10px 20px; border-bottom: 0; }
  }

  /* --- List Items --- */
  .search-box { padding: 0 0 15px 0; border-bottom: 2px solid var(--border); margin-bottom: 15px; }
  .item-list { display: flex; flex-direction: column; gap: 12px; padding-bottom: 26px; }
  .list-item {
    display: flex; align-items: center; gap: 15px;
    padding: 12px; border-radius: 16px; border: 2px solid var(--border);
    cursor: pointer; transition: all 0.2s; background: #fff;
  }
  .list-item:hover, .list-item.active {
    border-color: var(--accent); box-shadow: 0 4px 12px rgba(244,192,75,0.15);
  }
  .item-thumb {
    width: 60px; height: 60px; border-radius: 12px; object-fit: cover;
    background: #f0f0f0; flex-shrink: 0;
  }
  .item-info { flex: 1; overflow: hidden; }
  .item-title { font-weight: 800; font-size: 16px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .item-meta { display: flex; gap: 8px; font-size: 13px; color: #888; font-weight: 700; align-items: center; flex-wrap: wrap; }
  .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
  .status-dot.active { background: #10B981; }

  /* --- Form Elements --- */
  .form-group { margin-bottom: 18px; }
  label {
    display: block; font-size: 13px; font-weight: 800; color: #999;
    text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;
  }
  input, textarea, .select-native {
    width: 100%;
    border: 2px solid var(--border-strong);
    border-radius: var(--radius-input);
    padding: 12px 14px;
    font-size: 15px;
    font-weight: 700;
    color: var(--primary);
    background: var(--field-bg);
    outline: none;
    transition: border 0.2s, background 0.2s;
  }
  input:focus, textarea:focus, .select-native:focus {
    border-color: var(--accent);
    background: var(--field-bg-focus);
  }
  textarea { min-height: 80px; resize: vertical; }

  .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

  .lang-group {
    background: #F8F9FA; border-radius: 16px; padding: 15px;
    border: 2px solid var(--border); margin-bottom: 20px;
  }
  .lang-label { font-size: 14px; font-weight: 900; margin-bottom: 10px; display:flex; align-items:center; gap:6px; }
  .lang-label .lang-pill {
    font-size: 12px; font-weight: 900; padding: 4px 8px; border-radius: 999px;
    background: #EEF2F7; color: var(--primary);
  }

  /* --- Buttons --- */
  .btn {
    border: none; border-radius: var(--radius-btn); padding: 12.5px 20px;
    font-weight: 900; font-size: 14.5px; cursor: pointer; transition: transform 0.1s, box-shadow 0.2s;
    display: inline-flex; align-items: center; justify-content: center; gap: 6px;
  }
  .btn:active { transform: scale(0.96); }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .btn-primary { background: var(--accent); color: var(--primary); box-shadow: 0 4px 12px rgba(244,192,75,0.3); }
  .btn-ghost { background: #F3F4F6; color: var(--primary); }
  .btn-danger { background: var(--danger-bg); color: var(--danger); }
  .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: 50%; }
  .btn-full { width: 100%; }
  .btn-small { padding: 8px 14px; font-size: 13.5px; }

  /* --- Variant Cards --- */
  .variant-list { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
  .v-card {
    background: #fff; border: 2px solid var(--border); border-radius: 14px; padding: 12px;
    display: flex; justify-content: space-between; align-items: center;
    gap: 10px;
  }
  .v-info { min-width: 0; }
  .v-info div { font-size: 15px; font-weight: 800; }
  .v-price { color: var(--primary); font-weight: 900; font-size: 15px; margin-top: 2px; }

  /* --- Select wrapper --- */
  .select-wrap { position: relative; width: 100%; }

  /* --- 2. Image Upload Layout --- */
  .image-upload-container {
    display: flex; gap: 16px; align-items: stretch;
    background: #fff; border: 2px solid var(--border); border-radius: 16px; padding: 15px;
  }
  .current-img-box {
    flex: 1 1 50%;
    min-width: 50%;
    min-height: 140px;
    background: #f0f0f0; border-radius: 12px;
    overflow: hidden; position: relative;
  }
  .current-img-box img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .current-img-box .empty-txt {
    position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
    color: #999; font-weight: 800; font-size: 12px; text-align: center;
    padding: 10px;
  }
  .upload-actions { flex: 1 1 50%; display: flex; flex-direction: column; gap: 10px; justify-content: center; min-width: 0; }
  .upload-actions input { margin-bottom: 6px; }

  @media (max-width: 600px) {
    .image-upload-container { flex-direction: column; }
    .current-img-box { width: 100%; min-width: 100%; min-height: 170px; }
  }

  /* Loading Spinner */
  .loader-overlay {
    position: absolute; inset: 0; background: rgba(255,255,255,0.8);
    display: none; align-items: center; justify-content: center; z-index: 5;
  }
  .loader-overlay.active { display: flex; }
  .loader {
    border: 3px solid #f3f3f3; border-top: 3px solid var(--accent);
    border-radius: 50%; width: 24px; height: 24px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  /* --- Modal --- */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(16,41,64,0.6); backdrop-filter: blur(2px);
    display: none; justify-content: center; align-items: center; z-index: 2000;
      opacity: 0;
  pointer-events: none;
  transition: opacity 0.18s ease;
  }
  
  .modal-overlay.open { display: flex; opacity: 1;
  pointer-events: auto;}

  .modal-card{
    background: var(--white);
    width: 90%;
    max-width: 520px;
    border-radius: 24px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    animation: slideUp 0.3s ease;
    position: relative;
    max-height: min(86vh, 760px);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    padding: 0;
    transform: translateY(16px) scale(0.98);
  opacity: 0;
  transition:
    transform 0.22s cubic-bezier(0.2, 0.8, 0.2, 1),
    opacity 0.18s ease;
  }
  .modal-overlay.open .modal-card {
  transform: translateY(0) scale(1);
  opacity: 1;
}
  .modal-close-btn{
    position: absolute; top: 15px; right: 15px;
    background: rgba(255,255,255,0.9);
    width: 36px; height: 36px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; cursor: pointer;
    z-index: 30;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: none;
    color: var(--primary);
    font-weight: 900;
  }
  .modal-scroll{
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 24px;
    padding-top: 52px;
  }
  .modal-footer{
    padding: 16px 24px 20px 24px;
    background: var(--white);
    z-index: 20;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }
  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  /* Toast */
  #toast {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: rgba(16,41,64,0.9); color: #fff; padding: 12px 24px;
    border-radius: 50px; font-weight: 800; z-index: 3000;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }

  /* helper */
  .divider { border-top: 2px solid #eee; margin:20px 0; }
  .muted { font-size: 12px; color: #888; line-height: 1.2; }
  .empty-state { font-size: 13px; color:#999; padding: 10px; text-align:center; }

  /* =========================
     Custom Select (cselect) - Enterprise Grade
     ========================= */
  .select-wrap select.select-native.cselect-native {
    position: absolute !important;
    left: -9999px !important;
    width: 1px !important;
    height: 1px !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }
  .cselect { position: relative; width: 100%; }
 /* --- 找到这一块并替换 --- */
  .cselect-btn {
    width: 100%;
    border: 2px solid var(--border-strong);
    border-radius: var(--radius-input);
    padding: 12px 40px 12px 14px;
    font-size: 15px;
    font-weight: 700;
    color: var(--primary);
    background: var(--field-bg);
    outline: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    transition: border 0.2s, background 0.2s; /* 移除了 box-shadow 动画，更稳 */
    min-height: 48px;
    user-select: none;         /* ✅ 新增：防止文字被选中 */
    -webkit-user-select: none; /* ✅ 新增：兼容手机 */
    -webkit-tap-highlight-color: transparent;
  }
  
  .cselect-btn:active {
    /* transform: scale(0.995); ❌ 删除这一行，消除布局抖动 */
    background: #eaeaea;      /* ✅ 改为变色反馈，布局不会动 */
    border-color: var(--accent);
  }

  .cselect-btn:focus,
  .cselect-btn.cselect-open {
    border-color: var(--accent);
    background: var(--field-bg-focus);
  }
  .cselect-label {
    flex: 1;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .cselect-arrow {
    position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
    width: 18px; height: 18px;
    background-color: var(--primary);
    -webkit-mask: url("https://lestoy.com/love/icones/down.svg") no-repeat center;
    -webkit-mask-size: contain;
    mask: url("https://lestoy.com/love/icones/down.svg") no-repeat center;
    mask-size: contain;
    opacity: 0.8;
    transition: transform 0.2s ease;
    pointer-events: none;
  }
  .cselect-btn.cselect-open .cselect-arrow { transform: translateY(-50%) rotate(180deg); }

  /* --- 找到这一块并完全替换 --- */
  .cselect-pop {
    position: fixed;
    background: var(--white);
    border: 2px solid var(--border-strong);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(16, 41, 64, 0.15);
    z-index: 9999;
    overflow: hidden;
    
    /* ✅ 关键修改： */
    display: flex;             /* 始终保持 flex 布局，不再切换 display */
    flex-direction: column;
    visibility: hidden;        /* 默认不可见 */
    opacity: 0;                /* 透明 */
    pointer-events: none;      /* 不可见时无法点击 */
    
    transform: translateY(-8px);
    /* 增加 visibility 的过渡，防止动画没播完就突然消失 */
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
    box-sizing: border-box;
  }

  .cselect-pop.open {
    visibility: visible;       /* 打开时可见 */
    opacity: 1;
    pointer-events: auto;      /* 打开时可点击 */
    transform: translateY(0);
    /* 打开时不需要延迟 visibility */
    transition: opacity 0.2s ease, transform 0.2s ease;
  }
  .cselect-search {
    padding: 10px;
    border-bottom: 1px solid var(--border);
    background: #FAFAFA;
  }
  .cselect-search input {
    width: 100%;
    border: 1px solid #E5E7EB;
    border-radius: 10px;
    padding: 8px 12px;
    font-size: 13px;
    font-weight: 700;
    color: var(--primary);
    background: #FFF;
    outline: none;
  }
  .cselect-search input:focus { border-color: var(--accent); }
  .cselect-list {
    max-height: 260px;
    overflow-y: auto;
    padding: 6px;
    -webkit-overflow-scrolling: touch;
  }
  .cselect-opt {
    padding: 10px 12px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
    font-size: 14px;
    color: var(--primary);
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: background 0.1s;
  }
  .cselect-opt:hover, .cselect-opt.highlighted { background: #F3F4F6; }
  .cselect-opt[aria-selected="true"] { background: rgba(244,192,75,0.15); color: #D97706; }
  .cselect-opt .tick {
    width: 16px; height: 16px;
    background-color: currentColor;
    -webkit-mask: url("https://lestoy.com/love/icones/check.svg") no-repeat center;
    -webkit-mask-size: contain;
    mask: url("https://lestoy.com/love/icones/check.svg") no-repeat center;
    mask-size: contain;
    opacity: 0;
  }
  .cselect-opt[aria-selected="true"] .tick { opacity: 1; }
  .cselect-empty { padding: 16px; font-size: 13px; color: #999; text-align: center; }
  @media (max-width: 600px) { .cselect-list { max-height: 320px; } }
</style>
</head>

<body>
<header class="smart-header">
  <div class="header-left">
    <img class="logo-img" src="https://lestoy.com/necos/logo.png" alt="logo" onerror="this.style.display='none'">
    <div class="header-title">Admin</div>
  </div>

  <div class="header-actions">
    <div class="lang-switch" aria-label="Language Switcher">
      <button class="lang-btn" onclick="setAdminLang('en')">EN</button>
      <button class="lang-btn" onclick="setAdminLang('pt')">PT</button>
      <button class="lang-btn" onclick="setAdminLang('cn')">CN</button>
    </div>
  </div>
</header>

<div class="container">
  <div class="grid-layout">

    <!-- LEFT: Product List -->
    <div class="panel" id="listPanel">
      <div class="panel-head">
        <div class="panel-title" data-i18n="products">Products</div>
        <div style="display:flex; gap:8px;">
          <!-- 动态分类管理按钮 -->
          <button class="btn btn-ghost" onclick="openCategoryManager()" data-i18n="manageCats">Categories</button>
          <button class="btn btn-primary" onclick="openNewProductModal()">+ <span data-i18n="new">New</span></button>
        </div>
      </div>

      <div class="panel-body">
        <div class="search-box">
          <input id="searchInput" placeholder="Search..." oninput="renderList()">
        </div>

        <div style="display:flex; gap:10px; margin-bottom:15px;">
          <div class="select-wrap" style="flex:1">
            <!-- 动态分类筛选（不再写死） -->
            <select id="catFilter" class="select-native" onchange="onRememberCategory(this.value); renderList()">
              <option value="" data-i18n="allCats">All Categories</option>
            </select>
          </div>
        </div>

        <div class="item-list" id="productList"></div>
      </div>
    </div>

    <!-- RIGHT: Editor Panel -->
    <div class="panel editor-panel" id="editorPanel">
      <div class="panel-head">
        <button class="back-btn" onclick="closeEditorMobile()"><span class="back-icon"></span></button>
        <div class="panel-title" data-i18n="editProduct">Edit Product</div>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-primary" id="btnSave" onclick="saveProduct()" disabled data-i18n="save">Save</button>
        </div>
      </div>

      <div class="panel-body">
        <div id="editorEmpty" class="empty-state" style="margin-top:50px;" data-i18n="selectHint">Select a product to edit</div>

        <div id="editorForm" style="display:none;">
          <div class="row-2">
            <div class="form-group">
              <label data-i18n="id">ID</label>
              <input id="pId" disabled style="background:#eee; color:#777;">
            </div>

            <div class="form-group">
              <label data-i18n="category">Category</label>
              <div class="select-wrap">
                <!-- 动态分类选择 -->
                <select id="pCategory" class="select-native" onchange="onRememberCategory(this.value)"></select>
              </div>
            </div>
          </div>

          <div class="row-2">
            <div class="form-group">
              <label data-i18n="sort">Sort Order</label>
              <input type="number" id="pSort" placeholder="0">
            </div>

            <div class="form-group">
              <label data-i18n="status">Status</label>
              <div class="select-wrap">
                <select id="pActive" class="select-native">
                  <option value="1" data-i18n="active">Active</option>
                  <option value="0" data-i18n="inactive">Inactive</option>
                </select>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="form-group">
            <label data-i18n="image">Product Image</label>
            <div class="image-upload-container">
              <div class="current-img-box">
                <img id="pImgPreview" src="" style="display:none;">
                <div id="pImgEmpty" class="empty-txt" data-i18n="noImage">No image</div>
                <div class="loader-overlay" id="imgLoader"><div class="loader"></div></div>
              </div>

              <div class="upload-actions">
                <input type="file" id="imgUploadInput" accept="image/*" />
                <button class="btn btn-ghost btn-full" onclick="uploadImage()" data-i18n="uploadBtn">Upload & Replace</button>
                <div class="muted">* <span data-i18n="imgNote">New image replaces old one automatically.</span></div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="lang-group">
            <div class="lang-label"><span class="lang-pill">EN</span> <span data-i18n="lang_en">English</span></div>
            <input id="tEN" placeholder="" style="margin-bottom:10px; font-weight:800;">
            <textarea id="dEN" placeholder=""></textarea>
          </div>

          <div class="lang-group">
            <div class="lang-label"><span class="lang-pill">PT</span> <span data-i18n="lang_pt">Portuguese</span></div>
            <input id="tPT" placeholder="" style="margin-bottom:10px;">
            <textarea id="dPT" placeholder=""></textarea>
          </div>

          <div class="lang-group">
            <div class="lang-label"><span class="lang-pill">CN</span> <span data-i18n="lang_cn">Chinese</span></div>
            <input id="tCN" placeholder="" style="margin-bottom:10px;">
            <textarea id="dCN" placeholder=""></textarea>
          </div>

          <div class="divider"></div>

          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <label style="margin:0;" data-i18n="variants">VARIANTS</label>
            <button class="btn btn-ghost btn-small" onclick="openVariantModal()">+ <span data-i18n="add">Add</span></button>
          </div>

          <div id="variantList" class="variant-list"></div>

          <div class="divider"></div>

          <button class="btn btn-danger btn-full" id="btnDeleteBottom" onclick="deleteProduct()" disabled data-i18n="deleteProduct">
            Delete Product
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Variant Editor Modal -->
<div class="modal-overlay" id="variantModal" onclick="closeModalByOverlay(event)">
  <div class="modal-card" onclick="event.stopPropagation()">
    <button class="modal-close-btn" onclick="closeModal('variantModal')" aria-label="Close">✕</button>

    <div class="modal-scroll">
      <div class="panel-title" style="margin-bottom:20px;" data-i18n="editVariant">Edit Variant</div>

      <div class="form-group">
        <label data-i18n="priceEuro">Price (€)</label>
        <input type="number" id="vPriceEuro" placeholder="">
      </div>

      <div class="form-group">
        <label data-i18n="variantNameEN">Name (EN)</label>
        <input id="vNameEN" placeholder="">
      </div>

      <div class="row-2">
        <div class="form-group">
          <label data-i18n="variantNamePT">Name (PT)</label>
          <input id="vNamePT" placeholder="">
        </div>
        <div class="form-group">
          <label data-i18n="variantNameCN">Name (CN)</label>
          <input id="vNameCN" placeholder="">
        </div>
      </div>

      <div class="row-2">
        <div class="form-group">
          <label data-i18n="sort">Sort</label>
          <input type="number" id="vSort" placeholder="0">
        </div>

        <div class="form-group">
          <label data-i18n="active">Active</label>
          <div class="select-wrap">
            <select id="vActive" class="select-native">
              <option value="1" data-i18n="yes">Yes</option>
              <option value="0" data-i18n="no">No</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('variantModal')" data-i18n="cancel">Cancel</button>
      <button class="btn btn-primary" onclick="saveVariant()" data-i18n="save">Save</button>
    </div>
  </div>
</div>

<!-- New Product Modal -->
<div class="modal-overlay" id="newProductModal" onclick="closeModalByOverlay(event)">
  <div class="modal-card" onclick="event.stopPropagation()">
    <button class="modal-close-btn" onclick="closeModal('newProductModal')" aria-label="Close">✕</button>

    <div class="modal-scroll">
      <div class="panel-title" style="margin-bottom:20px;" data-i18n="newProduct">New Product</div>

      <div class="form-group">
        <label data-i18n="category">Category</label>
        <div class="select-wrap">
          <!-- 动态分类选择 -->
          <select id="newCategory" class="select-native" onchange="onRememberCategory(this.value)"></select>
        </div>
        <div class="muted" data-i18n="newProductHint" style="margin-top:8px;">The product will be created as inactive by default.</div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('newProductModal')" data-i18n="cancel">Cancel</button>
      <button class="btn btn-primary" onclick="createNewProduct()" data-i18n="create">Create</button>
    </div>
  </div>
</div>

<!-- Category Manager Modal (新增) -->
<div class="modal-overlay" id="categoryModal" onclick="closeModalByOverlay(event)">
  <div class="modal-card" onclick="event.stopPropagation()">
    <button class="modal-close-btn" onclick="closeModal('categoryModal')" aria-label="Close">✕</button>
    <div class="modal-scroll">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:16px;">
        <div class="panel-title" data-i18n="manageCats">Categories</div>
        <button class="btn btn-primary btn-small" onclick="openCategoryEdit(null)">+ <span data-i18n="new">New</span></button>
      </div>
      <div id="categoryList" class="item-list"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('categoryModal')" data-i18n="close">Close</button>
    </div>
  </div>
</div>

<!-- Category Edit Modal -->
<div class="modal-overlay" id="categoryEditModal" onclick="closeModalByOverlay(event)">
  <div class="modal-card" onclick="event.stopPropagation()">
<button class="modal-close-btn" onclick="closeCategoryEdit()" aria-label="Close">✕</button>

    <div class="modal-scroll">
      <div class="panel-title" style="margin-bottom:20px;" data-i18n="editCategory">Edit Category</div>

      <!-- 1. ID 单独一行 -->
      <div class="form-group">
       <label data-i18n="catId">Category ID</label>
<input id="cId" disabled style="background:#eee; color:#777;" placeholder="(Auto)" />

      </div>

      <!-- 2. 排序 和 状态 并排 -->
      <div class="row-2">
        <div class="form-group">
          <label data-i18n="sort">Sort</label>
          <input type="number" id="cSort" placeholder="0" />
        </div>

        <div class="form-group">
          <label data-i18n="status">Status</label>
          <div class="select-wrap">
            <select id="cActive" class="select-native">
              <option value="1" data-i18n="active">Active</option>
              <option value="0" data-i18n="inactive">Inactive</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- 状态下方的提示语 -->
      <div class="form-group" style="margin-top:-10px; margin-bottom:20px;">
         <div class="muted" data-i18n="catDisableHint">If disabled, all products in this category will be disabled automatically.</div>
      </div>

      <!-- 3. 图片上传区域（使用 flex 布局：左图右按钮） -->
      <div class="form-group">
        <label data-i18n="catImage">Category Cover</label>
        <div class="image-upload-container">
          <!-- 左侧：图片预览 -->
          <div class="current-img-box" style="min-height:140px;">
            <img id="cImgPreview" src="" style="display:none;">
            <div id="cImgEmpty" class="empty-txt" data-i18n="noImage">No image</div>
            <div class="loader-overlay" id="catImgLoader"><div class="loader"></div></div>
          </div>

          <!-- 右侧：操作按钮 -->
          <div class="upload-actions">
            <input type="file" id="cImgFile" accept="image/*" />
            <button class="btn btn-ghost btn-full" onclick="uploadCategoryImage()" data-i18n="uploadBtn">Upload & Replace</button>
            <div class="muted" data-i18n="catImageHint">This image is used on the home category cards.</div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <!-- 多语言输入区域 (保持不变) -->
      <div class="lang-group">
        <div class="lang-label"><span class="lang-pill">EN</span> <span data-i18n="lang_en">English</span></div>
        <input id="cTEN" placeholder="" style="margin-bottom:10px; font-weight:800;">
        <textarea id="cDEN" placeholder=""></textarea>
      </div>

      <div class="lang-group">
        <div class="lang-label"><span class="lang-pill">PT</span> <span data-i18n="lang_pt">Portuguese</span></div>
        <input id="cTPT" placeholder="" style="margin-bottom:10px;">
        <textarea id="cDPT" placeholder=""></textarea>
      </div>

      <div class="lang-group">
        <div class="lang-label"><span class="lang-pill">CN</span> <span data-i18n="lang_cn">Chinese</span></div>
        <input id="cTCN" placeholder="" style="margin-bottom:10px;">
        <textarea id="cDCN" placeholder=""></textarea>
      </div>

      <div class="divider"></div>
      <button class="btn btn-danger btn-full" onclick="deleteCategory()" id="btnDeleteCategory" disabled data-i18n="deleteCategory">Delete Category</button>
    </div>

    <div class="modal-footer">
<button class="btn btn-ghost" onclick="closeCategoryEdit()" data-i18n="cancel">Cancel</button>
      <button class="btn btn-primary" onclick="saveCategory()" data-i18n="save">Save</button>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div class="modal-overlay open" id="loginModal" style="background:var(--primary);" onclick="event.stopPropagation()">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-scroll" style="text-align:center; padding-top:24px;">
      <img src="https://lestoy.com/necos/logo.png" style="height:60px; margin-bottom:20px;">
      <div class="panel-title" style="margin-bottom:10px;" data-i18n="adminAccess">Admin Access</div>

      <div style="text-align:left;">
        <label data-i18n="adminKey">Admin Key</label>
        <input type="password" id="adminKeyInput" placeholder="" />
      </div>
    </div>

    <div class="modal-footer" style="justify-content:center;">
      <button class="btn btn-primary btn-full" style="padding:12px;" onclick="doLogin()" data-i18n="login">Login</button>
    </div>
  </div>
</div>

<div id="toast">Msg</div>

<script>
  // =========================
  // Config / State
  // =========================
  const CFG = {
    api: "neco_adm_api",
    key: "neco_adm_key",
    lastCat: "neco_admin_last_cat_v1"
  };
  const S = (id) => document.getElementById(id);

  let products = [];
  let categories = []; // {id,title,desc,is_active,sort_order,img}
  let selectedProduct = null;
  let editingVariantId = null;

  let editingCategoryId = null;
  let currentLang = 'cn';

window.addEventListener('popstate', (e) => {
  // 1. 如果分类编辑弹窗开着
  if (S('categoryEditModal').classList.contains('open')) {
    __closingFromPopstate = true;
    closeCategoryEdit(); // 使用专用关闭函数
    __closingFromPopstate = false;
    return;
  }
  // 2. 如果分类管理弹窗开着
  if (S('categoryModal').classList.contains('open')) {
    __closingFromPopstate = true;
    closeModal('categoryModal');
    __closingFromPopstate = false;
    return;
  }
  // 3. 如果产品编辑面板开着 (原有逻辑)
  if (window.innerWidth <= 900 && S('editorPanel').classList.contains('open')) {
    __closingFromPopstate = true;
    __editorHistoryPushed = false;
    closeEditorMobile();
    __closingFromPopstate = false;
  }
});

// --- I18n Texts ---
  const TEXTS = {
    en: {
      // header / general
      products: "Products",
      new: "New",
      search: "Search...",
      allCats: "All Categories",
      manageCats: "Categories",
      editProduct: "Edit Product",
      save: "Save",
      cancel: "Cancel",
      close: "Close",
      create: "Create",
      login: "Login",

      // labels
      id: "ID",
      idUnique: "ID (Unique)",
      category: "Category",
      sort: "Sort Order",
      status: "Status",
      active: "Active",
      inactive: "Inactive",
      yes: "Yes",
      no: "No",
      image: "Product Image",
      uploadBtn: "Upload & Replace",
      imgNote: "New image replaces old one automatically.",
      noImage: "No image",

      // categories (dynamic text mostly, but labels for form)
      editCategory: "Edit Category",
      catId: "Category ID",
      catDisableHint: "If disabled, all products in this category will be disabled automatically.",
      catImage: "Category Cover",
      catImageHint: "This image is used on the home category cards.",
      catPreviewHint: "Preview",
      deleteCategory: "Delete Category",
      confirmDeleteCategory: "Delete this category? Products will remain but be hidden if category is missing.",

      // list meta
      metaCategoryPrefix: "Category:",
      metaSortPrefix: "Sort:",

      // editor empty
      selectHint: "Select a product to edit",

      // lang labels
      lang_en: "English",
      lang_pt: "Portuguese",
      lang_cn: "Chinese",

      // placeholders for product fields
      ph_productName_en: "Product Name",
      ph_productName_pt: "Nome do Produto",
      ph_productName_cn: "产品名称",
      ph_desc_en: "Description",
      ph_desc_pt: "Descrição",
      ph_desc_cn: "产品描述",

      // variants
      variants: "VARIANTS",
      add: "Add",
      editVariant: "Edit Variant",
      edit: "Edit",
      delete: "Delete",
      noVariants: "No variants added yet.",
      priceEuro: "Price (€)",
      variantNameEN: "Size (EN)",
      variantNamePT: "Size (PT)",
      variantNameCN: "Size (CN)",
      ph_price: "e.g. 42 (means €42.00)",
      ph_vname_en: "e.g. 6 inch",
      ph_vname_pt: "e.g. 15 cm",
      ph_vname_cn: "e.g. 6寸",

      // new product
      newProduct: "New Product",
      newProductHint: "The product will be created as inactive by default.",
      productName: "Product Name",
      ph_newId: "e.g. classic_cheese_cake",

      // delete product
      deleteProduct: "Delete Product",
      confirmDeleteProduct: "Irreversible! Delete this product and ALL its images?",
      confirmDeleteVariant: "Delete variant?",

      // login modal
      adminAccess: "Admin Access",
      adminKey: "Admin Key",
      apiUrl: "API URL",
      ph_adminKey: "Enter key...",

      // toast / status
      uploading: "Uploading...",
      uploaded: "Image Updated!",
      deleted: "Deleted.",
      saved: "Saved Successfully!",
      created: "Created Successfully!",
      errFillAll: "Please fill all fields",
      errCatIdInvalid: "Invalid Category ID",
      errIdNameRequired: "ID and at least English name are required",
      errPriceGt0: "Price must be > 0",
      selectFileFirst: "Select a file first."
    },

    pt: {
      products: "Produtos",
      new: "Novo",
      search: "Pesquisar...",
      allCats: "Todas Categorias",
      manageCats: "Categorias",
      editProduct: "Editar Produto",
      save: "Salvar",
      cancel: "Cancelar",
      close: "Fechar",
      create: "Criar",
      login: "Entrar",

      id: "ID",
      idUnique: "ID (Único)",
      category: "Categoria",
      sort: "Ordem",
      status: "Estado",
      active: "Ativo",
      inactive: "Inativo",
      yes: "Sim",
      no: "Não",
      image: "Imagem do Produto",
      uploadBtn: "Carregar e Substituir",
      imgNote: "Nova imagem substitui a antiga automaticamente.",
      noImage: "Sem imagem",

      editCategory: "Editar Categoria",
      catId: "ID da Categoria",
      catDisableHint: "Se desativado, todos os produtos serão desativados.",
      catImage: "Capa da Categoria",
      catImageHint: "Usado nos cartões da página inicial.",
      catPreviewHint: "Pré-visualização",
      deleteCategory: "Apagar Categoria",
      confirmDeleteCategory: "Apagar categoria? Os produtos permanecerão.",

      metaCategoryPrefix: "Categoria:",
      metaSortPrefix: "Ordem:",

      selectHint: "Selecione um produto",

      lang_en: "Inglês",
      lang_pt: "Português",
      lang_cn: "Chinês",

      ph_productName_en: "Nome do Produto",
      ph_productName_pt: "Nome do Produto",
      ph_productName_cn: "产品名称",
      ph_desc_en: "Descrição",
      ph_desc_pt: "Descrição",
      ph_desc_cn: "产品描述",

      variants: "VARIANTES",
      add: "Adicionar",
      editVariant: "Editar Variante",
      edit: "Editar",
      delete: "Apagar",
      noVariants: "Ainda não há variantes.",
      priceEuro: "Preço (€)",
      variantNameEN: "Tamanho (EN)",
      variantNamePT: "Tamanho (PT)",
      variantNameCN: "Tamanho (CN)",
      ph_price: "ex.: 42 (significa €42,00)",
      ph_vname_en: "ex.: 6 inch",
      ph_vname_pt: "ex.: 15 cm",
      ph_vname_cn: "ex.: 6寸",

      newProduct: "Novo Produto",
      newProductHint: "O produto será criado como inativo por padrão.",
      productName: "Nome do Produto",
      ph_newId: "ex.: classic_cheese_cake",

      deleteProduct: "Apagar Produto",
      confirmDeleteProduct: "Irreversível! Apagar este produto e TODAS as imagens?",
      confirmDeleteVariant: "Apagar variante?",

      adminAccess: "Acesso Admin",
      adminKey: "Chave Admin",
      apiUrl: "URL da API",
      ph_adminKey: "Insira a chave...",

      uploading: "A carregar...",
      uploaded: "Imagem Atualizada!",
      deleted: "Apagado.",
      saved: "Guardado com sucesso!",
      created: "Criado com sucesso!",
      errFillAll: "Por favor preencha tudo",
      errCatIdInvalid: "ID de Categoria Inválido",
      errIdNameRequired: "ID e pelo menos o nome em inglês são obrigatórios",
      errPriceGt0: "O preço deve ser > 0",
      selectFileFirst: "Selecione um ficheiro primeiro."
    },

    cn: {
      products: "产品列表",
      new: "新建",
      search: "搜索...",
      allCats: "所有分类",
      manageCats: "分类管理",
      editProduct: "编辑产品",
      save: "保存",
      cancel: "取消",
      close: "关闭",
      create: "创建",
      login: "登录",

      id: "ID",
      idUnique: "ID（唯一）",
      category: "分类",
      sort: "排序",
      status: "状态",
      active: "启用",
      inactive: "停用",
      yes: "是",
      no: "否",
      image: "产品图片",
      uploadBtn: "上传并替换",
      imgNote: "上传新图会自动替换旧图。",
      noImage: "暂无图片",

      editCategory: "编辑分类",
      catId: "分类 ID",
      catDisableHint: "若停用，该分类下所有产品也将被隐藏。",
      catImage: "分类封面图",
      catImageHint: "用于首页分类卡片展示。",
      catPreviewHint: "预览",
      deleteCategory: "删除分类",
      confirmDeleteCategory: "确定删除该分类吗？",

      metaCategoryPrefix: "分类：",
      metaSortPrefix: "排序：",

      selectHint: "请在左侧选择一个产品进行编辑",

      lang_en: "英文",
      lang_pt: "葡文",
      lang_cn: "中文",

      ph_productName_en: "产品名称（英文）",
      ph_productName_pt: "产品名称（葡文）",
      ph_productName_cn: "产品名称",
      ph_desc_en: "描述（英文）",
      ph_desc_pt: "描述（葡文）",
      ph_desc_cn: "产品描述",

      variants: "规格列表",
      add: "添加",
      editVariant: "编辑规格",
      edit: "编辑",
      delete: "删除",
      noVariants: "暂无规格。",
      priceEuro: "价格 (€)",
      variantNameEN: "尺寸（EN）",
      variantNamePT: "尺寸（PT）",
      variantNameCN: "尺寸（CN）",
      ph_price: "例如：42（表示 €42.00）",
      ph_vname_en: "例如：6 inch",
      ph_vname_pt: "例如：15 cm",
      ph_vname_cn: "例如：6寸",

      newProduct: "新建产品",
      newProductHint: "新创建的产品默认为停用状态。",
      productName: "产品名称",
      ph_newId: "例如：classic_cheese_cake",

      deleteProduct: "删除产品",
      confirmDeleteProduct: "不可撤销！确定删除该产品及其所有图片吗？",
      confirmDeleteVariant: "确定删除该规格吗？",

      adminAccess: "管理登录",
      adminKey: "管理密码",
      apiUrl: "API 地址",
      ph_adminKey: "请输入密码…",

      uploading: "上传中…",
      uploaded: "图片已更新！",
      deleted: "已删除",
      saved: "保存成功！",
      created: "创建成功！",
      errFillAll: "请填写完整信息",
      errCatIdInvalid: "分类 ID 无效",
      errIdNameRequired: "必须填写 ID，且至少填写英文名称",
      errPriceGt0: "价格必须大于 0",
      selectFileFirst: "请先选择文件。"
    }
  };


  function t(key){ return (TEXTS[currentLang] && TEXTS[currentLang][key]) || (TEXTS.en[key] || key); }

  function setAdminLang(l){
    currentLang = l;
    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
    const map = { en:0, pt:1, cn:2 };
    document.querySelectorAll('.lang-btn')[map[l]].classList.add('active');
    updateAdminUI();
    renderList();
    if (selectedProduct) renderVariants();
    renderCategorySelects();
    if (S('categoryModal').classList.contains('open')) renderCategoryList();
  }

  function updateAdminUI(){
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const k = el.getAttribute('data-i18n');
      el.innerText = t(k);
    });

    S('searchInput').placeholder = t('search');

    S('tEN').placeholder = t('ph_productName_en');
    S('tPT').placeholder = t('ph_productName_pt');
    S('tCN').placeholder = t('ph_productName_cn');
    S('dEN').placeholder = t('ph_desc_en');
    S('dPT').placeholder = t('ph_desc_pt');
    S('dCN').placeholder = t('ph_desc_cn');

    S('vPriceEuro').placeholder = t('ph_price');
    S('vNameEN').placeholder = t('ph_vname_en');
    S('vNamePT').placeholder = t('ph_vname_pt');
    S('vNameCN').placeholder = t('ph_vname_cn');

    S('adminKeyInput').placeholder = t('ph_adminKey');

    // category edit placeholders align with product
    S('cTEN').placeholder = t('ph_productName_en');
    S('cTPT').placeholder = t('ph_productName_pt');
    S('cTCN').placeholder = t('ph_productName_cn');
    S('cDEN').placeholder = t('ph_desc_en');
    S('cDPT').placeholder = t('ph_desc_pt');
    S('cDCN').placeholder = t('ph_desc_cn');
  }

  // =========================
  // Toast
  // =========================
  let __toastTimer = null;
  function showToast(msg){
    const el = S('toast');
    el.innerText = msg;
    el.style.opacity = 1;
    clearTimeout(__toastTimer);
    __toastTimer = setTimeout(() => el.style.opacity = 0, 1700);
  }

  // =========================
  // Modal (class open)
  // =========================
  let __lockedScrollY = 0;
  function lockBodyScroll(){
    if (document.body.classList.contains('modal-open')) return;
    __lockedScrollY = window.scrollY || 0;
    document.body.style.top = `-${__lockedScrollY}px`;
    document.body.classList.add('modal-open');
  }
  function unlockBodyScrollIfNoModal(){
    if (document.querySelector('.modal-overlay.open')) return;
    document.body.classList.remove('modal-open');
    document.body.style.top = '';
    window.scrollTo(0, __lockedScrollY);
  }
  function openModal(id){
    const m = S(id);
    lockBodyScroll();
    m.classList.add('open');
    updateAdminUI();
    refreshCustomSelectLabels();
  }
function closeModal(id){
  const m = S(id);
  if (!m) return;

  // 触发关闭动画
  m.classList.remove('open');

  // 等动画结束再解锁滚动（和 pointer-events）
  setTimeout(() => {
    unlockBodyScrollIfNoModal();
  }, 220); // 要 >= CSS transition 时间
}

 // 修改 Overlay 点击逻辑，确保点击背景关闭时也刷新列表
// 请替换原有的 closeModalByOverlay 函数
function closeModalByOverlay(e){
  if (e.target && e.target.classList && e.target.classList.contains('modal-overlay')){
    const id = e.target.id;
    if (id === 'loginModal') return;
    
    // 如果是关闭分类编辑，走专用通道
    if (id === 'categoryEditModal') {
      closeCategoryEdit();
    } else {
      closeModal(id);
      // 处理普通弹窗的返回键逻辑
      if (window.innerWidth <= 900 && !__closingFromPopstate) {
         // 简单处理：如果是 listPanel 或者是其他压入栈的，最好这里也 back 一下
         // 为了保险起见，这里仅对 categoryModal 做特殊处理
         if (id === 'categoryModal' && location.hash === "#categories") history.back();
      }
    }
  }
}

  // =========================
  // Auth + API
  // =========================
  function getApi(){ return (localStorage.getItem(CFG.api) || "https://necosapi.lestoy.com").replace(/\/+$/, ""); }
  function getKey(){ return sessionStorage.getItem(CFG.key) || ""; }

  function apiCall(endpoint, method='GET', body=null){
    const headers = { 'Authorization': `Bearer ${getKey()}` };
    if (!(body instanceof FormData)) headers['Content-Type'] = 'application/json';

    return fetch(`${getApi()}/cake-shop/v1/admin${endpoint}`, {
      method,
      headers,
      body: (body instanceof FormData) ? body : (body ? JSON.stringify(body) : null)
    }).then(async r => {
      let data = null;
      try { data = await r.json(); } catch { data = null; }
      if (!r.ok || !data || data.ok !== true) throw new Error((data && data.error) || r.statusText);
      return data;
    }).catch(e => {
      showToast("Error: " + e.message);
      if (String(e.message).includes('403')) S('loginModal').classList.add('open');
      throw e;
    });
  }

  function doLogin(){
    const k = S('adminKeyInput').value.trim();
    if (!k) return alert(t('errFillAll'));
    sessionStorage.setItem(CFG.key, k);
    localStorage.setItem(CFG.api, "https://necosapi.lestoy.com");
    S('loginModal').classList.remove('open');
    unlockBodyScrollIfNoModal();
    loadAll();
  }

  // =========================
  // Remember last category
  // =========================
  function getRememberedCategory(){
    try{ return localStorage.getItem(CFG.lastCat) || ""; }catch(e){ return ""; }
  }
  function onRememberCategory(catId){
    try{ if (catId) localStorage.setItem(CFG.lastCat, catId); }catch(e){}
  }

  // =========================
  // Categories helpers
  // =========================
function getCategoryById(id){
  const key = String(id);
  return categories.find(c => String(c.id) === key) || null;
}

function getLocalizedCategoryName(id){
    const c = getCategoryById(id);
    // 如果找不到分类对象（可能是刚创建还没刷新或者是空ID），直接返回ID或空
    if (!c) return String(id || "");
    
    const title = c.title || {};
    // 优先取当前语言，没有则降级到英文
    const name = title[currentLang] || title.en || title.cn || title.pt;
    
    // 如果所有语言都没有名字，则显示“未命名分类 #ID”
    if (!name) {
      const placeholder = {
        en: "Untitled",
        pt: "Sem título",
        cn: "未命名"
      };
      // 如果是在下拉框里（通常我们希望下拉框里只显示名字，不带#ID，除非是为了调试），
      // 但为了统一，这里也带上ID，或者你可以去掉 `#${c.id}`
      return `${placeholder[currentLang] || "Untitled"} #${c.id}`;
    }
    
    return name;
  }

  // Fill selects with categories, then refresh cselect UI
function renderCategorySelects(){
  // ✅ 优化：先按 sort_order 小到大（前台顺序），权重一样时按 ID 大到小（新创建的排前面，方便找）
const sorted = categories.slice().sort((a,b) => {
  const diff = (a.sort_order || 0) - (b.sort_order || 0);
  if (diff !== 0) return diff;
  return Number(b.id) - Number(a.id); 
});

  // filter
  const f = S('catFilter');
  const prevF = f.value;
  f.innerHTML = `<option value="">${t('allCats')}</option>`;
  sorted.forEach(c => {
    const opt = document.createElement('option');
    opt.value = String(c.id);
    opt.textContent = getLocalizedCategoryName(c.id) + (c.is_active ? "" : ` (${t('inactive')})`);
    f.appendChild(opt);
  });
  f.value = prevF;

  // product category
  const pc = S('pCategory');
  const prevPC = pc.value;
  pc.innerHTML = "";
  sorted.forEach(c => {
    const opt = document.createElement('option');
    opt.value = String(c.id);
    opt.textContent = getLocalizedCategoryName(c.id);
    pc.appendChild(opt);
  });
  if (prevPC) pc.value = prevPC;

  // new product default category
  const nc = S('newCategory');
  const remembered = getRememberedCategory();
  const prevNC = nc.value;
  nc.innerHTML = "";
  sorted.forEach(c => {
    const opt = document.createElement('option');
    opt.value = String(c.id);
    opt.textContent = getLocalizedCategoryName(c.id);
    nc.appendChild(opt);
  });
  nc.value = remembered || prevNC || (sorted[0] ? String(sorted[0].id) : "");

  refreshCustomSelectLabels();
}


  // =========================
  // Load all
  // =========================
  async function loadAll(){
    try{
      const [cRes, pRes] = await Promise.all([
        apiCall('/categories'),
        apiCall('/products')
      ]);
      categories = cRes.categories || [];
      products = pRes.products || [];
      renderCategorySelects();
      renderList();
      // keep selection
      if (selectedProduct){
        const fresh = products.find(x => String(x.id) === String(selectedProduct.id));
        if (fresh){
          selectedProduct = fresh;
          renderVariants();
          refreshImagePreviewFromSelected();
        }
      }
    }catch(e){}
  }

  // =========================
  // Products
  // =========================
 function getLocalizedTitle(p){
    if (!p) return "";
    const tt = p.title || {};
    // 优先取当前语言，没有则降级到英文，再没有则降级到其他语言
    const name = tt[currentLang] || tt.en || tt.cn || tt.pt;
    
    // 如果所有语言都没有名字，则显示“未命名 #ID”
    if (!name) {
      const placeholder = {
        en: "Untitled",
        pt: "Sem título",
        cn: "未命名"
      };
      return `${placeholder[currentLang] || "Untitled"} #${p.id}`;
    }
    
    return name;
  }

  function renderList(){
    const q = S('searchInput').value.toLowerCase();
    const cat = S('catFilter').value;
    const listEl = S('productList');
    listEl.innerHTML = '';

    const filtered = products.filter(p => {
      if (cat && p.category !== cat) return false;
      const titleStr = JSON.stringify(p.title || {}).toLowerCase();
      return String(p.id).toLowerCase().includes(q) || titleStr.includes(q);
    }).sort((a, b) => Number(b.id) - Number(a.id));

    filtered.forEach(p => {
      const div = document.createElement('div');
      div.className = `list-item ${selectedProduct?.id === p.id ? 'active' : ''}`;
      div.onclick = () => selectProduct(p);

      let imgUrl = "";
      const primaryImg = (p.images || []).find(i => i.is_primary) || (p.images || [])[0];
      if (primaryImg) imgUrl = primaryImg.public_url || primaryImg.url || "";

      const title = getLocalizedTitle(p);
      const statusClass = p.is_active ? 'active' : '';
      const catLabel = `${t('metaCategoryPrefix')} ${getLocalizedCategoryName(p.category)}`;
      const sortLabel = `${t('metaSortPrefix')} ${p.sort_order ?? 0}`;

      div.innerHTML = `
        <img src="${imgUrl || 'https://lestoy.com/necos/noimg.png'}" class="item-thumb"
          onerror="this.onerror=null; this.src='https://lestoy.com/necos/noimg.png';" />
        <div class="item-info">
          <div class="item-title">${escapeHtml(title)}</div>
          <div class="item-meta">
            <div class="status-dot ${statusClass}"></div>
            <span>${escapeHtml(catLabel)}</span>
            <span>•</span>
            <span>${escapeHtml(sortLabel)}</span>
          </div>
        </div>
      `;
      listEl.appendChild(div);
    });

    if (filtered.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'empty-state';
      empty.innerText = '—';
      listEl.appendChild(empty);
    }
  }

  function selectProduct(p){
    selectedProduct = p;
    renderList();

   if (window.innerWidth <= 900) {
  const panel = S('editorPanel');

  if (!panel.classList.contains('open')) {
    panel.classList.add('open');
    // 第一次打开：压一条历史记录，返回键会触发 popstate
    history.pushState({ necoEditor: true, pid: String(p.id) }, "", "#editor");
    __editorHistoryPushed = true;
  } else {
    // 已经在编辑页内切换产品：不要再压历史，改为替换即可
    history.replaceState({ necoEditor: true, pid: String(p.id) }, "", "#editor");
  }
}


    S('editorEmpty').style.display = 'none';
    S('editorForm').style.display = 'block';
    S('btnSave').disabled = false;
    S('btnDeleteBottom').disabled = false;

    S('pId').value = p.id;
    S('pCategory').value = p.category;
    onRememberCategory(p.category);
    S('pSort').value = p.sort_order ?? 0;
    S('pActive').value = (p.is_active == 1) ? "1" : "0";

    const title = p.title || {};
    const desc = p.description || {};
    S('tEN').value = title.en || "";
    S('tPT').value = title.pt || "";
    S('tCN').value = title.cn || "";
    S('dEN').value = desc.en || "";
    S('dPT').value = desc.pt || "";
    S('dCN').value = desc.cn || "";

    refreshCustomSelectLabels();
    refreshImagePreviewFromSelected();
    renderVariants();
  }

  function closeEditorMobile(){
    S('editorPanel').classList.remove('open');
    selectedProduct = null;
    renderList();
    S('btnSave').disabled = true;
    S('btnDeleteBottom').disabled = true;
    S('editorEmpty').style.display = 'block';
    S('editorForm').style.display = 'none';

    if (window.innerWidth <= 900 && __editorHistoryPushed && !__closingFromPopstate) {
    __editorHistoryPushed = false;
    history.back();
  }

  // 顺手清一下 hash（可选）
  if (!__closingFromPopstate && location.hash === "#editor") {
    // history.back() 会自然回去；这里不用强行改
  }
  }

  async function openNewProductModal(){
    renderCategorySelects();
    const remembered = getRememberedCategory();
    const fallback = remembered || S('catFilter').value || categories[0]?.id || "";
    S('newCategory').value = fallback;
    refreshCustomSelectLabels();
    openModal('newProductModal');
  }

  async function createNewProduct(){
    const cat = S('newCategory').value;
    onRememberCategory(cat);

    const btn = S('newProductModal').querySelector('.btn-primary');
    if (btn) btn.disabled = true;
    try{
      const res = await apiCall('/products', 'POST', { category: cat });
      closeModal('newProductModal');
      showToast(t('created'));
      await loadAll();
      const newP = products.find(x => String(x.id) === String(res.id));
      if (newP) selectProduct(newP);
    }catch(e){
    }finally{
      if (btn) btn.disabled = false;
    }
  }

  async function saveProduct(){
    if (!selectedProduct) return;

    const payload = {
      category: S('pCategory').value,
      is_active: S('pActive').value === "1",
      sort_order: Number(S('pSort').value || 0),
      title: { en: S('tEN').value.trim(), pt: S('tPT').value.trim(), cn: S('tCN').value.trim() },
      description: { en: S('dEN').value.trim(), pt: S('dPT').value.trim(), cn: S('dCN').value.trim() }
    };
    onRememberCategory(payload.category);
    try{
      await apiCall(`/products/${selectedProduct.id}`, 'PUT', payload);
      showToast(t('saved'));
      await loadAll();
    }catch(e){}
  }

  async function deleteProduct(){
    if (!selectedProduct) return;
    if (!confirm(t('confirmDeleteProduct'))) return;

    try{
      await apiCall(`/products/${selectedProduct.id}`, 'DELETE');
      showToast(t('deleted'));
      selectedProduct = null;
      closeEditorMobile();
      await loadAll();
    }catch(e){}
  }

  // =========================
  // Product Image
  // =========================
  function refreshImagePreviewFromSelected(){
    if (!selectedProduct) return;
    const img = (selectedProduct.images || []).find(i => i.is_primary) || (selectedProduct.images || [])[0];
    const preview = S('pImgPreview');
    const emptyTxt = S('pImgEmpty');

    if (img && (img.public_url || img.url)) {
      preview.src = img.public_url || img.url;
      preview.style.display = 'block';
      emptyTxt.style.display = 'none';
    } else {
      preview.style.display = 'none';
      emptyTxt.style.display = 'flex';
    }
  }

  async function uploadImage(){
    if (!selectedProduct) return;
    const file = S('imgUploadInput').files[0];
    if (!file) return showToast(t('selectFileFirst'));

    const fd = new FormData();
    fd.append('file', file);

    S('imgLoader').classList.add('active');
    try{
      showToast(t('uploading'));
      await apiCall(`/products/${selectedProduct.id}/image`, 'POST', fd);
      showToast(t('uploaded'));
      S('imgUploadInput').value = "";
      await loadAll();
      const fresh = products.find(x => String(x.id) === String(selectedProduct.id));
      if (fresh){ selectedProduct = fresh; refreshImagePreviewFromSelected(); renderList(); }
    }catch(e){
    }finally{
      S('imgLoader').classList.remove('active');
    }
  }

  // =========================
  // Variants
  // =========================
  function renderVariants(){
    const list = S('variantList'); list.innerHTML = '';
    if(!selectedProduct) return;

    const vars = (selectedProduct.variants || []).slice().sort((a,b) => (a.sort_order||0) - (b.sort_order||0));
    if(vars.length===0){
      list.innerHTML = `<div class="empty-state">${escapeHtml(t('noVariants'))}</div>`;
      return;
    }

    vars.forEach(v => {
      const n = v.name || {};
      const name = n[currentLang] || n.en || n.cn || n.pt || "Variant";
      const div = document.createElement('div'); div.className='v-card';
      div.innerHTML = `
        <div class="v-info">
          <div>${escapeHtml(name)}</div>
          <div class="v-price">€ ${((v.price_cents||0)/100).toFixed(2)}</div>
        </div>
        <div style="display:flex;gap:8px;flex-shrink:0;">
          <button class="btn btn-ghost btn-small" onclick="openVariantModal('${v.id}')">${t('edit')}</button>
          <button class="btn btn-danger btn-small" onclick="deleteVariant('${v.id}')">${t('delete')}</button>
        </div>`;
      list.appendChild(div);
    });
  }

  function openVariantModal(vid = null){
    editingVariantId = vid;

    S('vPriceEuro').value = "";
    S('vNameEN').value = ""; S('vNamePT').value = ""; S('vNameCN').value = "";
    S('vSort').value = 0; S('vActive').value = "1";

    if(vid && selectedProduct){
      const v = (selectedProduct.variants || []).find(x => String(x.id) === String(vid));
      if (v){
        S('vPriceEuro').value = (v.price_cents || 0) / 100;
        const n = v.name || {};
        S('vNameEN').value = n.en || "";
        S('vNamePT').value = n.pt || "";
        S('vNameCN').value = n.cn || "";
        S('vSort').value = v.sort_order || 0;
        S('vActive').value = v.is_active ? "1" : "0";
      }
    }

    refreshCustomSelectLabels();
    openModal('variantModal');
  }

  async function saveVariant(){
    if(!selectedProduct) return;

    const priceVal = parseFloat(S('vPriceEuro').value);
    if (isNaN(priceVal) || priceVal <= 0) return alert(t('errPriceGt0'));
    const priceCents = Math.round(priceVal * 100);

    const payload = {
      product_id: selectedProduct.id,
      price_cents: priceCents,
      name: {
        en: S('vNameEN').value.trim(),
        pt: S('vNamePT').value.trim(),
        cn: S('vNameCN').value.trim()
      },
      sort_order: Number(S('vSort').value || 0),
      is_active: S('vActive').value === "1"
    };

    const btn = S('variantModal').querySelector('.btn-primary');
    if(btn) btn.disabled = true;
    try{
      const url = editingVariantId ? `/variants/${editingVariantId}` : '/variants';
      const method = editingVariantId ? 'PUT' : 'POST';
      await apiCall(url, method, payload);
      closeModal('variantModal');
      showToast(t('saved'));
      await loadAll();
      const fresh = products.find(x => String(x.id) === String(selectedProduct.id));
      if (fresh){ selectedProduct = fresh; renderVariants(); renderList(); }
    }catch(e){
    }finally{
      if(btn) btn.disabled = false;
    }
  }

  async function deleteVariant(vid){
    if (!confirm(t('confirmDeleteVariant'))) return;
    try{
      await apiCall(`/variants/${vid}`, 'DELETE');
      showToast(t('deleted'));
      await loadAll();
      const fresh = products.find(x => String(x.id) === String(selectedProduct.id));
      if (fresh){ selectedProduct = fresh; renderVariants(); renderList(); }
    }catch(e){}
  }

  // =========================
  // Categories Manager
  // =========================
function openCategoryManager(){
  renderCategoryList();
  
  // 手机端压入历史记录
  if (window.innerWidth <= 900) {
    history.pushState({ modal: 'categoryModal' }, "", "#categories");
  }
  
  openModal('categoryModal');
}

function renderCategoryList(){
  const list = S('categoryList');
  list.innerHTML = '';
  // ✅ 优化：先按 sort_order 小到大（前台顺序），权重一样时按 ID 大到小（新创建的排前面，方便找）
const sorted = categories.slice().sort((a,b) => {
  const diff = (a.sort_order || 0) - (b.sort_order || 0);
  if (diff !== 0) return diff;
  return Number(b.id) - Number(a.id); 
});
  if (sorted.length === 0){
    list.innerHTML = `<div class="empty-state">—</div>`;
    return;
  }

  sorted.forEach(c => {
    const div = document.createElement('div');
    div.className = 'list-item';
    const dot = c.is_active ? 'active' : '';
    div.innerHTML = `
      <img src="${(c.img || 'https://lestoy.com/necos/noimg.png')}" class="item-thumb"
        onerror="this.onerror=null; this.src='https://lestoy.com/necos/noimg.png';" />
      <div class="item-info">
        <div class="item-title">${escapeHtml(getLocalizedCategoryName(c.id))}</div>
        <div class="item-meta">
          <div class="status-dot ${dot}"></div>
          <span>#${escapeHtml(String(c.id))}</span>
          <span>•</span>
          <span>${escapeHtml(t('metaSortPrefix'))} ${c.sort_order ?? 0}</span>
        </div>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-ghost btn-small" onclick="openCategoryEdit('${escapeAttr(String(c.id))}')">${t('edit')}</button>
      </div>
    `;
    list.appendChild(div);
  });
}

 async function openCategoryEdit(catId){
  // 1. 新建分类逻辑
  if (!catId){
    // 后台静默创建
    const payload = {
      is_active: false,
      sort_order: 0,
      title: { en:"", pt:"", cn:"" },
      description: { en:"", pt:"", cn:"" }
    };
    
    // 显示简单的加载提示（可选）
    // showToast("Creating..."); 
    
    try {
      const res = await apiCall('/categories', 'POST', payload);
      const newId = String(res.id);
      
      // ✅ 关键优化：不调用 loadAll()，而是手动在本地加一条数据，避免闪烁
      // 这样列表不会刷新，用户感觉不到后台发生了什么，直接进入编辑
      const newCatStub = { 
        id: newId, 
        is_active: false, 
        sort_order: 0,
        title: { en:"", pt:"", cn:"" },
        description: { en:"", pt:"", cn:"" },
        img: ""
      };
      categories.push(newCatStub); // 暂时加到本地数组
      
      // 立即打开编辑
      return openCategoryEdit(newId);
      
    } catch(e) {
      alert(e.message);
      return;
    }
  }

  // 2. 编辑逻辑
  editingCategoryId = String(catId);
  const c = getCategoryById(editingCategoryId);
  
  // 手机端压入历史记录
  if (window.innerWidth <= 900) {
    history.pushState({ modal: 'categoryEdit' }, "", "#category_edit");
  }

  S('btnDeleteCategory').disabled = false;
  S('cId').disabled = true;
  S('cId').value = String(editingCategoryId);

  S('cSort').value = c ? (c.sort_order ?? 0) : 0;
  S('cActive').value = c ? (c.is_active ? "1" : "0") : "0";

  const tt = (c && c.title) ? c.title : {};
  const dd = (c && c.desc) ? c.desc : {};
  S('cTEN').value = tt.en || ""; S('cTPT').value = tt.pt || ""; S('cTCN').value = tt.cn || "";
  S('cDEN').value = dd.en || ""; S('cDPT').value = dd.pt || ""; S('cDCN').value = dd.cn || "";

  if (c && c.img){
    S('cImgPreview').src = c.img; S('cImgPreview').style.display = 'block'; S('cImgEmpty').style.display = 'none';
  } else {
    S('cImgPreview').style.display = 'none'; S('cImgEmpty').style.display = 'flex';
  }
  S('cImgFile').value = "";

  refreshCustomSelectLabels();
  openModal('categoryEditModal');
}


// ✅ 新增：专门用于关闭分类编辑的函数
// 无论保存、取消还是返回，都走这里，确保列表刷新
async function closeCategoryEdit() {
  closeModal('categoryEditModal');
  editingCategoryId = null;

  // 处理手机返回键历史
  if (window.innerWidth <= 900 && !__closingFromPopstate && location.hash === "#category_edit") {
    history.back();
  }

  // ✅ 核心：关闭窗口后，静默刷新一下列表
  // 这样之前新建的那个空分类，就会正式显示在管理列表中了
  await loadAll(); 
  
  // 如果分类管理弹窗还开着，就刷新它的列表 DOM
  if (S('categoryModal').classList.contains('open')) {
    renderCategoryList();
  }
}

// 保存分类
async function saveCategory(){
  const payload = {
    is_active: S('cActive').value === "1",
    sort_order: Number(S('cSort').value || 0),
    title: { en: S('cTEN').value.trim(), pt: S('cTPT').value.trim(), cn: S('cTCN').value.trim() },
    description: { en: S('cDEN').value.trim(), pt: S('cDPT').value.trim(), cn: S('cDCN').value.trim() }
  };

  try{
    if (editingCategoryId) {
      await apiCall(`/categories/${encodeURIComponent(editingCategoryId)}`, 'PUT', payload);
    }
    showToast(t('saved'));
    
    // 保存成功后，调用统一关闭函数（它会自动刷新列表）
    closeCategoryEdit(); 
    
  }catch(e){
    alert(e.message);
  }
}
async function uploadCategoryImage(){
  // ✅ 必须先保存分类拿到 id 才能上传
  const catId = editingCategoryId;
if (!catId) return showToast(t('errFillAll')); // 或者专门加一个 i18n key


  const file = S('cImgFile').files[0];
  if (!file) return showToast(t('selectFileFirst'));

  const fd = new FormData();
  fd.append('file', file);

  S('catImgLoader').classList.add('active');
  try{
    showToast(t('uploading'));
    await apiCall(`/categories/${encodeURIComponent(catId)}/image`, 'POST', fd);
    showToast(t('uploaded'));
    S('cImgFile').value = "";
    await loadAll();

    const fresh = getCategoryById(catId);
    if (fresh && fresh.img){
      S('cImgPreview').src = fresh.img;
      S('cImgPreview').style.display = 'block';
      S('cImgEmpty').style.display = 'none';
    }

    renderCategorySelects();
    renderCategoryList();
    renderList();
  }catch(e){
  }finally{
    S('catImgLoader').classList.remove('active');
  }
}

// 删除分类
async function deleteCategory(){
  if (!editingCategoryId) return;
  if (!confirm(t('confirmDeleteCategory'))) return;

  try{
    await apiCall(`/categories/${encodeURIComponent(editingCategoryId)}`, 'DELETE');
    showToast(t('deleted'));
    
    // 删除后也调用统一关闭，刷新列表
    closeCategoryEdit();
    
  }catch(e){}
}



  // =========================
  // Utils
  // =========================
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
  function escapeAttr(str){
    return String(str ?? "").replaceAll("'", "\\'").replaceAll('"','\\"');
  }

  // =========================
  // Custom Select Enhancer
  // =========================
  let __cselectOpenState = null;

  function initCustomSelects() {
    document.querySelectorAll('.select-wrap select.select-native').forEach(sel => {
      if (sel.dataset.cselectEnhanced === "1") return;
      enhanceSelect(sel);
    });

    document.addEventListener('mousedown', (e) => {
      if (!__cselectOpenState) return;
      if (!__cselectOpenState.btn.contains(e.target) && !__cselectOpenState.pop.contains(e.target)) {
        closeCSelect(__cselectOpenState);
      }
    });

    window.addEventListener('resize', updatePopoverPosition, { passive: true });
    window.addEventListener('scroll', updatePopoverPosition, { passive: true, capture: true });
  }

  function updatePopoverPosition() {
    if (!__cselectOpenState) return;
    const { btn, pop } = __cselectOpenState;
    const rect = btn.getBoundingClientRect();
    const spaceBelow = window.innerHeight - rect.bottom;
    const spaceAbove = rect.top;

    let top = rect.bottom + 6;
    let transformOrigin = 'top center';
    if (spaceBelow < 280 && spaceAbove > spaceBelow) {
      top = rect.top - pop.offsetHeight - 6;
      transformOrigin = 'bottom center';
    }

    pop.style.top = `${top}px`;
    pop.style.left = `${rect.left}px`;
    pop.style.width = `${rect.width}px`;
    pop.style.transformOrigin = transformOrigin;
  }

  function refreshCustomSelectLabels() {
    document.querySelectorAll('.select-wrap select.select-native[data-cselect-id]').forEach(sel => {
      const id = sel.dataset.cselectId;
      const state = window.__cselectStates?.get(id);
      if (!state) return;
      buildCSelectOptions(state, { keepFilter: true });
      syncCSelectFromNative(state);
    });
  }

  function enhanceSelect(selectEl) {
    selectEl.dataset.cselectEnhanced = "1";
    selectEl.classList.add('cselect-native');

    const uid = selectEl.id || ('cselect_' + Math.random().toString(16).slice(2));
    selectEl.dataset.cselectId = uid;

    const wrap = selectEl.closest('.select-wrap');
    const root = document.createElement('div');
    root.className = 'cselect';

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'cselect-btn';

    const label = document.createElement('div');
    label.className = 'cselect-label';

    const arrow = document.createElement('div');
    arrow.className = 'cselect-arrow';

    btn.appendChild(label);
    btn.appendChild(arrow);
    root.appendChild(btn);
    wrap.appendChild(root);

    const pop = document.createElement('div');
    pop.className = 'cselect-pop';
    pop.id = `pop_${uid}`;

    const searchWrap = document.createElement('div');
    searchWrap.className = 'cselect-search';
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.autocomplete = 'off';
    searchInput.spellcheck = false;
    searchInput.placeholder = (currentLang === 'cn') ? '搜索...' : 'Search...';
    searchWrap.appendChild(searchInput);
    pop.appendChild(searchWrap);

    const list = document.createElement('div');
    list.className = 'cselect-list';
    pop.appendChild(list);

    document.body.appendChild(pop);

    if (!window.__cselectStates) window.__cselectStates = new Map();
    const state = { id: uid, selectEl, btn, label, pop, list, searchInput, optionNodes: [], activeIndex: -1 };
    window.__cselectStates.set(uid, state);

    buildCSelectOptions(state);
    syncCSelectFromNative(state);

    selectEl.addEventListener('change', () => syncCSelectFromNative(state));

    btn.addEventListener('click', () => {
      if (state.pop.classList.contains('open')) closeCSelect(state);
      else openCSelect(state);
    });

    searchInput.addEventListener('input', () => buildCSelectOptions(state, { keepFilter: true }));

    pop.addEventListener('keydown', (e) => {
      if (!state.pop.classList.contains('open')) return;
      if (e.key === 'ArrowDown') { e.preventDefault(); moveActive(state, +1); }
      else if (e.key === 'ArrowUp') { e.preventDefault(); moveActive(state, -1); }
      else if (e.key === 'Enter') { e.preventDefault(); selectActive(state); }
      else if (e.key === 'Escape') { e.preventDefault(); closeCSelect(state); }
    });
  }

  function buildCSelectOptions(state, opts = {}) {
    const { selectEl, list, searchInput } = state;
    const q = (searchInput.value || '').trim().toLowerCase();

    list.innerHTML = '';
    state.optionNodes = [];

    const options = Array.from(selectEl.options);
    const visible = options.filter(o => {
      const text = (o.textContent || '').toLowerCase();
      return !q || text.includes(q);
    });

    if (visible.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'cselect-empty';
      empty.innerText = (currentLang === 'cn') ? '没有结果' : 'No results';
      list.appendChild(empty);
      return;
    }

    visible.forEach((opt, idx) => {
      const row = document.createElement('div');
      row.className = 'cselect-opt';
      row.setAttribute('data-value', opt.value);
      row.innerHTML = `<span>${escapeHtml(opt.textContent || "")}</span><div class="tick"></div>`;

      row.onclick = () => {
        setNativeValue(state, opt.value);
        closeCSelect(state);
      };

      row.onmouseenter = () => {
        state.activeIndex = idx;
        updateHighlight(state);
      };

      list.appendChild(row);
      state.optionNodes.push({ el: row, val: opt.value });
    });

    syncCSelectFromNative(state);
  }

  function syncCSelectFromNative(state) {
    const { selectEl, label, optionNodes } = state;
    const val = selectEl.value;
    const opt = selectEl.selectedOptions[0];
    label.innerText = opt ? (opt.textContent || '') : '';
    optionNodes.forEach(node => {
      if (node.val === val) node.el.setAttribute('aria-selected', 'true');
      else node.el.removeAttribute('aria-selected');
    });
    state.searchInput.placeholder = (currentLang === 'cn') ? '搜索...' : 'Search...';
  }

  function setNativeValue(state, val) {
    if (state.selectEl.value === val) return;
    state.selectEl.value = val;
    state.selectEl.dispatchEvent(new Event('change'));
    syncCSelectFromNative(state);
  }

  // --- 1. 打开菜单：禁止自动聚焦，防止键盘乱弹 ---
  function openCSelect(state) {
    if (__cselectOpenState && __cselectOpenState !== state) closeCSelect(__cselectOpenState);
    __cselectOpenState = state;

    state.btn.classList.add('cselect-open');
    state.pop.style.display = 'flex';
    updatePopoverPosition();

    requestAnimationFrame(() => {
      state.pop.classList.add('open');
      // state.searchInput.focus(); // ❌ 已注释：彻底禁止自动弹出键盘
    });
  }

  // --- 2. 关闭菜单：强制失焦，防止布局回弹 ---
  function closeCSelect(state) {
    // ✅ 关键：如果搜索框正处于输入状态，强制让它失焦，
    // 这样键盘会立即平滑收起，而不是等菜单消失后突然跳动
    if (state.searchInput) state.searchInput.blur();

    state.pop.classList.remove('open');
    state.btn.classList.remove('cselect-open');
    
    setTimeout(() => {
      if (!state.pop.classList.contains('open')) state.pop.style.display = 'none';
    }, 150);
    
    if (__cselectOpenState === state) __cselectOpenState = null;
  }



  function updateHighlight(state) {
    state.optionNodes.forEach((n, i) => {
      if (i === state.activeIndex) n.el.classList.add('highlighted');
      else n.el.classList.remove('highlighted');
    });
  }

  function moveActive(state, delta) {
    if (!state.optionNodes.length) return;
    let i = state.activeIndex;
    i = (i < 0) ? 0 : i + delta;
    if (i < 0) i = 0;
    if (i >= state.optionNodes.length) i = state.optionNodes.length - 1;
    state.activeIndex = i;
    updateHighlight(state);
    state.optionNodes[i].el.scrollIntoView({ block: 'nearest' });
  }

  // --- 3. 选中选项：禁止按钮聚焦，防止页面滚动 ---
  function selectActive(state) {
    const i = state.activeIndex;
    if (i < 0 || i >= state.optionNodes.length) return;
    const v = state.optionNodes[i].val;
    
    setNativeValue(state, v);
    closeCSelect(state);
    
    // state.btn.focus(); // ❌ 已注释：选中后不要聚焦按钮，避免手机页面为了对齐焦点而发生跳动
  }

  // =========================
  // Boot
  // =========================
  function init(){
    initCustomSelects();
    setAdminLang('cn');
    updateAdminUI();

    const key = getKey();
    if (!key){
      openModal('loginModal');
    } else {
      S('loginModal').classList.remove('open');
      unlockBodyScrollIfNoModal();
      loadAll();
    }
  }
 setAdminLang('cn');
  init();
</script>
</body>
</html>
