<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Neco's Custom Cake</title>
<link rel="icon" type="image/png" href="https://lestoy.com/necos/f.png" />
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="products.js"></script> 
<style>
        /* --- 1. ËÆæËÆ°Á≥ªÁªü --- */
        :root {
            --primary: #102940; /* Ê∑±Ëìù */
            --accent: #F4C04B; /* ËõãÈªÑ */
            --bg: #F5F5F7; /* Á±≥ÁôΩ */
            --white: #FFFFFF;
            --text-gray: #666666;
            --border: #F0F0F0;
            --radius-box: 20px;
            --radius-btn: 50px;
            --shadow: 0 8px 24px rgba(16, 41, 64, 0.08);
            --header-h: 70px;
        }
        /* ÂºπÁ™óÊâìÂºÄÊó∂ÔºöÈîÅ‰ΩèËÉåÊôØÊªöÂä®ÔºàÂê´ iOSÔºâ */
        body.modal-open{
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, button, input, select, textarea {
            font-family: 'Nunito', sans-serif;
        }
        html {
          overflow-y: scroll;
        }
        body {
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding-top: var(--header-h);
            padding-bottom: 82px;
            overflow-x: hidden;
        }
        /* --- 2. Header --- */
        .smart-header {
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-h);
            background: var(--white); z-index: 900;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo-img { height: 54px; width: auto; }
        .lang-switch { display: flex; background: #F3F4F6; border-radius: 20px; padding: 3px; }
        .lang-btn {
            border: none; background: transparent; padding: 6px 10px;
            border-radius: 16px; font-size: 12px; font-weight: 800; color: #999;
            cursor: pointer; transition: all 0.2s;
        }
        .lang-btn.active { background: var(--accent); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        /* --- 3. Â∏ÉÂ±Ä --- */
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .view-section { display: none; }
        .view-section.active { display: block; }
        
        /* [NEW] Â∏∏È©ªÊêúÁ¥¢Ê°Ü (Google Style) */
        .search-hero { margin-bottom: 30px; }
        .search-hero-inner {
            display: flex; align-items: center; gap: 12px;
            background: var(--white); border-radius: 18px;
            padding: 18px 18px;
            box-shadow: 0 8px 24px rgba(16, 41, 64, 0.08);
            transition: box-shadow 0.2s;
        }
        .search-hero-inner:focus-within { box-shadow: 0 8px 30px rgba(16, 41, 64, 0.15); }
      .search-icon {
        width: 20px;
        height: 20px;
        background-color: #999;
        -webkit-mask: url("https://lestoy.com/love/icones/search.svg") no-repeat center;
        -webkit-mask-size: contain;
        mask: url("https://lestoy.com/love/icones/search.svg") no-repeat center;
        mask-size: contain;
        display: inline-block;
      }
      .search-hero-inner:has(#search-input:not(:placeholder-shown)) .search-icon{
        background-color: var(--primary);
        color: var(--primary);
      }
      #search-input:placeholder-shown ~ .search-clear{
        opacity:0;
        pointer-events:none;
      }
        .search-input {
            flex: 1; border: none; outline: none; background: transparent;
            font-size: 16px; font-family: 'Nunito', sans-serif; font-weight: 600;
            color: var(--primary);
        }
        .search-input::placeholder { color: #999; }
        .search-clear { cursor: pointer; color:var(--primary); font-size: 18px; display: none; }
        input[type="search"]::-webkit-search-cancel-button {
          -webkit-appearance: none;
          appearance: none;
          display: none;
        }
        input[type="search"]::-webkit-search-decoration {
          -webkit-appearance: none;
        }
        /* --- 4. È¶ñÈ°µÂàÜÁ±ª --- */
        .category-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px;
        }
        .cat-card {
            background: var(--white); border-radius: var(--radius-box);
            overflow: hidden; box-shadow: var(--shadow);
            cursor: pointer; transition: transform 0.2s;
            display: flex; flex-direction: column;
        }
        .cat-card:active { transform: scale(0.98); }
        .cat-img-box { width: 100%; height: 200px; overflow: hidden; }
        .cat-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .cat-card:hover .cat-img { transform: scale(1.05); }
        .cat-info { padding: 20px; border-top: 1px solid var(--border); }
        .cat-title { font-size: 20px; font-weight: 900; margin: 0 0 6px 0; color: var(--primary); }
        .cat-desc { font-size: 14px; color: var(--text-gray); line-height: 1.4; }
        /* --- 5. ÂàóË°®È°µ --- */
        .back-nav {
          display: flex;
          align-items: center;
          gap: 12px;
          margin-bottom: 20px;
        }
        .nav-title {
          font-size: 15px;
          font-weight: 600;
          color: #6e6e73;
          white-space: nowrap;
        }
        .btn-back {
            background: var(--white); border: 1px solid #E5E7EB;
            padding: 12px 24px 12px 18.5px; border-radius: var(--radius-btn);
            display: inline-flex; align-items: center; gap: 8px;
            font-weight: 800; font-size: 16px; color: var(--primary); cursor: pointer;
        }
        .back-nav {
          --nav-icon: url("https://i.ibb.co/Q3hkmW9x/IMG-20251219-145724.png");
          --nav-icon-size: 22px;
        }
        .back-icon {
          width: var(--nav-icon-size);
          height: var(--nav-icon-size);
          background-color: currentColor;
          -webkit-mask: var(--nav-icon) no-repeat center;
          -webkit-mask-size: contain;
          mask: var(--nav-icon) no-repeat center;
          mask-size: contain;
          display: inline-block;
        }
        .product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .prod-card {
            background: var(--white); border-radius: var(--radius-box); overflow: hidden;
            box-shadow: var(--shadow); display: flex; flex-direction: column;
        }
        .prod-img { width: 100%; height: 220px; object-fit: cover; }
        .prod-body { padding: 18px; flex: 1; display: flex; flex-direction: column; }
        .prod-title { font-size: 18px; font-weight: 800; margin: 0 0 8px 0; color: var(--primary); }
        .prod-desc {
            font-size: 13px; color: var(--text-gray); line-height: 1.5;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            margin-bottom: 15px;
        }
        .prod-footer { margin-top: auto; display: flex; justify-content: flex-end; }
        .btn-action {
            background: var(--accent); color: var(--primary); border: none;
            padding: 10px 24px; border-radius: var(--radius-btn); font-weight: 800; font-size: 14px; cursor: pointer;
        }
        /* --- 6. ÂºπÁ™ó (Modal) --- */
        .modal-overlay, .cart-overlay, .legal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            backdrop-filter: blur(0.5px); display: none; justify-content: center; align-items: flex-end;
            transition: opacity 0.3s;
        }
        .cart-overlay { z-index: 2000; }
        .modal-overlay { z-index: 2100; }
        .legal-overlay { z-index: 2200; }
        
        @media(min-width: 768px) {
            .modal-overlay, .cart-overlay, .legal-overlay { align-items: center; }
            .modal-shell, .cart-shell, .legal-shell { max-width: 480px !important; border-radius: 24px !important; height: 85vh !important; }
            /* Legal shell can be wider */
            .legal-shell { max-width: 720px !important; }
        }
        .modal-shell, .cart-shell, .legal-shell {
            background: var(--white); width: 100%; height: 91.25%;
            border-radius: 24px 24px 0 0; display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-shell.open, .cart-shell.open, .legal-shell.open { transform: translateY(0); }
        .cart-shell { background: #F5F7FA; }
        .close-btn, .legal-close {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255,255,255,0.9); width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer; z-index: 30;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .modal-scroll { flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: 20px; }
        .modal-hero-img { width: 100%; height: 280px; object-fit: cover; display: block; }
        .modal-content-box { padding: 24px; }
        .m-title { font-size: 24px; font-weight: 900; margin-bottom: 12px; color: var(--primary); }
        .m-desc { font-size: 15px; color: var(--text-gray); line-height: 1.6; margin-bottom: 30px; }
        .variant-section { border-top: 1px solid var(--border); padding-top: 20px; }
        .v-label { font-size: 17px; font-weight: 800; color: #999; margin-bottom: 15px; display: block; text-transform: uppercase; letter-spacing: 1px; }
        
        .modal-footer {
            padding: 25px 20px 25px 20px; background: var(--white);
            border-top: 0px solid var(--border); z-index: 20;
            display: flex; flex-direction: column; gap: 10px;
        }
        .btn-add-cart {
            width: 100%; background: var(--accent); color: var(--primary); border: none;
            padding: 17px 17px; border-radius: var(--radius-btn); font-size: 17px; font-weight: 900;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            box-shadow: 0 5px 15px rgba(244, 192, 75, 0.3);
        }
        /* Cart Modal Styles */
        .cart-header {
            padding: 14px 18px; background: white; text-align: center;
            font-weight: 900; font-size: 18px; border-bottom: 1px solid var(--border);
        }
        .cart-list { flex: 1; overflow-y: auto; padding: 16px; background: white;}
        #cart-list{
  position: relative;
  min-height: 300px; /* Ê≤°È´òÂ∫¶Â∞±Ê≤°Ê≥ï‚ÄúÂûÇÁõ¥Â±Ö‰∏≠‚Äù */
}

        .cart-item {
            background: white; border-radius: 16px; padding: 15px;
            display: flex; gap: 15px; margin-bottom: 20px; margin-top: 14.5px;
            box-shadow: 0 0px 15px 2.5px rgba(16, 41, 64, 0.1);
             cursor: pointer;
        }
        /* Empty cart image state */
/* Empty cart - always center */
.empty-state{
  position: absolute;
  inset: 0;                 /* top/right/bottom/left = 0 */
  display: flex;
  justify-content: center;  /* horizontal center */
  align-items: center;      /* vertical center */
}

.empty-state img{
  max-width: 50%;
  height: auto;
  display: block;
}


        .cart-img { width: 70px; height: 70px; border-radius: 12px; object-fit: cover; }
        .cart-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .c-title { font-weight: 800; font-size: 15px; margin-bottom: 4px; }
        .c-sku { font-size: 13px; color: #888; margin-bottom: 4px; }
        .c-price { font-weight: 800; font-size: 15px; color: var(--primary); }
        .cart-actions {
            display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 8px;
        }
        .mini-qty {
            background: #F3F4F6; border-radius: 8px; padding: 2px 8px;
            font-size: 13px; font-weight: 800; display: flex; align-items: center; gap: 8px;
        }
        .mini-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .edit-hint { font-size: 11px; color: #AAA; font-weight: 600; text-transform: uppercase; }
        
        /* Sticky Cart */
        .sticky-cart {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: var(--primary); color: white;
            padding: 15px 20px; border-radius: 50px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 8px 20px rgba(16, 41, 64, 0.3); z-index: 800;
            cursor: pointer; transition: all 0.2s;
        }
        .sticky-cart:active { transform: translateX(-50%) scale(0.96); }
        .badge { background: var(--accent); color: var(--primary); padding: 4px 10px; border-radius: 20px; font-weight: 800; font-size: 14px; margin-right: 10px; }
        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: white; padding: 16px 30px;
            border-radius: 30px; z-index: 9999; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; font-weight: 700;
        }
        
        /* Variant Rows */
        .v-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; border-bottom: 1px solid var(--border); cursor: default;
        }
        .v-left{ display:flex; flex-direction:column; gap:4px; }
        .v-name{ font-weight: 800; font-size: 16.5px; color: var(--primary); }
        .v-subprice{ font-weight: 800; font-size: 15.5px; color: var(--primary); opacity: 0.85; }
        .v-qty{
            display:flex; align-items:center; gap:10px;
            background:#F3F4F6; border-radius: 14px; padding: 6px 10px;
            font-weight: 900;
        }
        .v-qty-btn{
            width: 28px; height: 28px; border-radius: 12px;
            display:flex; align-items:center; justify-content:center;
            cursor:pointer; user-select:none;
        }
        .v-qty-val{
            min-width: 18px; text-align:center; font-weight: 900;
        }
        
        /* Cart Total Row */
        .cart-total-row{
            padding: 18px 18px 0px 18px;
            background: white;
            border-top: 0px solid var(--border);
            display:flex;
            justify-content:space-between;
            align-items:center;
            font-weight: 900;
            font-size: 17px;
        }
        .modal-scroll{ padding-bottom: 10px; }

        /* ========= [NEW] Footer & Legal Styles ========= */
        .site-footer{
          max-width: 1000px;
          margin: 28px auto 0;
          padding: 30px 20px 24px;
          color: #7b7b7b;
        }
        .footer-links{
          display:flex;
          flex-wrap: wrap;
          gap: 10px;
          justify-content: center;
          margin-bottom: 10px;
        }
        .footer-link{
          border: 1px solid #E5E7EB;
          background: #fff;
          color: var(--primary);
          padding: 10px 14px;
          border-radius: 999px;
          font-weight: 900;
          font-size: 12px;
          cursor:pointer;
        }
        .footer-note{
          text-align:center;
          font-size: 12px;
          line-height: 1.5;
          margin-top: 25px;
        }
        /* Legal Modal Internals */
       .legal-header{
  padding: 18px 20px 14px;
  border-bottom: 1px solid var(--border);
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(10px);
  position: sticky;
  top: 0;
  z-index: 5;

  /* üëá Ê†∏ÂøÉÊîπÂä® */
  display: flex;
  flex-direction: column;   /* Á∫µÂêëÊéíÂàó */
  align-items: center;      /* Êï¥‰ΩìÂ±Ö‰∏≠ */
  gap: 12px;                /* Ê†áÈ¢òÂíåÊåâÈíÆÈó¥Ë∑ù */
}

       .legal-title{
  font-size: 18px;
  font-weight: 900;
  margin: 0;
  color: var(--primary);
  text-align: center;   /* üëà Ê†áÈ¢òÊñáÂ≠óÂ±Ö‰∏≠ */
}

       .legal-tabs{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;          /* Â∞èÂ±èËá™Âä®Êç¢Ë°å */
  justify-content: center;  /* üëà Ê∞¥Âπ≥Â±Ö‰∏≠ */
}

        .legal-tab{
          border: 1px solid #E5E7EB;
          background: #fff;
          padding: 8px 10px;
          border-radius: 999px;
          font-weight: 900;
          font-size: 12px;
          cursor:pointer;
          color: var(--primary);
          opacity: 0.75;
        }
        .legal-tab.active{
          background: var(--accent);
          opacity: 1;
        }
        .legal-body{
          flex:1;
          overflow-y:auto;
          padding: 18px 20px 24px;
        }
        .legal-section{
          display:none;
          animation: fadeIn 0.15s ease-in;
        }
        .legal-section.active{ display:block; }
        .legal-h2{
          font-size: 16px;
          font-weight: 900;
          margin: 16px 0 8px;
          color: var(--primary);
        }
        .legal-p{
          margin: 0 0 10px;
          color: #4b5563;
          font-size: 13px;
          line-height: 1.6;
        }
        .legal-list{
          margin: 0 0 14px 18px;
          color: #4b5563;
          font-size: 13px;
          line-height: 1.6;
        }
        .legal-kv{
          background: #F5F7FA;
          border: 1px solid #EAEAEA;
          border-radius: 16px;
          padding: 12px 14px;
          margin: 10px 0 14px;
          font-size: 13px;
          color: #374151;
          line-height: 1.6;
        }
        .legal-kv b{ color: var(--primary); }
        .legal-muted{
          color:#9ca3af;
          font-size: 12px;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Animation & Skeleton */
        .reveal-card{
            opacity: 0; translate: 0 30px; transition: opacity .55s ease, translate .55s ease;
            will-change: opacity, translate;
        }
        .reveal-card.is-visible{ opacity: 1; translate: 0 0; }
        @supports not (translate: 0 0){
            .reveal-card{ transform: translateY(30px); transition: opacity .55s ease, transform .55s ease; }
            .reveal-card.is-visible{ transform: translateY(0); }
        }
        @media (prefers-reduced-motion: reduce){
            .reveal-card{ opacity: 1 !important; translate: 0 0 !important; transform: none !important; transition: none !important; }
        }
        .skel-img{ opacity: 0; transform: none; background: #f2f2f2; transition: opacity .5s ease; display: block; }
        .cat-img.skel-img, .prod-img.skel-img{ transition: opacity .5s ease, transform .5s ease; }
        .skel-img.is-loading{
            background-image: linear-gradient(90deg, rgba(242,242,242,1) 0%, rgba(255,255,255,1) 20%, rgba(242,242,242,1) 40%, rgba(242,242,242,1) 100%);
            background-size: 400% 100%;
            animation: sk-shimmer 1.2s linear infinite;
        }
        @keyframes sk-shimmer{ 0%{ background-position: 100% 0; } 100%{ background-position: -100% 0; } }
        .skel-img.is-loaded{ opacity: 1; transform: none; background: none; animation: none; }
        .skel-img.is-error{ opacity: 1; transform: scale(1); background: #f2f2f2; animation: none; }
        .skel-img.is-loaded.is-loading{ animation: none; background: none; }
        @supports (scale: 1){ .cat-card:active { transform: none; scale: 0.98; } }
</style>
</head>
<body>
<!-- Header -->
<div class="smart-header">
	<div class="header-left">
		<img src="https://i.ibb.co/sJtMRwDB/IMG-20251219-091347.png" class="logo-img" alt="Neco's">
	</div>
	<div class="lang-switch">
		<button class="lang-btn" onclick="setLang('en', true)">EN</button>
		<button class="lang-btn" onclick="setLang('pt', true)">PT</button>
		<button class="lang-btn" onclick="setLang('cn', true)">CN</button>
	</div>
</div>

<div class="container">
	<!-- Permanent Search Bar -->
	<div class="search-hero">
		<div class="back-nav">
			<button class="btn-back" onclick="goBack()">
			<span class="back-icon"></span>
			<span id="txt-back">Home</span>
			</button>
		</div>
		<div class="search-hero-inner">
			<span class="search-icon"></span>
			<input type="search" id="search-input" class="search-input" placeholder="Search..." enterkeyhint="search" oninput="handleSearch()" onkeydown="onSearchKeyDown(event)">
			<span class="search-clear" id="search-clear" onclick="clearSearch()">‚úï</span>
		</div>
	</div>
    
	<!-- 1. È¶ñÈ°µ (Home) -->
	<div id="view-home" class="view-section active">
		<div class="category-grid" id="category-grid">
		</div>
	</div>
    
	<!-- 2. ÂàóË°®È°µ (Category / Search Results) -->
	<div id="view-category" class="view-section">
		<div id="category-content">
		</div>
	</div>

    <!-- [NEW] Footer (Legal) -->
    <footer class="site-footer">
        <div class="footer-links">
          <button id="footer-btn-legal" class="footer-link" onclick="openLegalModal('legal')">Legal</button>
          <button id="footer-btn-terms" class="footer-link" onclick="openLegalModal('terms')">Terms</button>
          <button id="footer-btn-returns" class="footer-link" onclick="openLegalModal('returns')">Returns</button>
          <button id="footer-btn-privacy" class="footer-link" onclick="openLegalModal('privacy')">Privacy</button>
          <button id="footer-btn-disputes" class="footer-link" onclick="openLegalModal('disputes')">Disputes</button>
        </div>
        <div class="footer-note">
          <span id="footer-note-text">¬© <span id="footer-year"></span> Neco's Custom Cake ¬∑ All rights reserved.</span>
        </div>
    </footer>
</div>

<!-- 3. ‰∫ßÂìÅËØ¶ÊÉÖÂºπÁ™ó (Product Modal) -->
<div class="modal-overlay" id="product-modal" onclick="closeModal(event)">
	<div class="modal-shell" id="modal-shell" onclick="event.stopPropagation()">
		<div class="close-btn" onclick="closeModalDirect()">‚úï</div>
		<div class="modal-scroll">
			<img src="" id="m-img" class="modal-hero-img">
			<div class="modal-content-box">
				<div class="m-title" id="m-title">Title</div>
				<div class="m-desc" id="m-desc">Desc</div>
				<div class="variant-section">
					<label class="v-label" id="txt-select-size">SELECT SIZE</label>
					<div id="variant-list"></div>
				</div>
			</div>
		</div>
		<div class="modal-footer">
			<button class="btn-add-cart" onclick="confirmAddToCart()">
			<span id="txt-add-btn">Add 0 ‚Ç¨0.00</span>
			</button>
		</div>
	</div>
</div>

<!-- 4. Ë¥≠Áâ©ËΩ¶ÂºπÁ™ó (Cart Modal) -->
<div class="cart-overlay" id="cart-modal" onclick="closeCart(event)">
	<div class="cart-shell" id="cart-shell" onclick="event.stopPropagation()">
		<div class="cart-header">
			<span id="txt-your-order">Your Order</span>
			<div style="position:absolute; right:20px; top:20px; cursor:pointer;" onclick="closeCartDirect()">‚úï</div>
		</div>
		<div class="cart-list" id="cart-list"></div>
		<div class="cart-total-row">
			<span id="txt-total">Total</span>
			<span id="cart-modal-total">‚Ç¨ 0.00</span>
		</div>
		<div class="modal-footer">
			<button class="btn-add-cart" onclick="goToCheckout()">
			<span style="width:100%; text-align:center;" id="txt-confirm">Confirm</span>
			</button>
		</div>
	</div>
</div>

<!-- [NEW] 5. Legal Modal -->
<div id="legal-modal" class="legal-overlay" onclick="closeLegalByOverlay(event)">
  <div id="legal-shell" class="legal-shell">
    <div class="legal-close" onclick="closeLegalDirect()">√ó</div>

    <div class="legal-header">
      <h3 id="legal-title" class="legal-title">Legal</h3>
      <div class="legal-tabs">
        <button class="legal-tab" data-tab="legal" onclick="switchLegalTab('legal')">Legal</button>
        <button class="legal-tab" data-tab="terms" onclick="switchLegalTab('terms')">Terms</button>
        <button class="legal-tab" data-tab="returns" onclick="switchLegalTab('returns')">Returns</button>
        <button class="legal-tab" data-tab="privacy" onclick="switchLegalTab('privacy')">Privacy</button>
        <button class="legal-tab" data-tab="disputes" onclick="switchLegalTab('disputes')">Disputes</button>
      </div>
    </div>

    <div class="legal-body">
      <!-- Legal / Identifica√ß√£o -->
      <section id="legal-section-legal" class="legal-section">
        <div class="legal-kv" id="legal-kv-ident"></div>

        <h4 class="legal-h2" id="legal-h2-scope">Scope</h4>
        <p class="legal-p" id="legal-p-scope"></p>

        <h4 class="legal-h2" id="legal-h2-contacts">Contacts</h4>
        <p class="legal-p" id="legal-p-contacts"></p>
      </section>

      <!-- Terms -->
      <section id="legal-section-terms" class="legal-section">
        <h4 class="legal-h2" id="terms-h2-1">Terms & Conditions of Purchase</h4>
        <p class="legal-p" id="terms-p-1"></p>

        <h4 class="legal-h2" id="terms-h2-2">Orders & Payment</h4>
        <ul class="legal-list" id="terms-list-2"></ul>

        <h4 class="legal-h2" id="terms-h2-3">Prices</h4>
        <p class="legal-p" id="terms-p-3"></p>
      </section>

      <!-- Returns -->
      <section id="legal-section-returns" class="legal-section">
        <h4 class="legal-h2" id="returns-h2-1">Delivery / Pickup</h4>
        <ul class="legal-list" id="returns-list-1"></ul>

        <h4 class="legal-h2" id="returns-h2-2">Exchanges & Returns</h4>
        <ul class="legal-list" id="returns-list-2"></ul>

        <p class="legal-p legal-muted" id="returns-muted"></p>
      </section>

      <!-- Privacy -->
      <section id="legal-section-privacy" class="legal-section">
        <h4 class="legal-h2" id="privacy-h2-1">Data Protection (RGPD/GDPR)</h4>
        <p class="legal-p" id="privacy-p-1"></p>

        <h4 class="legal-h2" id="privacy-h2-2">What data we collect</h4>
        <ul class="legal-list" id="privacy-list-2"></ul>

        <h4 class="legal-h2" id="privacy-h2-3">Your rights</h4>
        <ul class="legal-list" id="privacy-list-3"></ul>

        <h4 class="legal-h2" id="privacy-h2-4">Cookies</h4>
        <p class="legal-p" id="privacy-p-4"></p>
      </section>

      <!-- Disputes -->
      <section id="legal-section-disputes" class="legal-section">
        <h4 class="legal-h2" id="disputes-h2-1">Alternative Dispute Resolution</h4>
        <p class="legal-p" id="disputes-p-1"></p>

        <div class="legal-kv" id="legal-kv-adr"></div>

        <h4 class="legal-h2" id="disputes-h2-2">Online Dispute Resolution (ODR)</h4>
        <p class="legal-p" id="disputes-p-2"></p>
      </section>
    </div>
  </div>
</div>

<!-- 6. Â∫ïÈÉ®ÊÇ¨ÊµÆÊù° (Sticky Cart) -->
<div class="sticky-cart" id="sticky-cart" onclick="openCartModal()">
	<div style="display:flex; align-items:center;">
		<span class="badge" id="cart-count">0</span>
		<span id="sticky-cart-label" style="font-weight:700;">View Order</span>
	</div>
	<div style="font-weight:800; font-size:18px;" id="cart-bar-total">
		‚Ç¨ 0.00
	</div>
</div>
<div id="toast" class="toast">
	Update Success!
</div>

<script>
        // ==========================================
        // 0. Love È£éÊ†ºÂä®Êïà
        // ==========================================
        const __fx = { seenCards: new Set(), loadedSrc: new Set(), revealIO: null };
        function __ensureRevealIO(){
          if(__fx.revealIO) return __fx.revealIO;
          __fx.revealIO = new IntersectionObserver((entries) => {
            entries.forEach((e) => {
              if(!e.isIntersecting) return;
              const el = e.target;
              el.classList.add('is-visible');
              const key = el.dataset.revealKey || '';
              if(key) __fx.seenCards.add(key);
              __fx.revealIO.unobserve(el);
            });
          }, { threshold: 0.15 });
          return __fx.revealIO;
        }
        function __normUrl(u){ return (u || '').trim(); }
        function __isImgLoadedByUrl(url){ const u = __normUrl(url); return u && __fx.loadedSrc.has(u); }
        function __imgClass(url, base){
          const loaded = __isImgLoadedByUrl(url);
          return `${base} skel-img js-skel-img ${loaded ? 'is-loaded' : 'is-loading'}`;
        }
        function __imgDataAttrs(url){ const loaded = __isImgLoadedByUrl(url); return loaded ? `data-fx-init="1" data-fx-loaded="1"` : ``; }
        function __cardClass(key, base){
          const seen = key && __fx.seenCards.has(key);
          return `${base} reveal-card js-reveal ${seen ? 'is-visible' : ''}`;
        }
        function __markImgLoaded(img){
          if(!img || img.dataset.fxLoaded === '1') return;
          img.dataset.fxLoaded = '1'; img.classList.remove('is-loading'); img.classList.add('is-loaded');
          const srcKey = __normUrl(img.currentSrc || img.src);
          if(srcKey) __fx.loadedSrc.add(srcKey);
        }
        function __markImgError(img){ if(!img) return; img.classList.remove('is-loading'); img.classList.add('is-error'); }
        function __initReveal(root){
          const io = __ensureRevealIO();
          const cards = (root || document).querySelectorAll('.js-reveal');
          cards.forEach((card) => {
            const key = card.dataset.revealKey || '';
            if(key && card.classList.contains('is-visible')){ __fx.seenCards.add(key); return; }
            if(key && __fx.seenCards.has(key)){ card.classList.add('is-visible'); return; }
            if(!card.classList.contains('is-visible')){ io.observe(card); }
          });
        }
        function __initImages(root){
          const imgs = (root || document).querySelectorAll('img.js-skel-img');
          imgs.forEach((img) => {
            const srcKey = __normUrl(img.currentSrc || img.src);
            if(img.dataset.fxLoaded === '1' || img.classList.contains('is-loaded')){
              if(srcKey) __fx.loadedSrc.add(srcKey); img.dataset.fxInit = '1'; return;
            }
            if(img.dataset.fxInit === '1') return;
            img.dataset.fxInit = '1';
            try { img.decoding = 'async'; } catch(e){}
            if(srcKey && __fx.loadedSrc.has(srcKey)){ __markImgLoaded(img); return; }
            img.classList.add('skel-img'); img.classList.add('is-loading');
            const done = () => { const p = (img.decode ? img.decode() : Promise.resolve()); Promise.resolve(p).catch(() => {}).then(() => __markImgLoaded(img)); };
            const fail = () => __markImgError(img);
            if(img.complete && img.naturalWidth > 0){ done(); return; }
            img.addEventListener('load', done, { once: true });
            img.addEventListener('error', fail, { once: true });
          });
        }
        function initCardFX(root){ __initReveal(root); __initImages(root); }

        // ==========================================
        // 1. Êï∞ÊçÆ‰∏≠ÂøÉ & Ê≥ïÂæã‰ø°ÊÅØ
        // ==========================================
        const LEGAL_INFO = {
          ownerName: "Neco's Custom Cake",
          address: "Rua Silva Carvalho 233, Lisboa, Portugal",
          taxId: "288328361",
          email: "Lin968668171@email.com",
          phone: "+351 930523010",
          businessHours: "Mon‚ÄìSat 11:00‚Äì19:00",
          deliveryArea: "Lisbon area",
          deliveryTime: "24‚Äì48h",
          deliveryFee: "From 2‚Ç¨",
          arbitrationEntity: "Centro de Arbitragem de Conflitos de Consumo de Lisboa (CACCL)",
          arbitrationWebsite: "https://www.centroarbitragemlisboa.pt",
          odrWebsite: "https://ec.europa.eu/consumers/odr",
        };

         
// ‚úÖ db ‰∏çËÉΩÁî® const ÈîÅÊ≠ªÔºåË¶ÅËÉΩÂú® products.js ÊãâÂà∞Êï∞ÊçÆÂêéÊõ¥Êñ∞
let db = window.NECO_DB || { categories: [], items: {} };

// ÂΩì products.js ÊãâÂèñÂÆåÊàêÔºå‰ºöËß¶ÂèëËøô‰∏™‰∫ã‰ª∂Ôºàproducts.js ÈáåÂ∑≤Áªè dispatch ‰∫ÜÔºâ:contentReference[oaicite:1]{index=1}
window.addEventListener("NECO_DB_READY", () => {
  db = window.NECO_DB;
}, { once: true });

        let state = {
          lang: 'en',
          isSearchMode: false,
          cart: [],
          modal: { item: null, variant: null, qty: 1, editUid: null, editProductId: null, variantQty: {} },
          scroll: { home: { en: 0, pt: 0, cn: 0 } },
          currentCategoryId: null
        };
        
        let __legalTab = 'legal'; // current legal tab

        // ==========================================
        // 2. Language Logic
        // ==========================================
        const LANG_KEY = 'neco_lang_v1';
        const LANG_LOCK_KEY = 'neco_lang_lock_v1';
        function isLangLocked(){ try{ return localStorage.getItem(LANG_LOCK_KEY) === '1'; }catch(e){ return false; } }
        function lockLang(){ try{ localStorage.setItem(LANG_LOCK_KEY, '1'); }catch(e){} }
        function _normLocale(s){ return String(s || '').trim().toLowerCase().replace('_', '-'); }
        function detectSystemLang(){
          const candidates = [];
          if (Array.isArray(navigator.languages)) candidates.push(...navigator.languages);
          if (navigator.language) candidates.push(navigator.language);
          try{ const loc = Intl.DateTimeFormat().resolvedOptions().locale; if (loc) candidates.push(loc); }catch(e){}
          for (const raw of candidates) {
            const l = _normLocale(raw);
            if (!l) continue;
            if (l.startsWith('pt')) return 'pt';
            if (l.startsWith('zh')) return 'cn';
            if (l.startsWith('en')) return 'en';
            if (l.startsWith('cn')) return 'cn';
          }
          return 'en';
        }
        function loadPreferredLang(){
          try{ if (isLangLocked()){ const saved = localStorage.getItem(LANG_KEY); if (saved && ['en','pt','cn'].includes(saved)) return saved; } }catch(e){}
          return detectSystemLang();
        }
        function persistLang(l){ try{ localStorage.setItem(LANG_KEY, l); }catch(e){} }
        
        // ==========================================
        // 3. Cart persistence
        // ==========================================
        const CART_KEY = 'neco_cart_v2';
        function _isValidCartItem(it){ return it && typeof it === 'object' && typeof it.uid === 'string' && typeof it.productId === 'string' && typeof it.variantId === 'string' && typeof it.qty === 'number'; }
        function saveCart(){
          try{
            const data = state.cart.map(it => ({ uid: it.uid, productId: it.productId, variantId: it.variantId, qty: it.qty }));
            localStorage.setItem(CART_KEY, JSON.stringify({ v: 2, updatedAt: Date.now(), cart: data }));
          }catch(e){ console.warn('saveCart failed', e); }
        }
        function loadCart(){
          try{
            const raw = localStorage.getItem(CART_KEY); if(!raw) return;
            const obj = JSON.parse(raw); const arr = (obj && obj.cart) ? obj.cart : obj;
            if(!Array.isArray(arr)) return;
            state.cart = arr.filter(_isValidCartItem).map(it => ({ uid: it.uid, productId: it.productId, variantId: it.variantId, qty: Math.max(1, Number(it.qty) || 1) }));
          }catch(e){ console.warn('loadCart failed', e); }
        }
        function findItemById(productId){
          for(const cat in db.items){ const hit = (db.items[cat] || []).find(p => p.id === productId); if(hit) return hit; }
          return null;
        }
        function resolveCartItem(ci){
          const item = findItemById(ci.productId);
          if(!item){ return { missing: true, uid: ci.uid, qty: ci.qty, productId: ci.productId, variantId: ci.variantId }; }
          const variant = (item.variants || []).find(v => v.id === ci.variantId);
          if(!variant){ return { missing: true, uid: ci.uid, qty: ci.qty, productId: ci.productId, variantId: ci.variantId, img: item.img, title: item.title }; }
          return { missing: false, uid: ci.uid, qty: ci.qty, productId: ci.productId, variantId: ci.variantId, img: item.img, title: item.title, variantNames: variant.names, price: variant.price, _item: item, _variant: variant };
        }

        // ==========================================
        // 4. Texts & Merged Data
        // ==========================================
        const texts = {
          cn: {
            back: "ËøîÂõûÂàÜÁ±ª", homeTitle: "‰∏ªÈ°µ", select: "ÈÄâÊã©ËßÑÊ†º", add: "Âä†ÂÖ•ËÆ¢Âçï", update: "Êõ¥Êñ∞ËÆ¢Âçï",
            view: "Êü•ÁúãËÆ¢Âçï", more: "Êü•ÁúãËØ¶ÊÉÖ", order: "ÊàëÁöÑËÆ¢Âçï", total: "ÊÄªËÆ°",
            confirm: "Á°ÆËÆ§‰∏ãÂçï", remove: "ÁßªÈô§Ê≠§ÂïÜÂìÅ", empty: "Ë¥≠Áâ©ËΩ¶‰∏∫Á©∫",
            added: "Â∑≤Âä†ÂÖ•ËÆ¢Âçï", updated: "ËÆ¢ÂçïÂ∑≤Êõ¥Êñ∞", editHint: "ÁÇπÂáªÁºñËæë",
            searchPh: "ÊêúÁ¥¢ËõãÁ≥ï...", noResult: "Êú™ÊâæÂà∞Áõ∏ÂÖ≥ÂïÜÂìÅ", fallback: "ÂΩìÂâçËØ≠Ë®ÄÊó†ÁªìÊûúÔºåÂ∑≤Â±ïÁ§∫ÂÖ∂‰ªñËØ≠Ë®ÄÂåπÈÖç„ÄÇ",
            missing: "ËØ•ÂïÜÂìÅÂ∑≤‰∏ãÊû∂ÊàñËßÑÊ†ºÂ∑≤ÂèòÊõ¥ÔºåËØ∑ÁßªÈô§ÂêéÈáçÊñ∞ÈÄâÊã©„ÄÇ",
            missingTitle: "Â∑≤‰∏ãÊû∂ÂïÜÂìÅ", missingVariant: "ËßÑÊ†º‰∏çÂèØÁî®", removeHintMissing: "ËØ∑ÁßªÈô§",
            // Legal & Footer
            footerBtnLegal: "‰∏ª‰Ωì‰ø°ÊÅØ", footerBtnTerms: "Ë¥≠‰π∞Êù°Ê¨æ", footerBtnReturns: "ÈÖçÈÄÅ/ÈÄÄÊç¢", footerBtnPrivacy: "ÈöêÁßÅ‰∏éÊï∞ÊçÆ", footerBtnDisputes: "‰∫âËÆÆ/‰ª≤Ë£Å",
            footerNote: "¬© {year} Neco's Custom Cake ¬∑ ‰øùÁïôÊâÄÊúâÊùÉÂà©„ÄÇ",
            legalTitle: "Ê≥ïÂæã‰ø°ÊÅØ‰∏éÊîøÁ≠ñ", tabLegal: "‰∏ª‰Ωì‰ø°ÊÅØ", tabTerms: "Ë¥≠‰π∞Êù°Ê¨æ", tabReturns: "ÈÖçÈÄÅ/ÈÄÄÊç¢", tabPrivacy: "ÈöêÁßÅ‰∏éÊï∞ÊçÆ", tabDisputes: "‰∫âËÆÆ/‰ª≤Ë£Å",
            scopeH2: "ËåÉÂõ¥ËØ¥Êòé", scopeP: "Êú¨ÁΩëÁ´ôÁî®‰∫éÂ±ïÁ§∫‰∫ßÂìÅÂπ∂Êé•ÂèóÂÆ¢Êà∑‰∏ãÂçï„ÄÇ‰ΩøÁî®Êú¨ÁΩëÁ´ôÂç≥Ë°®Á§∫‰Ω†ÂêåÊÑè‰ª•‰∏ãÊù°Ê¨æ„ÄÇ",
            contactsH2: "ËÅîÁ≥ªÊñπÂºè", contactsP: "Â¶ÇÈúÄÂí®ËØ¢‰∏ãÂçï„ÄÅÈÖçÈÄÅ„ÄÅÈÄÄÊç¢Ë¥ßÊàñÈöêÁßÅÈóÆÈ¢òÔºåËØ∑‰ΩøÁî®‰∏äÊñπ‰ø°ÊÅØ‰∏éÊàë‰ª¨ËÅîÁ≥ª„ÄÇ",
            termsH2_1: "Ë¥≠‰π∞Êù°Ê¨æ‰∏éÊù°‰ª∂", termsP1: "Êú¨Êù°Ê¨æÈÄÇÁî®‰∫éÈÄöËøáÊú¨ÁΩëÁ´ôËøõË°åÁöÑÊâÄÊúâË¥≠‰π∞„ÄÇÂª∫ËÆÆ‰∏ãÂçïÂâç‰ªîÁªÜÈòÖËØª„ÄÇ",
            termsH2_2: "‰∏ãÂçï‰∏é‰ªòÊ¨æ", termsList2: ["ÔºàÂ¶ÇÈÄÇÁî®Ôºâ‰ªòÊ¨æÂÆåÊàê‰∏îÊàë‰ª¨Á°ÆËÆ§ÂèØÂà∂‰ΩúÂêéÔºåËÆ¢ÂçïÊâçÁÆóÁ°ÆËÆ§„ÄÇ", "ÂÆöÂà∂/‰∏™ÊÄßÂåñ‰∫ßÂìÅÈÄöÂ∏∏ÈúÄË¶ÅÊèêÂâçÈ¢ÑÁ∫¶ÔºåÊàë‰ª¨‰ºöÈÄöËøáÊ∂àÊÅØÁ°ÆËÆ§‰∫§‰ªò/Ëá™ÂèñÊó•Êúü„ÄÇ", "Â¶ÇÈúÄÂèñÊ∂àÊàñ‰øÆÊîπÔºåËØ∑Â∞ΩÂø´ËÅîÁ≥ªÔºõÂºÄÂßãÂà∂‰ΩúÂêéÂèØËÉΩÊó†Ê≥ïÊõ¥Êîπ„ÄÇ"],
            termsH2_3: "‰ª∑Ê†º", termsP3: "ÊâÄÊúâ‰ª∑Ê†º‰ª•Ê¨ßÂÖÉÔºà‚Ç¨ÔºâÊòæÁ§∫ÔºåÂèØËÉΩ‰ºöË∞ÉÊï¥„ÄÇÁ®éË¥πÂ∞ÜÊåâÊ≥ïÂæãË¶ÅÊ±ÇÈÄÇÁî®„ÄÇ",
            returnsH2_1: "ÈÖçÈÄÅ / Ëá™Âèñ", returnsList1: ["ÈÖçÈÄÅËåÉÂõ¥Ôºö{deliveryArea}", "È¢ÑËÆ°ÈÖçÈÄÅÊó∂Èó¥Ôºö{deliveryTime}", "ÈÖçÈÄÅË¥πÁî®Ôºö{deliveryFee}", "ÂèØÊåâÊ∂àÊÅØÁ∫¶ÂÆöËá™Âèñ„ÄÇ"],
            returnsH2_2: "ÈÄÄÊç¢Ë¥ßËßÑÂàô", returnsList2: ["Áî±‰∫é‰∏∫È£üÂìÅÔºàÊòìËÖêÔºâ‰∏é/ÊàñÂÆöÂà∂‰∫ßÂìÅÔºåÂºÄÂßãÂà∂‰ΩúÂêéÈÄöÂ∏∏‰∏çÊîØÊåÅÊó†ÁêÜÁî±ÈÄÄË¥ß„ÄÇ", "Ëã•Êî∂Âà∞ÊçüÂùèÊàñÊúâËØØÔºåËØ∑Âú® 24 Â∞èÊó∂ÂÜÖÊèê‰æõÁÖßÁâáËÅîÁ≥ªÊàë‰ª¨ÔºåÊàë‰ª¨‰ºöÁªôÂá∫Ëß£ÂÜ≥ÊñπÊ°àÔºàË°•ÂèëÊàñÈÄÄÊ¨æÔºâ„ÄÇ", "Â¶ÇÊâπÂáÜÈÄÄÊ¨æÔºåÂ∞ÜÂú®ÂêàÁêÜÊó∂Èó¥ÂÜÖÊåâÂéüÊîØ‰ªòÊñπÂºèÈÄÄÂõû„ÄÇ"],
            returnsMuted: "ÊèêÁ§∫ÔºöÂÆöÂà∂ËõãÁ≥ïËØ∑Âú®Á°ÆËÆ§ÂâçÊ†∏ÂØπÊñáÂ≠ó„ÄÅÊó•Êúü‰∏éËÆæËÆ°Ë¶ÅÊ±Ç„ÄÇ",
            privacyH2_1: "Êï∞ÊçÆ‰øùÊä§ÔºàRGPD/GDPRÔºâ", privacyP1: "Êàë‰ª¨ÈÅµÂÆà RGPD/GDPR Â§ÑÁêÜ‰∏™‰∫∫Êï∞ÊçÆÔºå‰ªÖÁî®‰∫éËÆ¢ÂçïÁÆ°ÁêÜ„ÄÅÈÖçÈÄÅ/Ëá™Âèñ„ÄÅÂºÄÁ•®‰∏éÂîÆÂêéÊîØÊåÅ„ÄÇ",
            privacyH2_2: "Êàë‰ª¨Êî∂ÈõÜÂì™‰∫õÊï∞ÊçÆ", privacyList2: ["Ë∫´‰ªΩ‰∏éËÅîÁ≥ªÊñπÂºèÔºàÂßìÂêç„ÄÅÁîµËØù„ÄÅÈÇÆÁÆ±Ôºâ„ÄÇ", "ÈúÄË¶ÅÈÖçÈÄÅÊó∂ÁöÑÂú∞ÂùÄ‰ø°ÊÅØ„ÄÇ", "‰∏∫ÂÆåÊàêËÆ¢ÂçïÊâÄÈúÄÁöÑËÆ¢ÂçïÂÜÖÂÆπ‰∏éÊ≤üÈÄöËÆ∞ÂΩï„ÄÇ", "Âü∫Á°ÄÂäüËÉΩÊâÄÈúÄÁöÑÊäÄÊúØÊï∞ÊçÆÔºàÂ¶ÇËØ≠Ë®Ä/Ë¥≠Áâ©ËΩ¶ cookiesÔºâ„ÄÇ"],
            privacyH2_3: "‰Ω†ÁöÑÊùÉÂà©", privacyList3: ["Êü•ËØ¢„ÄÅÊõ¥Ê≠£ÊàñÂà†Èô§‰Ω†ÁöÑÊï∞ÊçÆÔºàÈÄÇÁî®Êó∂Ôºâ„ÄÇ", "ÂΩìÂ§ÑÁêÜÂü∫‰∫éÂêåÊÑèÊó∂ÔºåÂèØÊí§ÂõûÂêåÊÑè„ÄÇ", "ËØ∑Ê±Ç‰∫ÜËß£‰Ω†ÁöÑÊï∞ÊçÆÂ¶Ç‰ΩïË¢´‰ΩøÁî®„ÄÇ"],
            privacyH2_4: "Cookies", privacyP4: "Êàë‰ª¨ÂèØËÉΩ‰ΩøÁî® cookies Áî®‰∫éÂü∫Á°ÄÂäüËÉΩÔºà‰æãÂ¶ÇËØ≠Ë®Ä‰∏éË¥≠Áâ©ËΩ¶Ôºâ„ÄÇ‰Ω†ÂèØÂú®ÊµèËßàÂô®ËÆæÁΩÆ‰∏≠ÁÆ°ÁêÜ cookies„ÄÇ",
            disputesH2_1: "Êõø‰ª£ÊÄß‰∫âËÆÆËß£ÂÜ≥Ôºà‰ª≤Ë£ÅÔºâ", disputesP1: "Â¶ÇÂèëÁîüÊ∂àË¥π‰∫âËÆÆÔºåÊ∂àË¥πËÄÖÂèØ‰ΩøÁî®‰∏ãÊñπÊâÄÂàóÁöÑÊõø‰ª£ÊÄß‰∫âËÆÆËß£ÂÜ≥Êú∫ÊûÑÔºà‰ª≤Ë£Å‰∏≠ÂøÉ/ Centro de ArbitragemÔºâ„ÄÇ",
            disputesH2_2: "Âú®Á∫ø‰∫âËÆÆËß£ÂÜ≥ÔºàODRÔºâ", disputesP2: "Ê¨ßÁõüÊ∂àË¥πËÄÖ‰πüÂèØ‰ΩøÁî®Ê¨ßÊ¥≤Âú®Á∫ø‰∫âËÆÆËß£ÂÜ≥Âπ≥Âè∞ÔºàODRÔºâ„ÄÇ"
          },
          en: {
            back: "Back", homeTitle: "Home", select: "Select Size", add: "Add to Order", update: "Update Order",
            view: "View Order", more: "More Info", order: "Your Order", total: "Total",
            confirm: "Confirm", remove: "Remove Item", empty: "Empty Cart",
            added: "Added to Order", updated: "Order Updated", editHint: "Edit item",
            searchPh: "Search cakes...", noResult: "No results found", fallback: "No results in English, showing matches from other languages.",
            missing: "Item unavailable (menu updated). Please remove and re-add.",
            missingTitle: "Unavailable item", missingVariant: "Variant unavailable", removeHintMissing: "REMOVE",
            // Legal & Footer
            footerBtnLegal: "Legal info", footerBtnTerms: "Terms", footerBtnReturns: "Exchanges & Returns", footerBtnPrivacy: "Privacy", footerBtnDisputes: "Dispute Resolution",
            footerNote: "¬© {year} Neco's Custom Cake ¬∑ All rights reserved.",
            legalTitle: "Legal & Policies", tabLegal: "Legal", tabTerms: "Terms", tabReturns: "Returns", tabPrivacy: "Privacy", tabDisputes: "Disputes",
            scopeH2: "Scope", scopeP: "This website is used to present products and allow customers to place orders. By using this website, you agree to the terms below.",
            contactsH2: "Contacts", contactsP: "For any questions about orders, delivery, returns or privacy, please contact us using the details above.",
            termsH2_1: "Terms & Conditions of Purchase", termsP1: "These terms apply to all purchases made through this website. We recommend you read them carefully before placing your order.",
            termsH2_2: "Orders & Payment", termsList2: ["Orders are confirmed after payment is completed (when applicable) and after we confirm availability.", "Custom/Personalized products may require advance notice. We will confirm the delivery/pickup date by message.", "If you need to cancel or change an order, contact us as soon as possible. Changes may not be possible once preparation starts."],
            termsH2_3: "Prices", termsP3: "All prices are shown in euros (‚Ç¨) and may change without prior notice. Taxes will be applied as legally required.",
            returnsH2_1: "Delivery / Pickup", returnsList1: ["Delivery area: {deliveryArea}", "Estimated delivery time: {deliveryTime}", "Delivery fee: {deliveryFee}", "Pickup is available when agreed by message."],
            returnsH2_2: "Exchanges & Returns", returnsList2: ["Because we sell perishable food and personalized items, returns for change-of-mind may not apply once production starts.", "If you receive a damaged product or there is a mistake, contact us within 24 hours with photos, and we will propose a solution (replacement or refund).", "Refunds, when approved, are processed using the original payment method within a reasonable timeframe."],
            returnsMuted: "Note: For customized cakes, please double-check the text, dates, and design requests before confirmation.",
            privacyH2_1: "Data Protection (RGPD/GDPR)", privacyP1: "We process personal data in accordance with the RGPD/GDPR. Data is used only to manage orders, delivery/pickup, invoicing and customer support.",
            privacyH2_2: "What data we collect", privacyList2: ["Identification and contact details (name, phone, email).", "Delivery information (address) when delivery is requested.", "Order details and messages needed to fulfil the order.", "Technical data such as cookies (if enabled) for basic site functionality."],
            privacyH2_3: "Your rights", privacyList3: ["Access, rectify or delete your data (when applicable).", "Withdraw consent where processing is based on consent.", "Request information about how your data is used."],
            privacyH2_4: "Cookies", privacyP4: "Cookies may be used to improve basic functionality (e.g., language and cart). You can manage cookies in your browser settings.",
            disputesH2_1: "Alternative Dispute Resolution", disputesP1: "In case of dispute, the consumer may resort to an Alternative Dispute Resolution entity (Centro de Arbitragem) as indicated below.",
            disputesH2_2: "Online Dispute Resolution (ODR)", disputesP2: "Consumers in the EU may also use the European Online Dispute Resolution platform (ODR)."
          },
          pt: {
            back: "Voltar", homeTitle: "In√≠cio", select: "Selecione o Tamanho", add: "Adicionar", update: "Atualizar",
            view: "Ver Pedido", more: "Mais Info", order: "Seu Pedido", total: "Total",
            confirm: "Confirmar", remove: "Remover Item", empty: "Carrinho Vazio",
            added: "Adicionado", updated: "Atualizado", editHint: "Editar item",
            searchPh: "Pesquisar bolos...", noResult: "Nenhum resultado", fallback: "Sem resultados em Portugu√™s, a mostrar outras l√≠nguas.",
            missing: "Item indispon√≠vel (menu atualizado). Remova e adicione novamente.",
            missingTitle: "Item indispon√≠vel", missingVariant: "Variante indispon√≠vel", removeHintMissing: "REMOVER",
            // Legal & Footer
            footerBtnLegal: "Informa√ß√£o Legal", footerBtnTerms: "Termos", footerBtnReturns: "Trocas/Devolu√ß√µes", footerBtnPrivacy: "Privacidade", footerBtnDisputes: "Resolu√ß√£o de Lit√≠gios",
            footerNote: "¬© {year} Neco's Custom Cake ¬∑ Todos os direitos reservados.",
            legalTitle: "Informa√ß√£o Legal & Pol√≠ticas", tabLegal: "Legal", tabTerms: "Termos", tabReturns: "Trocas/Devolu√ß√µes", tabPrivacy: "Privacidade", tabDisputes: "Lit√≠gios",
            scopeH2: "√Çmbito", scopeP: "Este website apresenta produtos e permite efetuar encomendas. Ao utilizar este website, concorda com os termos abaixo.",
            contactsH2: "Contactos", contactsP: "Para quest√µes sobre encomendas, entrega, devolu√ß√µes ou privacidade, contacte-nos atrav√©s dos dados acima.",
            termsH2_1: "Termos e Condi√ß√µes de Compra", termsP1: "Estes termos aplicam-se a todas as compras efetuadas atrav√©s deste website. Recomendamos a leitura antes de efetuar a encomenda.",
            termsH2_2: "Encomendas & Pagamento", termsList2: ["As encomendas s√£o confirmadas ap√≥s pagamento (quando aplic√°vel) e confirma√ß√£o de disponibilidade.", "Produtos personalizados podem exigir aviso pr√©vio. Confirmaremos a data de entrega/recolha por mensagem.", "Para cancelar ou alterar uma encomenda, contacte-nos o mais cedo poss√≠vel. Altera√ß√µes podem n√£o ser poss√≠veis ap√≥s in√≠cio de prepara√ß√£o."],
            termsH2_3: "Pre√ßos", termsP3: "Todos os pre√ßos s√£o apresentados em euros (‚Ç¨) e podem ser alterados sem aviso pr√©vio. Impostos ser√£o aplicados conforme exigido por lei.",
            returnsH2_1: "Entrega / Recolha", returnsList1: ["Zona de entrega: {deliveryArea}", "Prazo estimado: {deliveryTime}", "Custo de entrega: {deliveryFee}", "Recolha dispon√≠vel mediante acordo por mensagem."],
            returnsH2_2: "Trocas & Devolu√ß√µes", returnsList2: ["Sendo produtos alimentares perec√≠veis e/ou personalizados, a devolu√ß√£o por arrependimento pode n√£o ser aplic√°vel ap√≥s in√≠cio de produ√ß√£o.", "Se receber um produto danificado ou com erro, contacte-nos no prazo de 24 horas com fotografias, e apresentaremos uma solu√ß√£o (substitui√ß√£o ou reembolso).", "Reembolsos aprovados s√£o processados pelo mesmo m√©todo de pagamento num prazo razo√°vel."],
            returnsMuted: "Nota: Para bolos personalizados, confirme cuidadosamente texto, datas e pedidos de design antes da confirma√ß√£o.",
            privacyH2_1: "Prote√ß√£o de Dados (RGPD)", privacyP1: "Tratamos dados pessoais de acordo com o RGPD. Os dados s√£o utilizados apenas para gerir encomendas, entrega/recolha, fatura√ß√£o e apoio ao cliente.",
            privacyH2_2: "Que dados recolhemos", privacyList2: ["Dados de identifica√ß√£o e contacto (nome, telefone, email).", "Dados de entrega (morada) quando solicitado.", "Detalhes da encomenda e mensagens necess√°rias para execu√ß√£o.", "Dados t√©cnicos como cookies (se ativos) para funcionalidades b√°sicas do site."],
            privacyH2_3: "Os seus direitos", privacyList3: ["Aceder, retificar ou apagar dados (quando aplic√°vel).", "Retirar consentimento quando o tratamento se baseia em consentimento.", "Solicitar informa√ß√£o sobre como os dados s√£o utilizados."],
            privacyH2_4: "Cookies", privacyP4: "Podem ser usados cookies para funcionalidades b√°sicas (ex.: idioma e carrinho). Pode gerir cookies nas defini√ß√µes do seu navegador.",
            disputesH2_1: "Resolu√ß√£o Alternativa de Lit√≠gios", disputesP1: "Em caso de lit√≠gio, o consumidor pode recorrer a uma entidade de Resolu√ß√£o Alternativa de Lit√≠gios (Centro de Arbitragem) indicada abaixo.",
            disputesH2_2: "Resolu√ß√£o de Lit√≠gios em Linha (ODR)", disputesP2: "Consumidores na UE tamb√©m podem utilizar a plataforma europeia de Resolu√ß√£o de Lit√≠gios em Linha (ODR)."
          }
        };

        let __lastSystemLang = detectSystemLang();
        function applySystemLangIfUnlocked(){
          if (isLangLocked()) return;
          const sys = detectSystemLang();
          if (sys !== state.lang){ setLang(sys, false); }
          __lastSystemLang = sys;
        }
        function startAutoLangWatch(){
          window.addEventListener('languagechange', applySystemLangIfUnlocked);
          setInterval(() => { if (isLangLocked()) return; const now = detectSystemLang(); if (now !== __lastSystemLang){ applySystemLangIfUnlocked(); } }, 2000);
        }

        function init() {
            loadCart();
            const initialLang = loadPreferredLang();
            setLang(initialLang, false);
            startAutoLangWatch();
            updateCartBar();
            if (!history.state || !history.state.view) { history.replaceState({ view: 'home' }, ''); }
            fillLegalTexts(); // Fill footer texts on init
        }

        function safeText(v){ return (v===undefined || v===null) ? "" : String(v); }

        function setLang(l, userChosen = false) {
          if (!['en','pt','cn'].includes(l)) l = 'en';
          state.lang = l;
          if (userChosen){ persistLang(l); lockLang(); }
          document.documentElement.lang = (l === 'cn') ? 'zh-CN' : l;
          document.querySelectorAll('.lang-btn').forEach(b => {
            b.classList.toggle('active', b.innerText.toLowerCase() === l);
          });
          updateUI();
          fillLegalTexts(); // Update legal modal and footer
          if(state.isSearchMode) handleSearch();
        }

        function onSearchKeyDown(e) {
          if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); handleSearch(); }
        }

        function updateTopButtonLabel() {
          const isHome = document.getElementById('view-home').classList.contains('active');
          const t = texts[state.lang];
          const txt = document.getElementById('txt-back');
          if (txt) txt.innerText = isHome ? t.homeTitle : t.back;
          const nav = document.querySelector('.back-nav');
          if (!nav) return;
          if (isHome) {
            nav.style.setProperty('--nav-icon', 'url("https://i.ibb.co/kVS4zpC5/IMG-20251219-152124.png")');
            nav.style.setProperty('--nav-icon-size', '22.5px');
          } else {
            nav.style.setProperty('--nav-icon', 'url("https://lestoy.com/love/icones/back.svg")');
            nav.style.setProperty('--nav-icon-size', '18px');
          }
        }

        function updateUI() {
            const t = texts[state.lang];
            const ids = {
                'txt-view-order': t.view, 'txt-your-order': t.order,
                'txt-select-size': t.select,
                'txt-total': t.total, 'txt-remove': t.remove,
                'txt-confirm': t.confirm
            };
            for(let id in ids) { const el = document.getElementById(id); if(el) el.innerText = ids[id]; }
            document.getElementById('search-input').placeholder = t.searchPh;
            if (document.getElementById('view-home').classList.contains('active') && !state.isSearchMode) {
              state.scroll.home[state.lang] = window.scrollY || 0;
              renderHome(true);
            } else if (!state.isSearchMode) {
              if (document.getElementById('view-category').classList.contains('active') && state.currentCategoryId) {
                const y = window.scrollY || 0;
                renderCategory(state.currentCategoryId, { skipSaveHome: true, keepScrollY: y });
              }
            }
            const hint = state.lang === 'cn' ? 'search' : 'search';
            document.getElementById('search-input').setAttribute('enterkeyhint', hint);
            updateCartBar();
            if(document.getElementById('cart-modal').style.display === 'flex') openCartModal();
            refreshProductModalUI();
            updateTopButtonLabel();
        }

        function renderHome(restoreScroll = false) {
          const grid = document.getElementById('category-grid');
          grid.innerHTML = db.categories.map(c => {
              const key = `home-cat-${c.id}`;
              return `
                <div class="${__cardClass(key,'cat-card')}" data-reveal-key="${key}" onclick="renderCategory('${c.id}')">
                    <div class="cat-img-box"><img src="${c.img}" class="${__imgClass(c.img,'cat-img')}" ${__imgDataAttrs(c.img)} loading="lazy" alt=""></div>
                    <div class="cat-info">
                        <div class="cat-title">${c.title[state.lang]}</div>
                        <div class="cat-desc">${c.desc[state.lang]}</div>
                    </div>
                </div>
              `;
          }).join('');
          initCardFX(grid);
          const saved = state.scroll.home[state.lang] || 0;
          switchView('view-home', restoreScroll ? { scrollTop: saved } : {});
        }

        function renderCategory(id, opts = {}) {
          state.currentCategoryId = id;
          history.pushState({ view: 'category' }, '');
          if (!opts.skipSaveHome) { state.scroll.home[state.lang] = window.scrollY || window.pageYOffset || 0; }
          const items = db.items[id] || [];
          const container = document.getElementById('category-content');
          renderProductList(container, items, id);
          if (typeof opts.keepScrollY === 'number') { switchView('view-category', { scrollTop: opts.keepScrollY }); } else { switchView('view-category'); }
        }

        function renderProductList(container, items, catId) {
            container.innerHTML = `
                <div class="product-list">
                    ${items.map((item, idx) => {
                      const key = `prod-${item.id}`;
                      return `
                        <div class="${__cardClass(key,'prod-card')}" data-reveal-key="${key}">
                            <img src="${item.img}" class="${__imgClass(item.img,'prod-img')}" ${__imgDataAttrs(item.img)} loading="lazy" alt="">
                            <div class="prod-body">
                                <div class="prod-title">${item.title[state.lang] || item.title['en']}</div>
                                <div class="prod-desc">${item.desc[state.lang] || item.desc['en']}</div>
                                <div class="prod-footer">
                                    <button class="btn-action" onclick="openProductModal('${item._catId || catId}', ${item._idx !== undefined ? item._idx : idx})">
                                        ${texts[state.lang].more}
                                    </button>
                                </div>
                            </div>
                        </div>
                      `;
                    }).join('')}
                </div>
            `;
            initCardFX(container);
        }

        function switchView(viewId, opts = {}) {
          document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
          document.getElementById(viewId).classList.add('active');
          updateTopButtonLabel();
          if (opts.noScroll) return;
          const top = typeof opts.scrollTop === 'number' ? opts.scrollTop : 0;
          requestAnimationFrame(() => window.scrollTo(0, top));
        }

        function goBack() {
          const isHome = document.getElementById('view-home').classList.contains('active');
          if (isHome) return;
          if (state.isSearchMode) clearSearch();
          else renderHome(true);
        }

        function handleSearch() {
            const query = document.getElementById('search-input').value.trim().toLowerCase();
            document.getElementById('search-clear').style.display = query.length > 0 ? 'block' : 'none';
            if(query.length < 1) { if(state.isSearchMode) { state.isSearchMode = false; renderHome(); } return; }
            if (!state.isSearchMode) { history.pushState({ view: 'search' }, ''); }
            state.isSearchMode = true;
            let allItems = [];
            for(let cat in db.items) { db.items[cat].forEach((item, idx) => { item._catId = cat; item._idx = idx; allItems.push(item); }); }
            const lang = state.lang;
            let results = allItems.filter(item => {
                const t = (item.title[lang] || '').toLowerCase();
                const d = (item.desc[lang] || '').toLowerCase();
                return t.includes(query) || d.includes(query);
            });
            if(results.length === 0) {
                results = allItems.filter(item => {
                    return Object.values(item.title).some(v => v.toLowerCase().includes(query)) || Object.values(item.desc).some(v => v.toLowerCase().includes(query));
                });
            }
            const container = document.getElementById('category-content');
            if(results.length > 0) { renderProductList(container, results, null); } else { container.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">${texts[state.lang].noResult}</div>`; }
            switchView('view-category');
        }
        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-clear').style.display = 'none';
            state.isSearchMode = false;
            renderHome();
        }

        // ===== Lock body scroll =====
        let __lockedScrollY = 0;
        function lockBodyScroll(){
          if(document.body.classList.contains('modal-open')) return;
          __lockedScrollY = window.scrollY || window.pageYOffset || 0;
          document.body.style.top = `-${__lockedScrollY}px`;
          document.body.classList.add('modal-open');
        }
        function unlockBodyScroll(){
          if(!document.body.classList.contains('modal-open')) return;
          document.body.classList.remove('modal-open');
          document.body.style.top = '';
          window.scrollTo(0, __lockedScrollY);
        }
        function unlockBodyScrollIfNoModal(){
          const pm = document.getElementById('product-modal');
          const cm = document.getElementById('cart-modal');
          const lm = document.getElementById('legal-modal');
          const anyOpen = (pm && pm.style.display === 'flex') || (cm && cm.style.display === 'flex') || (lm && lm.style.display === 'flex');
          if(anyOpen) return;
          unlockBodyScroll();
        }

        // --- Product Modal Logic ---
        function getProductQtyMapFromCart(productId){
            const preset = {};
            for(const ci of state.cart){ if(ci.productId === productId){ preset[ci.variantId] = (preset[ci.variantId] || 0) + (Number(ci.qty) || 0); } }
            return preset;
        }
        function buildVariantQtyMap(item, preset){
            const m = {};
            (item.variants || []).forEach(v => { const q = preset && preset[v.id] !== undefined ? Number(preset[v.id]) : 0; m[v.id] = Math.max(0, isFinite(q) ? q : 0); });
            return m;
        }
        function renderVariantQtyList(){
            const item = state.modal.item;
            const vList = document.getElementById('variant-list');
            if(!item || !vList) return;
            vList.innerHTML = (item.variants || []).map(v => {
                const name = v.names[state.lang] || v.names['en'];
                const priceText = `‚Ç¨ ${Number(v.price).toFixed(2)}`;
                const q = state.modal.variantQty[v.id] || 0;
                return `
                <div class="v-item" data-vid="${v.id}">
                    <div class="v-left">
                        <span class="v-name">${name}</span>
                        <span class="v-subprice">${priceText}</span>
                    </div>
                    <div class="v-qty">
                        <div class="v-qty-btn" onclick="event.stopPropagation(); adjustVariantQty('${v.id}', -1)">-</div>
                        <span class="v-qty-val" id="v-qty-${v.id}">${q}</span>
                        <div class="v-qty-btn" onclick="event.stopPropagation(); adjustVariantQty('${v.id}', 1)">+</div>
                    </div>
                </div>
                `;
            }).join('');
        }
        function adjustVariantQty(variantId, delta){
            if(!state.modal || !state.modal.variantQty) return;
            const cur = Number(state.modal.variantQty[variantId]) || 0;
            let next = cur + delta;
            if(next < 0) next = 0;
            state.modal.variantQty[variantId] = next;
            const el = document.getElementById('v-qty-' + variantId);
            if(el) el.innerText = next;
            updateModalPrice();
        }
        function _formatCtaText(qty, amount){
          const a = `‚Ç¨${Number(amount).toFixed(2)}`; const dot = ' ¬∑ ';
          if(state.lang === 'cn') return `Ê∑ªÂä†${qty}${dot}${a}`;
          if(state.lang === 'pt') return `Adicionar ${qty}${dot}${a}`;
          return `Add ${qty}${dot}${a}`;
        }
        function refreshProductModalUI(){
            if(document.getElementById('product-modal').style.display !== 'flex') return;
            const item = state.modal.item;
            if(!item) return;
            document.getElementById('m-title').innerText = item.title[state.lang] || item.title['en'];
            document.getElementById('m-desc').innerText = item.desc[state.lang] || item.desc['en'];
            renderVariantQtyList();
            updateModalPrice();
        }
        function openProductModal(catId, itemIdx, editCartItem = null) {
            let item;
            let preset = {};
            if (editCartItem) {
                item = findItemById(editCartItem.productId);
                if(!item){ showToast(texts[state.lang].missing); return; }
                preset = getProductQtyMapFromCart(item.id);
                state.modal.editProductId = item.id;
            } else {
                item = db.items[catId][itemIdx];
                state.modal.editProductId = null;
            }
            state.modal.item = item;
            state.modal.variantQty = buildVariantQtyMap(item, preset);
            document.getElementById('m-img').src = item.img;
            document.getElementById('m-title').innerText = item.title[state.lang] || item.title['en'];
            document.getElementById('m-desc').innerText = item.desc[state.lang] || item.desc['en'];
            renderVariantQtyList();
            updateModalPrice();
            const modal = document.getElementById('product-modal');
            const shell = document.getElementById('modal-shell');
            lockBodyScroll();
            modal.style.display = 'flex';
            modal.style.opacity = 1;
            requestAnimationFrame(() => shell.classList.add('open'));
            history.pushState({ modal: true }, '');
        }
        function updateModalPrice() {
            const item = state.modal.item;
            if(!item) return;
            let totalQty = 0;
            let total = 0;
            (item.variants || []).forEach(v => {
              const q = Number(state.modal.variantQty && state.modal.variantQty[v.id]) || 0;
              totalQty += q;
              total += q * (Number(v.price) || 0);
            });
            const label = document.getElementById('txt-add-btn');
            if(label) label.innerText = _formatCtaText(totalQty, total);
            const btn = document.querySelector('#product-modal .btn-add-cart');
            if(btn){ btn.disabled = totalQty <= 0; btn.style.opacity = totalQty <= 0 ? 0.6 : 1; }
        }
        function _hideProductModal() {
          const modal = document.getElementById('product-modal');
          const shell = document.getElementById('modal-shell');
          shell.classList.remove('open');
          modal.style.opacity = 0;
          state.modal.editProductId = null;
          state.modal.variantQty = {};
          setTimeout(() => { modal.style.display = 'none'; unlockBodyScrollIfNoModal(); }, 300);
        }
        function closeModalDirect() { _hideProductModal(); }
        function closeModal(e) { if(e.target.id === 'product-modal') closeModalDirect(); }

        // --- Cart Logic ---
        function confirmAddToCart() {
            const item = state.modal.item;
            const qtyMap = state.modal.variantQty || {};
            if(!item) return;
            const isEdit = !!state.modal.editProductId;
            let picked = 0;
            for(const v of (item.variants || [])){ picked += (Number(qtyMap[v.id]) || 0); }
            if(picked <= 0){ showToast(state.lang === 'cn' ? 'ÂÖàÊù•ÁÇπÊï∞ÈáèÂëÄÔΩû' : (state.lang === 'pt' ? 'Escolha uma quantidade üôÇ' : 'Pick a qty üôÇ')); return; }
            if (isEdit) {
                for (const v of (item.variants || [])) {
                    const desired = Math.max(0, Number(qtyMap[v.id]) || 0);
                    const existing = state.cart.find(c => c.productId === item.id && c.variantId === v.id);
                    if (desired > 0) {
                        if (existing) existing.qty = desired;
                        else state.cart.push({ uid: String(Date.now() + Math.random()), productId: item.id, variantId: v.id, qty: desired });
                    } else {
                        if (existing) state.cart.splice(state.cart.indexOf(existing), 1);
                    }
                }
            } else {
                for (const v of (item.variants || [])) {
                    const addQty = Math.max(0, Number(qtyMap[v.id]) || 0);
                    if (addQty <= 0) continue;
                    const existing = state.cart.find(c => c.productId === item.id && c.variantId === v.id);
                    if (existing) existing.qty += addQty;
                    else state.cart.push({ uid: String(Date.now() + Math.random()), productId: item.id, variantId: v.id, qty: addQty });
                }
            }
            closeModalDirect();
            saveCart();
            updateCartBar();
            showToast(isEdit ? texts[state.lang].updated : texts[state.lang].added);
            if(document.getElementById('cart-modal').style.display === 'flex') openCartModal();
        }
        function updateCartBar() {
            let totalQty = 0;
            let totalPrice = 0;
            for(const ci of state.cart){
              totalQty += ci.qty;
              const r = resolveCartItem(ci);
              if(!r.missing) totalPrice += (r.price * r.qty);
            }
            const countEl = document.getElementById('cart-count');
            if(countEl) countEl.innerText = totalQty;
            const legacyTotalEl = document.getElementById('cart-bar-total');
            if(legacyTotalEl) legacyTotalEl.innerText = `‚Ç¨ ${totalPrice.toFixed(2)}`;
            const labelEl = document.getElementById('sticky-cart-label');
            if(labelEl){
              const view = texts[state.lang].view || 'View';
              labelEl.innerText = `${view}`;
            }
        }

        // Empty Cart Images (multi-language)
const EMPTY_CART_IMG = {
  en: "https://lestoy.com/necos/e_en.png",
  pt: "https://lestoy.com/necos/e_pt.png",
  cn: "https://lestoy.com/necos/e_cn.png"
};

function getEmptyCartHTML(){
  const lang = (state && state.lang) ? state.lang : 'en';
  const src = EMPTY_CART_IMG[lang] || EMPTY_CART_IMG.en;
  const alt = (texts && texts[lang] && texts[lang].empty) ? texts[lang].empty : 'Empty Cart';
  return `
    <div class="empty-state">
      <img src="${src}" alt="${alt}" loading="lazy">
    </div>
  `;
}

        function openCartModal() {
          const list = document.getElementById('cart-list');
          list.innerHTML = '';
          if (state.cart.length === 0) {
            list.innerHTML = getEmptyCartHTML();
          } else {
            state.cart.forEach((ci) => {
              const r = resolveCartItem(ci);
              const div = document.createElement('div');
              div.className = 'cart-item';
              div.onclick = (e) => {
                if (e.target.closest('.mini-btn')) return;
                if (r.missing) { showToast(texts[state.lang].missing); return; }
                openProductModal(null, null, ci);
              };
              const img = r.img || 'https://via.placeholder.com/140x140?text=%20';
              const title = r.title ? (r.title[state.lang] || r.title['en']) : texts[state.lang].missingTitle;
              const sku = r.variantNames ? (r.variantNames[state.lang] || r.variantNames['en']) : texts[state.lang].missingVariant;
              const lineTotal = (!r.missing && typeof r.price === 'number') ? (r.price * r.qty) : 0;
              const hintText = r.missing ? texts[state.lang].removeHintMissing : texts[state.lang].editHint;
              div.innerHTML = `
                <img src="${img}" class="cart-img">
                <div class="cart-info">
                  <div class="c-title">${title}</div>
                  <div class="c-sku">${sku}</div>
                  <div class="c-price">‚Ç¨ ${lineTotal.toFixed(2)}</div>
                </div>
                <div class="cart-actions">
                  <div class="mini-qty">
                    <div class="mini-btn" onclick="updateCartItemQty('${ci.uid}', -1)">-</div>
                    <span style="margin:0 5px;">${ci.qty}</span>
                    <div class="mini-btn" onclick="updateCartItemQty('${ci.uid}', 1)">+</div>
                  </div>
                  <div class="edit-hint">${hintText}</div>
                </div>
              `;
              list.appendChild(div);
            });
          }
          let total = 0;
          for (const ci of state.cart) { const r = resolveCartItem(ci); if (!r.missing) total += (r.price * r.qty); }
          document.getElementById('cart-modal-total').innerText = `‚Ç¨ ${total.toFixed(2)}`;
          const modal = document.getElementById('cart-modal');
          const shell = document.getElementById('cart-shell');
          lockBodyScroll();
          modal.style.display = 'flex';
          modal.style.opacity = 1;
          requestAnimationFrame(() => shell.classList.add('open'));
          history.pushState({ modal: true }, '');
        }
        function updateCartItemQty(uid, delta) {
            const item = state.cart.find(c => c.uid === uid);
            if(item) {
                item.qty += delta;
                if(item.qty <= 0) state.cart.splice(state.cart.indexOf(item), 1);
                saveCart();
                updateCartBar();
                openCartModal();
            }
        }
        function _hideCartModal() {
          const modal = document.getElementById('cart-modal');
          const shell = document.getElementById('cart-shell');
          shell.classList.remove('open');
          modal.style.opacity = 0;
          setTimeout(() => { modal.style.display = 'none'; unlockBodyScrollIfNoModal(); }, 300);
        }
        function closeCartDirect() { _hideCartModal(); }
        function closeCart(e) { if(e.target.id === 'cart-modal') closeCartDirect(); }
        
        function goToCheckout() {
    if (state.cart.length === 0) {
        showToast(texts[state.lang].empty || "Cart is empty");
        return;
    }

    // 1. ÂáÜÂ§áÊï∞ÊçÆÂåÖ (‰∏∞ÂØå‰∫ßÂìÅ‰ø°ÊÅØÔºåÊñπ‰æø‰∏ã‰∏™È°µÈù¢ÊòæÁ§∫)
    const checkoutPayload = state.cart.map(ci => {
        const r = resolveCartItem(ci);
        return {
            productId: ci.productId,
            variantId: ci.variantId,
            qty: ci.qty,
            // Ëé∑ÂèñÂΩìÂâçËØ≠Ë®ÄÁöÑÊ†áÈ¢òÔºåÂ¶ÇÊûúÊ≤°ÊúâÂ∞±ÂõûÈÄÄÂà∞Ëã±Êñá
            title: r.title ? (r.title[state.lang] || r.title['en']) : 'Unknown Item',
            variantName: r.variantNames ? (r.variantNames[state.lang] || r.variantNames['en']) : '',
            price: r.price, // Âçï‰ª∑ (Áî®‰∫éÂâçÁ´ØÂ±ïÁ§∫ÔºåÂêéÁ´Ø‰ºöÈáçÊñ∞Ê†°È™å)
            img: r.img
        };
    });

    // 2. Â≠òÂÖ• LocalStorage
    localStorage.setItem('neco_checkout_cart', JSON.stringify(checkoutPayload));

    // 3. Ë∑≥ËΩ¨
    window.location.href = 'checkout.html';
}




        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 1000);
        }

        // ==========================================
        // 5. Legal Modal Logic (Merged from necos.html)
        // ==========================================
        function fillLegalTexts(){
          const L = texts[state.lang];
          
          // Footer buttons
          const b1 = document.getElementById('footer-btn-legal');
          const b2 = document.getElementById('footer-btn-terms');
          const b3 = document.getElementById('footer-btn-returns');
          const b4 = document.getElementById('footer-btn-privacy');
          const b5 = document.getElementById('footer-btn-disputes');
          if (b1) b1.innerText = L.footerBtnLegal;
          if (b2) b2.innerText = L.footerBtnTerms;
          if (b3) b3.innerText = L.footerBtnReturns;
          if (b4) b4.innerText = L.footerBtnPrivacy;
          if (b5) b5.innerText = L.footerBtnDisputes;

          // Headings
          const ids = {
             'terms-h2-1': L.termsH2_1, 'terms-h2-2': L.termsH2_2, 'terms-h2-3': L.termsH2_3,
             'returns-h2-1': L.returnsH2_1, 'returns-h2-2': L.returnsH2_2,
             'privacy-h2-1': L.privacyH2_1, 'privacy-h2-2': L.privacyH2_2, 'privacy-h2-3': L.privacyH2_3, 'privacy-h2-4': L.privacyH2_4,
             'disputes-h2-1': L.disputesH2_1, 'disputes-h2-2': L.disputesH2_2,
             'legal-h2-scope': L.scopeH2, 'legal-h2-contacts': L.contactsH2,
             'legal-title': L.legalTitle
          };
          for(let k in ids) { const el = document.getElementById(k); if(el) el.innerText = ids[k]; }

          // Tabs
          document.querySelectorAll('.legal-tab').forEach(btn=>{
            const tab = btn.getAttribute('data-tab');
            btn.innerText = tab==='legal' ? L.tabLegal : tab==='terms' ? L.tabTerms : tab==='returns' ? L.tabReturns : tab==='privacy' ? L.tabPrivacy : tab==='disputes' ? L.tabDisputes : tab;
          });

          // Footer Note
          const y = new Date().getFullYear();
          const fy = document.getElementById('footer-year');
          if(fy) fy.innerText = y;
          const fn = document.getElementById('footer-note-text');
          if(fn) fn.innerText = (L.footerNote || '').replace('{year}', y);

          // Paragraphs & Ident
          const ident = document.getElementById('legal-kv-ident');
          if(ident){
            ident.innerHTML = `
              <div><b>${state.lang==='pt'?'Titular':'Owner'}:</b> ${safeText(LEGAL_INFO.ownerName)}</div>
              <div><b>${state.lang==='pt'?'Morada':'Address'}:</b> ${safeText(LEGAL_INFO.address)}</div>
              <div><b>${state.lang==='pt'?'Identifica√ß√£o Fiscal':'Tax ID'}:</b> ${safeText(LEGAL_INFO.taxId)}</div>
              <div><b>Email:</b> ${safeText(LEGAL_INFO.email)}</div>
              <div><b>${state.lang==='pt'?'Telefone':'Phone'}:</b> ${safeText(LEGAL_INFO.phone)}</div>
              <div><b>${state.lang==='pt'?'Hor√°rio':'Hours'}:</b> ${safeText(LEGAL_INFO.businessHours)}</div>
            `;
          }
          const pIds = {
            'legal-p-scope': L.scopeP, 'legal-p-contacts': L.contactsP,
            'terms-p-1': L.termsP1, 'terms-p-3': L.termsP3,
            'returns-muted': L.returnsMuted,
            'privacy-p-1': L.privacyP1, 'privacy-p-4': L.privacyP4,
            'disputes-p-1': L.disputesP1, 'disputes-p-2': L.disputesP2
          };
          for(let k in pIds) { const el = document.getElementById(k); if(el) el.innerText = pIds[k]; }

          // Lists
          const fillList = (id, arr) => {
             const ul = document.getElementById(id); if(!ul) return;
             ul.innerHTML = '';
             (arr||[]).forEach(x => {
                const li = document.createElement('li');
                li.innerText = x.replace('{deliveryArea}', safeText(LEGAL_INFO.deliveryArea))
                                .replace('{deliveryTime}', safeText(LEGAL_INFO.deliveryTime))
                                .replace('{deliveryFee}', safeText(LEGAL_INFO.deliveryFee));
                ul.appendChild(li);
             });
          };
          fillList('terms-list-2', L.termsList2);
          fillList('returns-list-1', L.returnsList1);
          fillList('returns-list-2', L.returnsList2);
          fillList('privacy-list-2', L.privacyList2);
          fillList('privacy-list-3', L.privacyList3);

          // ADR
          const adr = document.getElementById('legal-kv-adr');
          if(adr){
            adr.innerHTML = `
              <div><b>${state.lang==='pt'?'Entidade RAL':'ADR entity'}:</b> ${safeText(LEGAL_INFO.arbitrationEntity)}</div>
              <div><b>${state.lang==='pt'?'Website':'Website'}:</b> ${safeText(LEGAL_INFO.arbitrationWebsite)}</div>
              <div><b>ODR:</b> ${safeText(LEGAL_INFO.odrWebsite)}</div>
            `;
          }
        }

        function switchLegalTab(tab){
          __legalTab = tab;
          document.querySelectorAll('.legal-tab').forEach(b=>{ b.classList.toggle('active', b.getAttribute('data-tab')===tab); });
          document.querySelectorAll('.legal-section').forEach(sec=>{ sec.classList.remove('active'); });
          const sec = document.getElementById(`legal-section-${tab}`);
          if(sec) sec.classList.add('active');
        }

        function openLegalModal(tab='legal'){
          fillLegalTexts();
          switchLegalTab(tab);
          const modal = document.getElementById('legal-modal');
          const shell = document.getElementById('legal-shell');
          lockBodyScroll();
          modal.style.display = 'flex';
          modal.style.opacity = 1;
          requestAnimationFrame(()=> shell.classList.add('open'));
          history.pushState({ modal:true }, '');
        }

        function _hideLegalModal(){
          const modal = document.getElementById('legal-modal');
          const shell = document.getElementById('legal-shell');
          shell.classList.remove('open');
          modal.style.opacity = 0;
          setTimeout(()=>{ modal.style.display = 'none'; unlockBodyScrollIfNoModal(); }, 300);
        }
        function closeLegalDirect(){ _hideLegalModal(); }
        function closeLegalByOverlay(e){ if(e.target.id==='legal-modal') closeLegalDirect(); }

        // ===== ÊâãÊú∫ËøîÂõûÈîÆÊã¶Êà™ =====
        window.addEventListener('popstate', function (e) {
          const productModal = document.getElementById('product-modal');
          if (productModal.style.display === 'flex') { _hideProductModal(); return; }
          const cartModal = document.getElementById('cart-modal');
          if (cartModal.style.display === 'flex') { _hideCartModal(); return; }
          const legalModal = document.getElementById('legal-modal');
          if (legalModal && legalModal.style.display === 'flex') { _hideLegalModal(); return; }
          // Ê≤°ÊúâÂºπÁ™óÔºåÊâçÂÅöÈ°µÈù¢Á∫ßËøîÂõû
          const isHome = document.getElementById('view-home').classList.contains('active');
          if (!isHome) { goBack(); return; }
        });
        
        function bootApp(){
  // products.js ÂÖàÊõ¥Êñ∞ window.NECO_DBÔºåÁÑ∂ÂêéÊàë‰ª¨ÂêåÊ≠• db ÂºïÁî®ÔºåÂÜç init
  db = window.NECO_DB || db;
  init();
}

// Â¶ÇÊûúÊï∞ÊçÆÂ∑≤ÁªèÊúâ‰∫ÜÔºåÁõ¥Êé•ÂêØÂä®ÔºõÂê¶ÂàôÁ≠â products.js Âèë NECO_DB_READY
if (window.NECO_DB && window.NECO_DB.items && Object.keys(window.NECO_DB.items).length > 0) {
  bootApp();
} else {
  window.addEventListener("NECO_DB_READY", () => bootApp(), { once: true });
}

    </script>
</body>
</html>