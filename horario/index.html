<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>课程表</title>
  <link rel="icon" type="image/png" href="logo.png" />
<style>
  :root {
    --brand-blue: #0069df;
    --tab-blue: #0069df;
    --card-shadow: 0 4px 12px rgba(0,0,0,.08);
    --ongoing-bg: #e8f0fe;   /* 正在上课：浅蓝背景 */
    --ongoing-text: #0069df; /* 正在上课：蓝色文字 */
    --upcoming-bg: #f1f8e9;  /* 即将开始：浅绿背景 */
    --upcoming-text: #2e7d32;/* 即将开始：深绿文字 */
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "WenQuanYi Micro Hei", sans-serif;
    background: #f2f5f7;
    color: #222;
  }

  /* 顶部栏（居中） */
  .appbar {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--brand-blue);
    color: #fff;
    padding: 14px 16px 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,.18);
    display: flex;
    flex-direction: column;
    align-items: center;      /* 横向居中 */
    text-align: center;       /* 文本居中 */
  }
  .appbar h1 { margin: 0; font-size: 20px; letter-spacing: .5px; }
  .subline {
    font-size: 12px; opacity: .95; margin-top: 6px;
    display: flex; align-items: center; gap: 8px; justify-content: center; /* 居中 */
  }
  .dot { width: 6px; height: 6px; border-radius: 50%; background: #a8d0ff; display: inline-block; }

  /* 标签栏 */
  .tabs {
    display: grid; grid-template-columns: repeat(5, 1fr);
    background: #fff; border-bottom: 1px solid #e5e9ef;
  }
  .tab {
    text-align: center; padding: 10px 6px; font-size: 15px;
    color: #5f6b7a; border-bottom: 3px solid transparent; cursor: pointer; user-select: none;
  }
  .tab small { display: block; font-size: 11px; opacity: .7; }
  .tab.active { color: var(--tab-blue); border-bottom-color: var(--tab-blue); font-weight: 600; background: #f7faff; }

  /* 内容区与卡片 */
  /* 视口容器：允许垂直滚动，隐藏横向溢出，启用触控优化 */
  .page {
    padding: 0;                 /* padding 移到 slide-inner 上 */
    overflow-x: hidden;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    touch-action: pan-y;        /* 默认允许纵向滚动，我们手动处理横向 */
  }

  /* 横向滑动轨道 */
  .slides {
    display: flex;
    width: 100%;
    will-change: transform;
    transition: transform 280ms cubic-bezier(.22,.61,.36,1);
  }

  /* 单页（每页占满视口宽度） */
  .slide {
    flex: 0 0 100%;
  }

  /* 把原来 .page 的内边距挪到这里；同时负责居中排版 */
  .slide-inner {
    padding: 14px 12px 32px;
  }
  @media (min-width: 560px) {
    .slide-inner { max-width: 520px; margin: 0 auto; }
  }

  .card { background: #fff; border-radius: 12px; box-shadow: var(--card-shadow); padding: 14px 14px 12px; margin: 10px 4px; }
  .row { display: flex; align-items: baseline; justify-content: space-between; gap: 10px; }
  .title { font-size: 16px; font-weight: 700; line-height: 1.2; color: #24292f; }
  .room { font-weight: 700; color: #8a94a1; min-width: 54px; text-align: right; }
  .time { margin-top: 10px; font-size: 14px; color: #5f6b7a; }

  /* 正在上课高亮 */
  .card.ongoing { background: var(--ongoing-bg); border: 1px solid var(--ongoing-text); }
  .card.ongoing .title, .card.ongoing .time, .card.ongoing .room { color: var(--ongoing-text); }
  .badge { display: inline-block; font-size: 11px; padding: 2px 6px; border-radius: 999px; background: var(--ongoing-text); color: #fff; margin-left: 8px; }

  /* 即将开始（仅今日显示且仅一张卡） */
  .card.upcoming { background: var(--upcoming-bg); border: 1px dashed var(--upcoming-text); }
  .card.upcoming .title, .card.upcoming .time, .card.upcoming .room { color: var(--upcoming-text); }

  .empty { text-align: center; color: #6b7682; padding: 20px 12px 24px; font-size: 14px; }
</style>
</head>
<body>
  <div class="appbar">
    <h1>课程表</h1>
    <div class="subline">
    </div>
  </div>

  <!-- 标签栏 -->
  <div class="tabs" role="tablist" aria-label="工作日">
    <div class="tab" data-day="mon" role="tab" aria-selected="false">周一<small>Mon</small></div>
    <div class="tab" data-day="tue" role="tab" aria-selected="false">周二<small>Tue</small></div>
    <div class="tab" data-day="wed" role="tab" aria-selected="false">周三<small>Wed</small></div>
    <div class="tab" data-day="thu" role="tab" aria-selected="false">周四<small>Thu</small></div>
    <div class="tab" data-day="fri" role="tab" aria-selected="false">周五<small>Fri</small></div>
  </div>

  <!-- 内容区（横向滑动容器将由 JS 注入） -->
  <div id="page" class="page" role="tabpanel" aria-live="polite"></div>

<script>
/** 3/30 起（按里斯本本地时间显示：仍然是 08:30，不写 Z） */
const schedule = {
  mon: [
    { title: 'Cálculo Diferencial e Integral II', type: 'Teórico-Prática', room: 'GA1',   start: '08:30', end: '10:00' },
    { title: 'Probabilidade e Estatística',       type: 'Teórico-Prática', room: 'QA02.3', start: '13:00', end: '14:30' },
    { title: 'Probabilidade e Estatística',       type: 'Problemas',       room: 'V1.15',  start: '15:30', end: '16:30' },
    { title: 'Interacção Pessoa-Máquina',         type: 'Teórica',         room: 'GA1',    start: '16:30', end: '18:30' },
  ],

  tue: [
    { title: 'Teoria da Computação',              type: 'Problemas',       room: 'F3',     start: '14:00', end: '16:00' },
    { title: 'Teoria da Computação',              type: 'Teórica',         room: 'GA3',    start: '16:00', end: '18:00' },
  ],

  wed: [
    { title: 'Probabilidade e Estatística',       type: 'Teórico-Prática', room: 'QA02.1', start: '13:00', end: '14:30' },
  ],

  thu: [
    { title: 'Teoria da Computação',              type: 'Problemas',       room: 'E1',     start: '13:00', end: '15:00' },
    { title: 'Teoria da Computação',              type: 'Teórica',         room: 'GA3',    start: '15:00', end: '17:00' },
  ],

  fri: [
    { title: 'Cálculo Diferencial e Integral II', type: 'Teórico-Prática', room: 'GA1',    start: '08:30', end: '10:00' },
    { title: 'Cálculo Diferencial e Integral II', type: 'Problemas',       room: 'V1.07',  start: '10:00', end: '11:00' },
    { title: 'Interacção Pessoa-Máquina',         type: 'Laboratorial',    room: 'LAB 5',  start: '12:30', end: '15:30' },
    { title: 'Interacção Pessoa-Máquina',         type: 'Teórica',         room: 'GA1',    start: '16:00', end: '19:00' },
  ],
};
/* ======= 统一按葡萄牙里斯本时区判断 ======= */
const TZ = 'Europe/Lisbon';
function nowLisbon() { return new Date(new Date().toLocaleString('en-US', { timeZone: TZ })); }
function pad(n){ return n<10 ? '0'+n : ''+n; }
function hmToMinutes(hm){ const [h,m]=hm.split(':').map(Number); return h*60+m; }

/** getDay -> key & 有序数组（用于滑动索引） */
const DAY_ORDER = ['mon','tue','wed','thu','fri'];
const dayIndex = k => DAY_ORDER.indexOf(k);
const keyByIndex = i => DAY_ORDER[Math.min(DAY_ORDER.length-1, Math.max(0, i))];

function todayKeyLisbon(){
  const d = nowLisbon().getDay(); // 0-6 (Sun-Sat)
  const map = {1:'mon',2:'tue',3:'wed',4:'thu',5:'fri'};
  return map[d] || 'mon';
}

/** 只对“今天”返回一条需要高亮的项目（正在上课优先，否则下一节） */
function highlightForDay(dayKey){
  const todayKey = todayKeyLisbon();
  if (dayKey !== todayKey) return null;        // 不是今天 -> 不高亮
  const list = schedule[dayKey] || [];
  if (!list.length) return null;

  const now = nowLisbon();
  const nowM = now.getHours()*60 + now.getMinutes();

  // 1) 正在上课（若存在，仅取第一条）
  for (let i=0;i<list.length;i++){
    const s = hmToMinutes(list[i].start), e = hmToMinutes(list[i].end);
    if (nowM >= s && nowM < e) return { index: i, type: 'ongoing' };
  }
  // 2) 下一节课（仅今天）
  let idx = -1, bestDelta = Infinity;
  for (let i=0;i<list.length;i++){
    const s = hmToMinutes(list[i].start);
    if (s > nowM && (s - nowM) < bestDelta) { bestDelta = s - nowM; idx = i; }
  }
  return idx >= 0 ? { index: idx, type: 'upcoming' } : null;
}

// ======================= 新增代码 START =======================
/**
 * 获取本周周一到周五的日期
 * @returns {object} e.g. { mon: '11/04', tue: '11/05', ... }
 */
function getWeekDates() {
    const today = new Date();
    const dayOfWeek = today.getDay(); // 0=周日, 1=周一, ..., 6=周六

    // 计算到周一需要减去的天数。如果今天是周日(0)，则视为上周的最后一天，需减去6天。
    const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    
    const monday = new Date(today);
    monday.setDate(today.getDate() - daysToSubtract);

    const weekDates = {};
    const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri'];

    for (let i = 0; i < 5; i++) {
        const currentDate = new Date(monday);
        currentDate.setDate(monday.getDate() + i);

        const month = currentDate.getMonth() + 1; // 月份是从0开始的
        const date = currentDate.getDate();

        // 格式化为 MM/DD
        const formattedDate = `${String(month).padStart(2, '0')}/${String(date).padStart(2, '0')}`;
        weekDates[dayKeys[i]] = formattedDate;
    }
    return weekDates;
}

/**
 * 更新标签栏的日期显示
 */
function updateTabDates() {
    const dates = getWeekDates();
    document.querySelectorAll('.tab').forEach(tab => {
        const dayKey = tab.dataset.day;
        const dateString = dates[dayKey];
        if (dateString) {
            const smallEl = tab.querySelector('small');
            if (smallEl) {
                smallEl.textContent = dateString;
            }
        }
    });
}
// ======================= 新增代码 END =======================


/* =============== 滑动容器渲染 =============== */
let activeDayKey = null;          // 当前激活的标签（键）
let activeIndex = 0;              // 当前激活的滑动页（索引）
let slidesEl = null;              // 轨道
let pageEl = null;                // 视口（#page）
let lastTodayKey = null;          // 记录上一次“今天”的键
let lastMinuteSig = '';           // 上次分钟签名（仅用于判断是否需要刷新）

/** 渲染单天到对应 slide */
function renderSlide(dayKey, autoFocus=true){
  const slide = pageEl.querySelector(`.slide[data-day="${dayKey}"]`);
  if (!slide) return;
  const inner = slide.querySelector('.slide-inner');
  inner.innerHTML = '';

  const list = schedule[dayKey] || [];
  if (!list.length) {
    inner.innerHTML = '<div class="empty">这一天没有安排课程~</div>';
    return;
  }

  const mark = highlightForDay(dayKey);
  let scrollTarget = null;

  list.forEach((item, i) => {
    const card = document.createElement('div');
    card.className = 'card';
    if (mark && mark.index === i) card.classList.add(mark.type);

    const row = document.createElement('div');
    row.className = 'row';

    const title = document.createElement('div');
    title.className = 'title';
    title.textContent = `${item.title} : ${item.type}`;

    if (mark && mark.index === i && mark.type === 'ongoing') {
      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = '正在上课';
      title.appendChild(badge);
      scrollTarget = card;
    } else if (mark && mark.index === i && mark.type === 'upcoming') {
      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.style.background = 'transparent';
      badge.style.color = 'var(--upcoming-text)';
      badge.style.border = '1px solid var(--upcoming-text)';
      badge.textContent = '下一节课';
      title.appendChild(badge);
      scrollTarget = card;
    }

    const room = document.createElement('div');
    room.className = 'room';
    room.textContent = item.room;

    row.appendChild(title);
    row.appendChild(room);

    const time = document.createElement('div');
    time.className = 'time';
    time.textContent = `${item.start} - ${item.end}`;

    card.appendChild(row);
    card.appendChild(time);
    inner.appendChild(card);
  });

  if (autoFocus && scrollTarget) {
    setTimeout(() => scrollTarget.scrollIntoView({ behavior: 'smooth', block: 'center' }), 80);
  }
}

/** 初始构建 5 个 slide */
function buildSlides(){
  pageEl.innerHTML = ''; // 清空旧内容
  slidesEl = document.createElement('div');
  slidesEl.className = 'slides';
  pageEl.appendChild(slidesEl);

  DAY_ORDER.forEach(k => {
    const slide = document.createElement('section');
    slide.className = 'slide';
    slide.dataset.day = k;
    slide.setAttribute('role', 'tabpanel');
    slide.setAttribute('aria-hidden', 'true');

    const inner = document.createElement('div');
    inner.className = 'slide-inner';

    slide.appendChild(inner);
    slidesEl.appendChild(slide);

    renderSlide(k, false);
  });
}

/** 设置激活 tab + 滑动到对应页 */
function activateTab(dayKey, withAnim=true){
  activeDayKey = dayKey;
  activeIndex = dayIndex(dayKey);

  document.querySelectorAll('.tab').forEach(el => {
    const on = el.dataset.day === dayKey;
    el.classList.toggle('active', on);
    el.setAttribute('aria-selected', on ? 'true' : 'false');
  });

  // 更新 aria-hidden
  pageEl.querySelectorAll('.slide').forEach((el, i) => {
    el.setAttribute('aria-hidden', i === activeIndex ? 'false' : 'true');
  });

  // 平移动画（百分比，避免计算像素）
  if (!withAnim) slidesEl.style.transition = 'none';
  else slidesEl.style.transition = ''; // 使用 CSS 默认过渡

  slidesEl.style.transform = `translateX(${-activeIndex * 100}%)`;

  // 激活页重新算高亮，不滚动
  renderSlide(dayKey, false);
}

/* =============== 手势交互（安卓式滑动） =============== */
function installSwipe(){
  // 移动端：touch 事件；桌面端：mouse 事件
  let startX = 0, startY = 0, startT = 0;
  let dragging = false;
  let dx = 0;

  const thresholdRatio = 0.075;  // 超过视口 25% 即切换
  const velocityNeed = 0.5;     // 或速度超过 0.6 px/ms
  const getW = () => pageEl.clientWidth || 1;

  function onStart(clientX, clientY){
    startX = clientX; startY = clientY; startT = performance.now();
    dragging = false; dx = 0;
  }
  function onMove(clientX, clientY, rawEvent){
    const moveX = clientX - startX;
    const moveY = clientY - startY;
    if (!dragging) {
      if (Math.abs(moveX) > 8 && Math.abs(moveX) > Math.abs(moveY)) {
        dragging = true;
        slidesEl.style.transition = 'none';
      } else {
        return; // 还没判定为水平拖动
      }
    }
    dx = moveX;
    const percent = (-activeIndex * 100) + (dx / getW() * 100);
    slidesEl.style.transform = `translateX(${percent}%)`;
    // 防止拖动时页面（或父容器）跟着滚
    if (rawEvent && rawEvent.cancelable) rawEvent.preventDefault();
  }
  function onEnd(){
    if (!dragging) return;
    const dt = Math.max(1, performance.now() - startT);
    const v = Math.abs(dx) / dt; // px/ms
    const goPrev = dx > 0;
    const ratio = Math.abs(dx) / getW();

    let target = activeIndex;
    if (ratio > thresholdRatio || v > velocityNeed) {
      target = goPrev ? activeIndex - 1 : activeIndex + 1;
    }
    target = Math.max(0, Math.min(DAY_ORDER.length - 1, target));

    slidesEl.style.transition = ''; // 恢复过渡
    activeIndex = target;
    activateTab(keyByIndex(activeIndex), true);
  }

  // Touch
  pageEl.addEventListener('touchstart', (e) => {
    if (!e.touches || e.touches.length !== 1) return;
    const t = e.touches[0];
    onStart(t.clientX, t.clientY);
  }, {passive: true});
  pageEl.addEventListener('touchmove', (e) => {
    if (!e.touches || e.touches.length !== 1) return;
    const t = e.touches[0];
    onMove(t.clientX, t.clientY, e);
  }, {passive: false});
  pageEl.addEventListener('touchend', onEnd, {passive: true});
  pageEl.addEventListener('touchcancel', onEnd, {passive: true});

  // Mouse（桌面端）
  let mouseDown = false;
  pageEl.addEventListener('mousedown', (e) => {
    if (e.button !== 0) return;
    mouseDown = true;
    onStart(e.clientX, e.clientY);
  });
  window.addEventListener('mousemove', (e) => {
    if (!mouseDown) return;
    onMove(e.clientX, e.clientY, e);
  });
  window.addEventListener('mouseup', () => {
    if (!mouseDown) return;
    mouseDown = false;
    onEnd();
  });

  // 键盘左右切换（可选）
  window.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') {
      activateTab(keyByIndex(activeIndex - 1), true);
    } else if (e.key === 'ArrowRight') {
      activateTab(keyByIndex(activeIndex + 1), true);
    }
  });
}

/* =============== 时钟 & 动态刷新 =============== */
function startClock(){
  function tick(){
    const d = nowLisbon();
    const y = d.getFullYear(), mo = pad(d.getMonth()+1), da = pad(d.getDate());
    const minuteSig = `${y}-${mo}-${da} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    const todayKey = todayKeyLisbon();

    if (minuteSig !== lastMinuteSig) {
      lastMinuteSig = minuteSig;

      // 跨天：如果用户仍停留在“昨天的今天页”，就自动跟随到新的一天
      if (lastTodayKey && todayKey !== lastTodayKey && activeDayKey === lastTodayKey) {
        renderSlide(lastTodayKey, false);
        renderSlide(todayKey, false);
        activateTab(todayKey, true);
      } else if (activeDayKey === todayKey) {
        // 仍在今天页：刷新高亮，不自动滚动
        renderSlide(todayKey, false);
      } else {
        // 其他情况：当日 slide 的高亮可能变化，轻量刷新但不打扰用户
        renderSlide(todayKey, false);
      }
      lastTodayKey = todayKey;
    }
  }
  tick();
  setInterval(tick, 1000); // 秒级走时；状态按“分钟签名”变化时刷新
}

/** 初始化：构建滑动轨道 + 事件 + 打开今天 */
function init(){
  pageEl = document.getElementById('page');

  // ============== 修改点：在初始化时调用日期更新函数 ==============
  updateTabDates();

  // 构建滑动容器（5页）
  buildSlides();

  // 顶部 tab 点击
  document.querySelectorAll('.tab').forEach(el => {
    el.addEventListener('click', () => activateTab(el.dataset.day, true));
  });

  // 默认打开“今天”
  const t = todayKeyLisbon();
  lastTodayKey = t;
  activateTab(t, false); // 首次定位无需动画

  // 安装滑动手势
  installSwipe();

  // 启动时钟与自动刷新
  startClock();
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
