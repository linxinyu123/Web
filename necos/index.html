
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neco's Custom Cake</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- 1. ËÆæËÆ°Á≥ªÁªü --- */
        :root {
            --primary: #102940; /* Ê∑±Ëìù */
            --accent: #F4C04B; /* ËõãÈªÑ */
            --bg: #F5F5F7; /* Á±≥ÁôΩ */
            --white: #FFFFFF;
            --text-gray: #666666;
            --border: #F0F0F0;
            --radius-box: 20px;
            --radius-btn: 50px;
            --shadow: 0 8px 24px rgba(16, 41, 64, 0.08);
            --header-h: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, button, input, select, textarea {
            font-family: 'Nunito', sans-serif;
        }
        html {
          overflow-y: scroll;
        }
        body {
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding-top: var(--header-h);
            padding-bottom: 82px;
            overflow-x: hidden;
        }

        /* --- 2. Header --- */
        .smart-header {
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-h);
            background: var(--white); z-index: 900;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo-img { height: 54px; width: auto; }
        
        .lang-switch { display: flex; background: #F3F4F6; border-radius: 20px; padding: 3px; }
        .lang-btn {
            border: none; background: transparent; padding: 6px 10px;
            border-radius: 16px; font-size: 12px; font-weight: 800; color: #999;
            cursor: pointer; transition: all 0.2s;
        }
        .lang-btn.active { background: var(--accent); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* --- 3. Â∏ÉÂ±Ä --- */
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* [NEW] Â∏∏È©ªÊêúÁ¥¢Ê°Ü (Google Style) */
        .search-hero { margin-bottom: 30px; }
        .search-hero-inner {
            display: flex; align-items: center; gap: 12px;
            background: var(--white); border-radius: 18px;
            padding: 18px 18px;
            box-shadow: 0 8px 24px rgba(16, 41, 64, 0.08);
            transition: box-shadow 0.2s;
        }
        .search-hero-inner:focus-within { box-shadow: 0 8px 30px rgba(16, 41, 64, 0.15); }
        
      .search-icon {
        width: 20px;
        height: 20px;
        background-color: #999;

        -webkit-mask: url("https://lestoy.com/love/icones/search.svg") no-repeat center;
        -webkit-mask-size: contain;
        mask: url("https://lestoy.com/love/icones/search.svg") no-repeat center;
        mask-size: contain;

        display: inline-block;
      }
      .search-hero-inner:has(#search-input:not(:placeholder-shown)) .search-icon{
        background-color: var(--primary);
        color: var(--primary);
      }

      #search-input:placeholder-shown ~ .search-clear{
        opacity:0;
        pointer-events:none;
      }
         
        .search-input {
            flex: 1; border: none; outline: none; background: transparent;
            font-size: 16px; font-family: 'Nunito', sans-serif; font-weight: 600;
            color: var(--primary);
        }
        .search-input::placeholder { color: #999; }
        
        .search-clear { cursor: pointer; color:var(--primary); font-size: 18px; display: none; }
        input[type="search"]::-webkit-search-cancel-button {
          -webkit-appearance: none;
          appearance: none;
          display: none;
        }

        input[type="search"]::-webkit-search-decoration {
          -webkit-appearance: none;
        }

        /* --- 4. È¶ñÈ°µÂàÜÁ±ª --- */
        .category-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px;
        }
        .cat-card {
            background: var(--white); border-radius: var(--radius-box);
            overflow: hidden; box-shadow: var(--shadow);
            cursor: pointer; transition: transform 0.2s;
            display: flex; flex-direction: column;
        }
        .cat-card:active { transform: scale(0.98); }
        .cat-img-box { width: 100%; height: 200px; overflow: hidden; }
        .cat-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .cat-card:hover .cat-img { transform: scale(1.05); }
        .cat-info { padding: 20px; border-top: 1px solid var(--border); }
        .cat-title { font-size: 20px; font-weight: 900; margin: 0 0 6px 0; color: var(--primary); }
        .cat-desc { font-size: 14px; color: var(--text-gray); line-height: 1.4; }

        /* --- 5. ÂàóË°®È°µ --- */
        .back-nav {
          display: flex;
          align-items: center;
          gap: 12px;
          margin-bottom: 20px; 
        }

        .nav-title {
          font-size: 15px;
          font-weight: 600;
          color: #6e6e73;
          white-space: nowrap;
        }

        .btn-back {
            background: var(--white); border: 1px solid #E5E7EB;
            padding: 12px 24px 12px 18.5px; border-radius: var(--radius-btn);
            display: inline-flex; align-items: center; gap: 8px;
            font-weight: 800; font-size: 16px; color: var(--primary); cursor: pointer;
              color: var(--primary);
        }

        .back-nav {
          --nav-icon: url("https://i.ibb.co/Q3hkmW9x/IMG-20251219-145724.png");
          --nav-icon-size: 22px;
        }

        .back-icon {
          width: var(--nav-icon-size);
          height: var(--nav-icon-size);
          background-color: currentColor;

          -webkit-mask: var(--nav-icon) no-repeat center;
          -webkit-mask-size: contain;

          mask: var(--nav-icon) no-repeat center;
          mask-size: contain;

          display: inline-block;
        }

        .product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .prod-card {
            background: var(--white); border-radius: var(--radius-box); overflow: hidden;
            box-shadow: var(--shadow); display: flex; flex-direction: column;
        }
        .prod-img { width: 100%; height: 220px; object-fit: cover; }
        .prod-body { padding: 18px; flex: 1; display: flex; flex-direction: column; }
        .prod-title { font-size: 18px; font-weight: 800; margin: 0 0 8px 0; color: var(--primary); }
        .prod-desc { 
            font-size: 13px; color: var(--text-gray); line-height: 1.5;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            margin-bottom: 15px;
        }
        .prod-footer { margin-top: auto; display: flex; justify-content: flex-end; }
        .btn-action {
            background: var(--accent); color: var(--primary); border: none;
            padding: 10px 24px; border-radius: var(--radius-btn); font-weight: 800; font-size: 14px; cursor: pointer;
        }

        /* --- 6. ÂºπÁ™ó (Modal) --- */
        .modal-overlay, .cart-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            backdrop-filter: blur(0.5px); display: none; justify-content: center; align-items: flex-end;
            transition: opacity 0.3s; 
        }
        .cart-overlay { z-index: 2000; }
        .modal-overlay { z-index: 2100; }

        @media(min-width: 768px) {
            .modal-overlay, .cart-overlay { align-items: center; }
            .modal-shell, .cart-shell { max-width: 480px !important; border-radius: 24px !important; height: 85vh !important; }
        }

        .modal-shell, .cart-shell {
            background: var(--white); width: 100%; height: 91.25%;
            border-radius: 24px 24px 0 0; display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            transform: translateY(100%); 
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-shell.open, .cart-shell.open { transform: translateY(0); } 
        
        .cart-shell { background: #F5F7FA; }

        .close-btn {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255,255,255,0.9); width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer; z-index: 30;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .modal-scroll { flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: 20px; }
        .modal-hero-img { width: 100%; height: 280px; object-fit: cover; display: block; }
        .modal-content-box { padding: 24px; }
        .m-title { font-size: 24px; font-weight: 900; margin-bottom: 12px; color: var(--primary); }
        .m-desc { font-size: 15px; color: var(--text-gray); line-height: 1.6; margin-bottom: 30px; }

        .variant-section { border-top: 1px solid var(--border); padding-top: 20px; }
        .v-label { font-size: 13px; font-weight: 800; color: #999; margin-bottom: 15px; display: block; text-transform: uppercase; letter-spacing: 1px; }
        .v-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; border-bottom: 1px solid var(--border); cursor: pointer;
        }
        .v-radio {
            width: 22px; height: 22px; border: 2px solid #ddd; border-radius: 50%;
            margin-right: 12px; position: relative; flex-shrink: 0;
        }
        .v-item.selected .v-radio { border-color: var(--accent); background: var(--accent); }
        .v-item.selected .v-radio::after {
            content:''; position:absolute; width: 8px; height: 8px;
            background: var(--primary); border-radius: 50%;
            top:50%; left:50%; transform:translate(-50%, -50%);
        }
        .v-info { display: flex; align-items: center; }
        .v-text { font-weight: 700; font-size: 16px; color: var(--primary); }
        .v-price { font-weight: 800; font-size: 16px; color: var(--primary); }

        .modal-footer {
            padding: 25px 20px 25px 20px; background: var(--white);
            border-top: 0px solid var(--border); z-index: 20;
            display: flex; flex-direction: column; gap: 10px;
        }
        .qty-control {
            display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 10px;
        }
        .qty-btn {
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid #ddd;
            background: white; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .qty-val { font-size: 20px; font-weight: 800; width: 30px; text-align: center; }
        .btn-add-cart {
            width: 100%; background: var(--accent); color: var(--primary); border: none;
            padding: 17px 17px; border-radius: var(--radius-btn); font-size: 17px; font-weight: 900;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            box-shadow: 0 5px 15px rgba(244, 192, 75, 0.3);
        }

        .cart-header {
            padding: 14px 18px; background: white; text-align: center;
            font-weight: 900; font-size: 18px; border-bottom: 1px solid var(--border);
        }
        .cart-list { flex: 1; overflow-y: auto; padding: 16px; background: var(--bg);}
        .cart-item {
            background: white; border-radius: 16px; padding: 15px;
            display: flex; gap: 15px; margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); cursor: pointer;
        }
        .cart-img { width: 70px; height: 70px; border-radius: 12px; object-fit: cover; }
        .cart-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .c-title { font-weight: 800; font-size: 15px; margin-bottom: 4px; }
        .c-sku { font-size: 13px; color: #888; margin-bottom: 4px; }
        .c-price { font-weight: 800; font-size: 15px; color: var(--primary); }
        .cart-actions {
            display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 8px;
        }
        .mini-qty {
            background: #F3F4F6; border-radius: 8px; padding: 2px 8px;
            font-size: 13px; font-weight: 800; display: flex; align-items: center; gap: 8px;
        }
        .mini-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .edit-hint { font-size: 11px; color: #AAA; font-weight: 600; text-transform: uppercase; }

  .sticky-cart {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: var(--primary); color: white;
            padding: 15px 20px; border-radius: 50px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 8px 20px rgba(16, 41, 64, 0.3); z-index: 800;
            cursor: pointer; transition: all 0.2s;
        }
        .sticky-cart:active { transform: translateX(-50%) scale(0.96); }
        .badge { background: var(--accent); color: var(--primary); padding: 4px 10px; border-radius: 20px; font-weight: 800; font-size: 14px; margin-right: 10px; }

        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: white; padding: 16px 30px;
            border-radius: 30px; z-index: 3000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; font-weight: 700;
        }
        .btn-remove {
            width: 100%; border: 1px solid #FF6B6B; background: white; color: #FF6B6B;
            padding: 12px; border-radius: var(--radius-btn); font-weight: 800;
            margin-top: 10px; cursor: pointer;
        }

        /* [NEW] Variant rows with per-variant quantity */
        .v-item{
            cursor: default;
        }
        .v-left{ display:flex; flex-direction:column; gap:4px; }
        .v-name{ font-weight: 800; font-size: 16px; color: var(--primary); }
        .v-subprice{ font-weight: 800; font-size: 14px; color: var(--primary); opacity: 0.85; }
        .v-qty{
            display:flex; align-items:center; gap:10px;
            background:#F3F4F6; border-radius: 14px; padding: 6px 10px;
            font-weight: 900;
        }
        .v-qty-btn{
            width: 28px; height: 28px; border-radius: 12px;
            display:flex; align-items:center; justify-content:center;
            cursor:pointer; user-select:none;
        }
        .v-qty-val{
            min-width: 18px; text-align:center; font-weight: 900;
        }

        /* [NEW] Cart total row (below items, footer still single button) */
        .cart-total-row{
            padding: 18px 18px 0px 18px;
            background: white;
            border-top: 0px solid var(--border);
            display:flex;
            justify-content:space-between;
            align-items:center;
            font-weight: 900;
            font-size: 17px;
        }

        /* Make modal scroll feel roomier */
        .modal-scroll{ padding-bottom: 10px; }

    </style>
</head>
<body>

    <!-- Header -->
    <div class="smart-header">
        <div class="header-left">
            <img src="https://i.ibb.co/sJtMRwDB/IMG-20251219-091347.png" class="logo-img" alt="Neco's">
        </div>
        <div class="lang-switch">
            <button class="lang-btn" onclick="setLang('en')">EN</button>
            <button class="lang-btn" onclick="setLang('pt')">PT</button>
            <button class="lang-btn" onclick="setLang('cn')">CN</button>
        </div>
    </div>

    <div class="container">
        <!-- [NEW] Permanent Search Bar -->
        <div class="search-hero">
            <div class="back-nav">
              <button class="btn-back" onclick="goBack()">
                <span class="back-icon"></span>
                <span id="txt-back">Home</span>
              </button>
            </div>
            <div class="search-hero-inner">
                <span class="search-icon"></span>
                <input
                  type="search"
                  id="search-input"
                  class="search-input"
                  placeholder="Search..."
                  enterkeyhint="search"
                  oninput="handleSearch()"
                  onkeydown="onSearchKeyDown(event)"
                >
                <span class="search-clear" id="search-clear" onclick="clearSearch()">‚úï</span>
            </div>
        </div>

        <!-- 1. È¶ñÈ°µ (Home) -->
        <div id="view-home" class="view-section active">
            <div class="category-grid" id="category-grid">
                <!-- JS Inject -->
            </div>
            <div style="height: 60px;"></div>
        </div>

        <!-- 2. ÂàóË°®È°µ (Category / Search Results) -->
        <div id="view-category" class="view-section">
            <div id="category-content">
                <!-- JS Inject -->
            </div>
        </div>
    </div>

    <!-- 3. ‰∫ßÂìÅËØ¶ÊÉÖÂºπÁ™ó (Product Modal) -->
    <div class="modal-overlay" id="product-modal" onclick="closeModal(event)">
        <div class="modal-shell" id="modal-shell" onclick="event.stopPropagation()">
            <div class="close-btn" onclick="closeModalDirect()">‚úï</div>
            
            <div class="modal-scroll">
                <img src="" id="m-img" class="modal-hero-img">
                <div class="modal-content-box">
                    <div class="m-title" id="m-title">Title</div>
                    <div class="m-desc" id="m-desc">Desc</div>
                    <div class="variant-section">
                        <label class="v-label" id="txt-select-size">SELECT SIZE</label>
                        <div id="variant-list"></div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-add-cart" onclick="confirmAddToCart()">
                    <span id="txt-add-btn">Add 0 ‚Ç¨0.00</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 4. Ë¥≠Áâ©ËΩ¶ÂºπÁ™ó (Cart Modal) -->
    <div class="cart-overlay" id="cart-modal" onclick="closeCart(event)">
        <div class="cart-shell" id="cart-shell" onclick="event.stopPropagation()">
            <div class="cart-header">
                <span id="txt-your-order">Your Order</span>
                <div style="position:absolute; right:20px; top:20px; cursor:pointer;" onclick="closeCartDirect()">‚úï</div>
            </div>
            <div class="cart-list" id="cart-list"></div>
            <div class="cart-total-row">
                <span id="txt-total">Total</span>
                <span id="cart-modal-total">‚Ç¨ 0.00</span>
            </div>
            <div class="modal-footer">
                <button class="btn-add-cart" onclick="closeCartDirect()">
                    <span style="width:100%; text-align:center;" id="txt-confirm">Confirm</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 5. Â∫ïÈÉ®ÊÇ¨ÊµÆÊù° (Sticky Cart) -->
    <div class="sticky-cart" id="sticky-cart" onclick="openCartModal()">
        <div style="display:flex; align-items:center;">
            <span class="badge" id="cart-count">0</span>
            <span id="txt-view-order" style="font-weight:700;">View Order</span>
        </div>
        <div style="font-weight:800; font-size:18px;" id="cart-bar-total">‚Ç¨ 0.00</div>
    </div>

    <div id="toast" class="toast">Update Success!</div>

    <script>
        // ==========================================
        // 1. Êï∞ÊçÆ‰∏≠ÂøÉ
        // ==========================================
        const db = {
    categories: [
        { id: "classic", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-5a2f691a-f7d5-4d33-b3be-b84ecea1c831.jpeg", 
          title: { cn: "Ê∞∏ËøúÁöÑÁªèÂÖ∏", en: "Eternal Classic", pt: "Cl√°ssico Eterno" },
          desc: { cn: "ÈªëÊ£ÆÊûó / ÊèêÊãâÁ±≥Ëãè / Á∫¢‰∏ùÁªí", en: "Black Forest / Tiramisu / Red Velvet", pt: "Floresta Negra / Tiramisu" } },
        { id: "layer", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-0038becb-7292-4eea-93f7-9fa986281d21.jpeg", 
          title: { cn: "ÊãõÁâåÂçÉÂ±ÇËõãÁ≥ï", en: "Signature Layer Cake", pt: "Bolo de Mil Camadas" },
          desc: { cn: "ÊâãÂ∑•Âà∂‰ΩúÔºåÂ±ÇÂ±ÇÁæéÂë≥", en: "Handmade crepe layers", pt: "Camadas de crepe artesanais" } },
        { id: "naked", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-11f1f013-ffc3-4c14-a39e-af3edc99dab8.jpeg", 
          title: { cn: "ÂéüÁîüÊÄÅË£∏ËõãÁ≥ï", en: "Naked Fruit Cake", pt: "Bolo Nu" },
          desc: { cn: "Êñ∞È≤úÊ∞¥ÊûúÊê≠ÈÖçÈ¶ôËçâÊàöÈ£é", en: "Fresh fruits with vanilla chiffon", pt: "Frutas frescas com chiffon" } },
        { id: "cheese", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-e4e9d0e4-c631-4a71-bd6a-52caa7a42fd2.jpeg", 
          title: { cn: "ËäùÂ£´‰∏éÊÖïÊñØ", en: "Cheesecake & Mousse", pt: "Bolo de queijo e mousse" },
          desc: { cn: "Â§©ÁÑ∂È£üÊùêÔºåÊµìÈÉÅÂè£ÊÑü", en: "Natural ingredients", pt: "Ingredientes naturais" } },
        { id: "korean", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-153de66b-9952-45d1-9c9d-09d9b1015029.jpeg", 
          title: { cn: "Èü©ÂºèÂ•∂Ê≤πË∞ÉÂë≥", en: "Korean Style Cream", pt: "Estilo Coreano" },
          desc: { cn: "Ê∏ÖÊñ∞È£éÊ†ºÔºåÁã¨ÁâπË∞ÉÂë≥", en: "Fresh style, flavored cream", pt: "Estilo fresco" } },
        { id: "custom", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-0a61f906-d8d7-45b4-b0c2-c240d5b14e80.jpeg", 
          title: { cn: "ÈÄ†ÂûãÂÆöÂà∂ËõãÁ≥ï", en: "Custom Design Cake", pt: "Bolo Personalizado" },
          desc: { cn: "ÊúâË∂£Â§ñË°®ÔºåÂ•ΩÂêÉÂ•ΩÁé©", en: "Fun & Delicious", pt: "Divertido e delicioso" } }
    ],
    items: {
        "classic": [
            { id:"c1", img:"https://dyj6gt4964deb.cloudfront.net/images/crop-b267cf6d-fb4d-4d57-9351-8c69c59c54b2.jpeg",
              title:{ cn:"Á∫¢‰∏ùÁªí‰π≥ÈÖ™ËõãÁ≥ï", en:"Red Velvet Cheesecake", pt:"Cheesecake de Veludo Vermelho" },
              desc:{
                en:"1. Appearance: The bright red cake layer and the white cheese layer form a sharp contrast, which is very visually attractive and especially suitable for festivals and celebrations.\n2. Taste: Red velvet cake is soft and moist, and paired with the rich cheese layer, it has a delicate taste, sweet but not greasy.\n3. Flavor: Red velvet cake usually has a hint of cocoa aroma, and paired with the slightly sour cheese, the overall taste is richer.",
                pt:"1. Apar√™ncia: As camadas de bolo vermelho vivo contrastam nitidamente com as camadas de cream cheese branco, criando um efeito visual muito atraente, especialmente adequado para feriados e celebra√ß√µes.\n2. Textura: O bolo de veludo vermelho √© macio e √∫mido, combinado com as camadas ricas de cream cheese, resultando em uma textura delicada que √© doce, mas n√£o excessivamente.\n3. Sabor: O bolo de veludo vermelho geralmente tem um leve aroma de cacau, complementado pela leve acidez do cream cheese, tornando o sabor geral mais complexo e agrad√°vel.",
                cn:"1. Â§ñËßÇÔºö È≤úËâ≥ÁöÑÁ∫¢Ëâ≤ËõãÁ≥ïÂ±ÇÂíåÁôΩËâ≤‰π≥ÈÖ™Â±ÇÂΩ¢ÊàêÈ≤úÊòéÂØπÊØîÔºåËßÜËßâÊïàÊûúÈùûÂ∏∏Âê∏Âºï‰∫∫ÔºåÁâπÂà´ÈÄÇÂêàËäÇÊó•ÂíåÂ∫ÜÂÖ∏Âú∫Âêà„ÄÇ\n2. Âè£ÊÑüÔºö Á∫¢‰∏ùÁªíËõãÁ≥ïÊüîËΩØÊπøÊ∂¶ÔºåÊê≠ÈÖçÊµìÈÉÅÁöÑ‰π≥ÈÖ™Â±ÇÔºåÂè£ÊÑüÁªÜËÖªÔºåÁîúËÄå‰∏çËÖª„ÄÇ\n3. È£éÂë≥Ôºö Á∫¢‰∏ùÁªíËõãÁ≥ïÈÄöÂ∏∏Â∏¶Êúâ‰∏Ä‰∏ùÂèØÂèØÁöÑÈ¶ôÊ∞îÔºåÊê≠ÈÖç‰π≥ÈÖ™ÁöÑÂæÆÈÖ∏Ôºå‰ΩøÊï¥‰ΩìÂè£Âë≥Êõ¥Âä†‰∏∞ÂØå„ÄÇ"
              },
              variants:[
                { id:"v1", names:{ cn:"6Ëã±ÂØ∏", en:"6 inches", pt:"6 polegadas" }, price:42 },
                { id:"v2", names:{ cn:"8Ëã±ÂØ∏", en:"8 inches", pt:"8 polegadas" }, price:58 }
              ]
            },
            { id:"c2", img:"https://dyj6gt4964deb.cloudfront.net/images/crop-25ad3750-4ed7-4c4f-a2cc-2d99925374a6.jpeg",
              title:{ en:"Milk sauce black forest cake", cn:"Â•∂ÈÖ±ÈªëÊ£ÆÊûóËõãÁ≥ï", pt:"Bolo floresta negra com molho de leite" },
              desc:{
                en:"A very rich chocolate sponge cake, with white chocolate cream, dark chocolate cream, and dark rum-stained black cherries in the middle layer. The improved Chantilly cream has a rich milky aroma. It is a classic handmade cake boutique with a blue ribbon",
                cn:"ÈùûÂ∏∏ÊµìÈÉÅÁöÑÂ∑ßÂÖãÂäõÊµ∑ÁªµËõãÁ≥ïÔºåÂ§πÂ±ÇÂåÖÂê´ÁôΩÂ∑ßÂ•∂Ê≤π„ÄÅÈªëÂ∑ßÂ•∂Ê≤πÔºå‰ª•ÂèäÈªëÊúóÂßÜÈÖíÊ∏çÈªëÊ®±Ê°ÉÔºåÊîπËâØÁöÑÈ¶ôÁºáÂ•∂Ê≤πÂ•∂È¶ôÊµìÈÉÅÔºåÊòØ‰∏ÄÊ¨æËìùÂ∏¶ÁªèÂÖ∏ÊâãÂ∑•ËõãÁ≥ïÁ≤æÂìÅ",
                pt:"Um p√£o de l√≥ de chocolate muito rico com camadas de creme de chocolate branco, doce de leite de chocolate negro e cerejas pretas embebidas em rum escuro."
              },
              variants:[
                { id:"v1", names:{ en:"6 inches", cn:"6ÂØ∏", pt:"6 polegadas" }, price:40 },
                { id:"v2", names:{ en:"8 inches", cn:"8ÂØ∏", pt:"8 polegadas" }, price:55 }
              ]
            },
            { id:"c3", img:"https://dyj6gt4964deb.cloudfront.net/images/crop-6f9816fc-5d8f-436d-a97c-baea35005112.jpeg",
              title:{ pt:"Tiramisu Cl√°ssico", cn:"ÁªèÂÖ∏ÊèêÊãâÁ±≥Ëãè", en:"Classic Tiramisu" },
              desc:{
                pt:"Um bolo tiramisu italiano muito cl√°ssico, queijo mascarpone, bolachas, caf√© expresso l√≠quido, feito √† m√£o com ingredientes frescos.",
                cn:"ÈùûÂ∏∏ÁªèÂÖ∏ÁöÑÊÑèÂºèÊèêÊãâÁ±≥ËãèËõãÁ≥ïÔºåÈ©¨ÊñØÂç°ÂΩ≠ËäùÂ£´„ÄÅÊâãÊåáÈ•ºÂπ≤„ÄÅÊÑèÂºèÊµìÁº©ÂíñÂï°Ê∂≤ÔºåÊñ∞È≤úÈ£üÊùêÊâãÂ∑•Âà∂‰ΩúÔºåËõãÁ≥ï‰∏äÁöÑÊï¥‰ΩìË£ÖÈ•∞ÁªèËøáÊàë‰ª¨ÁöÑËõãÁ≥ïÂ∏àÁöÑÂàõ‰ΩúÔºåÊõ¥ÊòæÂæóÂîØÁæéÁ≤æËá¥",
                en:"Very classic Italian tiramisu cake, mascarpone cheese, ladyfingers, espresso liquid, handmade with fresh ingredients, the overall decoration on the cake is created by our baker, making it more beautiful and exquisite"
              },
              variants:[
                { id:"v1", names:{ pt:"6 polegadas", cn:"6ÂØ∏", en:"6 inches" }, price:38 },
                { id:"v2", names:{ pt:"8 polegadas", cn:"8ÂØ∏", en:"8 inches" }, price:49 }
              ]
            }
        ],
        "layer": [
            { id:"l1", img:"https://dyj6gt4964deb.cloudfront.net/images/38db952a-2ebb-4af1-b733-a223cede14f3.jpeg",
              title:{ cn:"Â∑ßÂÖãÂäõÂçÉÂ±ÇËõãÁ≥ï", en:"Chocolate Melaleuca Cake", pt:"Bolo De Melaleuca De Chocolate" },
              desc:{
                cn:"ÊµìÈÉÅÁöÑÂ∑ßÂÖãÂäõÂèØ‰∏ΩÈ•ºÔºåÂ§πÂ±Ç‰∏∫Â∑ßÂÖãÂäõÂ•∂Ê≤πÔºåÂÖ∂‰∏≠ËøòÊúâ‰∏ÄÂ±ÇÂ∑ßÂÖãÂäõÊÖïÊñØÔºåÂ¶ÇÊûú‰Ω†ÁÉ≠Áà±ÊµìÈÉÅÁöÑÂ∑ßÂÖãÂäõÈ£éÂë≥Ôºå‰∏ÄÂÆö‰∏çËÉΩÈîôËøá",
                en:"Rich chocolate crepe, sandwiched with chocolate cream and a layer of chocolate mousse. If you love rich chocolate flavor, you must not miss it.",
                pt:"Rico crepe de chocolate, prensado com creme de chocolate e uma camada de mousse de chocolate."
              },
              variants:[
                { id:"v1", names:{ cn:"4Ëã±ÂØ∏", en:"4 inches", pt:"4 polegadas" }, price:23 },
                { id:"v2", names:{ cn:"6Ëã±ÂØ∏", en:"6 inches", pt:"6 polegadas" }, price:38 },
                { id:"v3", names:{ cn:"8Ëã±ÂØ∏", en:"8 inches", pt:"8 polegadas" }, price:48 }
              ]
            }
        ],
        "custom": [
            { id:"u1", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-450495cd-b008-4019-9569-55546dc3f80b.jpeg",
              title: { cn: "ÊÉÖ‰æ£ÂÖîÂ≠êËõãÁ≥ï", en: "Couple Rabbit Cake", pt: "Bolo de Coelho Casal" },
              desc: { cn: "Âç°ÈÄöÂÖîÂ≠êÈ£éÊ†º„ÄÇÂèØÈÄâÂ∑ßÂÖãÂäõÔºåÊü†Ê™¨ÔºåÊäπËå∂Á≠âÂè£Âë≥„ÄÇ", en: "Cartoon style. Available in 4/6 inch.", pt: "Estilo cartoon. Tamanhos 4/6 pol." },
              variants: [ 
                  { id:"v1", names: { cn: "4Ëã±ÂØ∏", en: "4 inches", pt: "4 polegadas" }, price: 25 },
                  { id:"v2", names: { cn: "6Ëã±ÂØ∏", en: "6 inches", pt: "6 polegadas" }, price: 38 }
              ] }
        ]
    }
};


        let state = {
          lang: 'en',
          isSearchMode: false,
          cart: [], // ‚úÖ Âè™Â≠ò { uid, productId, variantId, qty }
          modal: { item: null, variant: null, qty: 1, editUid: null, editProductId: null, variantQty: {} },
          scroll: { home: { en: 0, pt: 0, cn: 0 } },
          currentCategoryId: null
        };

        // ==========================================
        // 2. Cart persistence (ID ÂØπË¥¶ÊñπÊ°à)
        // ==========================================
        const CART_KEY = 'neco_cart_v2';

        function _isValidCartItem(it){
          return it && typeof it === 'object'
            && typeof it.uid === 'string'
            && typeof it.productId === 'string'
            && typeof it.variantId === 'string'
            && typeof it.qty === 'number';
        }

        function saveCart(){
          try{
            const data = state.cart.map(it => ({
              uid: it.uid,
              productId: it.productId,
              variantId: it.variantId,
              qty: it.qty
            }));
            localStorage.setItem(CART_KEY, JSON.stringify({
              v: 2,
              updatedAt: Date.now(),
              cart: data
            }));
          }catch(e){
            console.warn('saveCart failed', e);
          }
        }

        function loadCart(){
          try{
            const raw = localStorage.getItem(CART_KEY);
            if(!raw) return;
            const obj = JSON.parse(raw);
            const arr = (obj && obj.cart) ? obj.cart : obj;
            if(!Array.isArray(arr)) return;

            state.cart = arr
              .filter(_isValidCartItem)
              .map(it => ({
                uid: it.uid,
                productId: it.productId,
                variantId: it.variantId,
                qty: Math.max(1, Number(it.qty) || 1)
              }));
          }catch(e){
            console.warn('loadCart failed', e);
          }
        }

        // ‚úÖ ‰ªéÊúÄÊñ∞ db Èáå‚ÄúÂØπË¥¶/Ëß£Êûê‚ÄùË¥≠Áâ©ËΩ¶Êù°ÁõÆ
        function findItemById(productId){
          for(const cat in db.items){
            const hit = (db.items[cat] || []).find(p => p.id === productId);
            if(hit) return hit;
          }
          return null;
        }

        function resolveCartItem(ci){
          const item = findItemById(ci.productId);
          if(!item){
            return {
              missing: true,
              uid: ci.uid,
              qty: ci.qty,
              productId: ci.productId,
              variantId: ci.variantId
            };
          }
          const variant = (item.variants || []).find(v => v.id === ci.variantId);
          if(!variant){
            return {
              missing: true,
              uid: ci.uid,
              qty: ci.qty,
              productId: ci.productId,
              variantId: ci.variantId,
              img: item.img,
              title: item.title
            };
          }
          return {
            missing: false,
            uid: ci.uid,
            qty: ci.qty,
            productId: ci.productId,
            variantId: ci.variantId,
            img: item.img,
            title: item.title,
            variantNames: variant.names,
            price: variant.price,
            _item: item,
            _variant: variant
          };
        }

        // ==========================================
        // 3. Â§öËØ≠Ë®ÄÊñáÊ°à
        // ==========================================
  const texts = {
  cn: { 
    back: "ËøîÂõûÂàÜÁ±ª", homeTitle: "‰∏ªÈ°µ", select: "ÈÄâÊã©ËßÑÊ†º", add: "Âä†ÂÖ•ËÆ¢Âçï", update: "Êõ¥Êñ∞ËÆ¢Âçï", 
    view: "Êü•ÁúãËÆ¢Âçï", more: "Êü•ÁúãËØ¶ÊÉÖ", order: "ÊàëÁöÑËÆ¢Âçï", total: "ÊÄªËÆ°", 
    confirm: "Á°ÆËÆ§‰∏ãÂçï", remove: "ÁßªÈô§Ê≠§ÂïÜÂìÅ", empty: "Ë¥≠Áâ©ËΩ¶‰∏∫Á©∫", 
    added: "Â∑≤Âä†ÂÖ•ËÆ¢Âçï", updated: "ËÆ¢ÂçïÂ∑≤Êõ¥Êñ∞", editHint: "ÁÇπÂáªÁºñËæë", 
    searchPh: "ÊêúÁ¥¢ËõãÁ≥ï...", noResult: "Êú™ÊâæÂà∞Áõ∏ÂÖ≥ÂïÜÂìÅ", fallback: "ÂΩìÂâçËØ≠Ë®ÄÊó†ÁªìÊûúÔºåÂ∑≤Â±ïÁ§∫ÂÖ∂‰ªñËØ≠Ë®ÄÂåπÈÖç„ÄÇ",
    missing: "ËØ•ÂïÜÂìÅÂ∑≤‰∏ãÊû∂ÊàñËßÑÊ†ºÂ∑≤ÂèòÊõ¥ÔºåËØ∑ÁßªÈô§ÂêéÈáçÊñ∞ÈÄâÊã©„ÄÇ",
    missingTitle: "Â∑≤‰∏ãÊû∂ÂïÜÂìÅ",
    missingVariant: "ËßÑÊ†º‰∏çÂèØÁî®",
    removeHintMissing: "ËØ∑ÁßªÈô§"
  },
  en: { 
    back: "Back", homeTitle: "Home", select: "Select Size", add: "Add to Order", update: "Update Order", 
    view: "View Order", more: "More Info", order: "Your Order", total: "Total", 
    confirm: "Confirm", remove: "Remove Item", empty: "Empty Cart", 
    added: "Added to Order", updated: "Order Updated", editHint: "Edit item",
    searchPh: "Search cakes...", noResult: "No results found", fallback: "No results in English, showing matches from other languages.",
    missing: "Item unavailable (menu updated). Please remove and re-add.",
    missingTitle: "Unavailable item",
    missingVariant: "Variant unavailable",
    removeHintMissing: "REMOVE"
  },
  pt: { 
    back: "Voltar", homeTitle: "In√≠cio", select: "Selecione o Tamanho", add: "Adicionar", update: "Atualizar", 
    view: "Ver Pedido", more: "Mais Info", order: "Seu Pedido", total: "Total", 
    confirm: "Confirmar", remove: "Remover Item", empty: "Carrinho Vazio", 
    added: "Adicionado", updated: "Atualizado", editHint: "Editar item",
    searchPh: "Pesquisar bolos...", noResult: "Nenhum resultado", fallback: "Sem resultados em Portugu√™s, a mostrar outras l√≠nguas.",
    missing: "Item indispon√≠vel (menu atualizado). Remova e adicione novamente.",
    missingTitle: "Item indispon√≠vel",
    missingVariant: "Variante indispon√≠vel",
    removeHintMissing: "REMOVER"
  }
};

        init();

        function init() {
          loadCart();
          setLang('en');
          updateCartBar();
        }

        function setLang(l) {
            state.lang = l;
            document.querySelectorAll('.lang-btn').forEach(b => {
                b.classList.toggle('active', b.innerText.toLowerCase() === l);
            });
            updateUI();
            if(state.isSearchMode) handleSearch();
        }

        function onSearchKeyDown(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const input = e.target;
            input.blur();
            handleSearch();
          }
        }

        function updateTopButtonLabel() {
          const isHome = document.getElementById('view-home').classList.contains('active');
          const t = texts[state.lang];

          const txt = document.getElementById('txt-back');
          if (txt) txt.innerText = isHome ? t.homeTitle : t.back;

          const nav = document.querySelector('.back-nav');
          if (!nav) return;

          if (isHome) {
            nav.style.setProperty('--nav-icon', 'url("https://i.ibb.co/kVS4zpC5/IMG-20251219-152124.png")');
            nav.style.setProperty('--nav-icon-size', '22.5px');
          } else {
            nav.style.setProperty('--nav-icon', 'url("https://lestoy.com/love/icones/back.svg")');
            nav.style.setProperty('--nav-icon-size', '18px');
          }
        }

        function updateUI() {
            const t = texts[state.lang];
            const ids = {
                'txt-view-order': t.view, 'txt-your-order': t.order,
                'txt-select-size': t.select,
                'txt-total': t.total, 'txt-remove': t.remove
            };
            for(let id in ids) {
                const el = document.getElementById(id);
                if(el) el.innerText = ids[id];
            }
            document.getElementById('search-input').placeholder = t.searchPh;

            if (document.getElementById('view-home').classList.contains('active') && !state.isSearchMode) {
              state.scroll.home[state.lang] = window.scrollY || 0;
              renderHome(true);
            } else if (!state.isSearchMode) {
              if (document.getElementById('view-category').classList.contains('active') && state.currentCategoryId) {
                const y = window.scrollY || 0;
                renderCategory(state.currentCategoryId, { skipSaveHome: true, keepScrollY: y });
              }
            }

            const hint = state.lang === 'cn' ? 'search' : 'search';
            document.getElementById('search-input').setAttribute('enterkeyhint', hint);

            updateCartBar();
            if(document.getElementById('cart-modal').style.display === 'flex') openCartModal();
            refreshProductModalUI();
            updateTopButtonLabel();
        }

        function renderHome(restoreScroll = false) {
          const grid = document.getElementById('category-grid');
          grid.innerHTML = db.categories.map(c => `
              <div class="cat-card" onclick="renderCategory('${c.id}')">
                  <div class="cat-img-box"><img src="${c.img}" class="cat-img" loading="lazy"></div>
                  <div class="cat-info">
                      <div class="cat-title">${c.title[state.lang]}</div>
                      <div class="cat-desc">${c.desc[state.lang]}</div>
                  </div>
              </div>
          `).join('');

          const saved = state.scroll.home[state.lang] || 0;
          switchView('view-home', restoreScroll ? { scrollTop: saved } : {});
        }

        function renderCategory(id, opts = {}) {
          state.currentCategoryId = id;
          history.pushState({ view: 'category' }, '');

          if (!opts.skipSaveHome) {
            state.scroll.home[state.lang] = window.scrollY || window.pageYOffset || 0;
          }

          const items = db.items[id] || [];
          const container = document.getElementById('category-content');
          renderProductList(container, items, id);

          if (typeof opts.keepScrollY === 'number') {
            switchView('view-category', { scrollTop: opts.keepScrollY });
          } else {
            switchView('view-category');
          }
        }

        function renderProductList(container, items, catId) {
            container.innerHTML = `
                <div class="product-list">
                    ${items.map((item, idx) => `
                        <div class="prod-card">
                            <img src="${item.img}" class="prod-img" loading="lazy">
                            <div class="prod-body">
                                <div class="prod-title">${item.title[state.lang] || item.title['en']}</div>
                                <div class="prod-desc">${item.desc[state.lang] || item.desc['en']}</div>
                                <div class="prod-footer">
                                    <button class="btn-action" onclick="openProductModal('${item._catId || catId}', ${item._idx !== undefined ? item._idx : idx})">
                                        ${texts[state.lang].more}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function switchView(viewId, opts = {}) {
          document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
          document.getElementById(viewId).classList.add('active');
          updateTopButtonLabel();

          if (opts.noScroll) return;

          const top = typeof opts.scrollTop === 'number' ? opts.scrollTop : 0;
          requestAnimationFrame(() => window.scrollTo(0, top));
        }

        function goBack() {
          const isHome = document.getElementById('view-home').classList.contains('active');
          if (isHome) return;

          if (state.isSearchMode) clearSearch();
          else renderHome(true);
        }

        // --- Search Logic ---
        function handleSearch() {
            const query = document.getElementById('search-input').value.trim().toLowerCase();
            document.getElementById('search-clear').style.display = query.length > 0 ? 'block' : 'none';

            if(query.length < 1) {
                if(state.isSearchMode) {
                    state.isSearchMode = false;
                    renderHome();
                }
                return;
            }
            if (!state.isSearchMode) {
              history.pushState({ view: 'search' }, '');
            }
            state.isSearchMode = true;
            
            let allItems = [];
            for(let cat in db.items) {
                db.items[cat].forEach((item, idx) => {
                    item._catId = cat; item._idx = idx;
                    allItems.push(item);
                });
            }

            const lang = state.lang;
            let results = allItems.filter(item => {
                const t = (item.title[lang] || '').toLowerCase();
                const d = (item.desc[lang] || '').toLowerCase();
                return t.includes(query) || d.includes(query);
            });

            if(results.length === 0) {
                results = allItems.filter(item => {
                    return Object.values(item.title).some(v => v.toLowerCase().includes(query)) ||
                           Object.values(item.desc).some(v => v.toLowerCase().includes(query));
                });
            }

            const container = document.getElementById('category-content');
            if(results.length > 0) {
                renderProductList(container, results, null);
            } else {
                container.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">${texts[state.lang].noResult}</div>`;
            }
            
            switchView('view-category');
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-clear').style.display = 'none';
            state.isSearchMode = false;
            renderHome();
        }
        
        // --- Modal Logic ---

        function getProductQtyMapFromCart(productId){
            const preset = {};
            for(const ci of state.cart){
              if(ci.productId === productId){
                preset[ci.variantId] = (preset[ci.variantId] || 0) + (Number(ci.qty) || 0);
              }
            }
            return preset;
        }

        function buildVariantQtyMap(item, preset){
            const m = {};
            (item.variants || []).forEach(v => {
              const q = preset && preset[v.id] !== undefined ? Number(preset[v.id]) : 0;
              m[v.id] = Math.max(0, isFinite(q) ? q : 0);
            });
            return m;
        }

        function renderVariantQtyList(){
            const item = state.modal.item;
            const vList = document.getElementById('variant-list');
            if(!item || !vList) return;

            vList.innerHTML = (item.variants || []).map(v => {
                const name = v.names[state.lang] || v.names['en'];
                const priceText = `‚Ç¨ ${Number(v.price).toFixed(2)}`;
                const q = state.modal.variantQty[v.id] || 0;
                return `
                <div class="v-item" data-vid="${v.id}">
                    <div class="v-left">
                        <span class="v-name">${name}</span>
                        <span class="v-subprice">${priceText}</span>
                    </div>
                    <div class="v-qty">
                        <div class="v-qty-btn" onclick="event.stopPropagation(); adjustVariantQty('${v.id}', -1)">-</div>
                        <span class="v-qty-val" id="v-qty-${v.id}">${q}</span>
                        <div class="v-qty-btn" onclick="event.stopPropagation(); adjustVariantQty('${v.id}', 1)">+</div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function adjustVariantQty(variantId, delta){
            if(!state.modal || !state.modal.variantQty) return;
            const cur = Number(state.modal.variantQty[variantId]) || 0;
            let next = cur + delta;
            if(next < 0) next = 0;
            state.modal.variantQty[variantId] = next;

            const el = document.getElementById('v-qty-' + variantId);
            if(el) el.innerText = next;

            updateModalPrice();
        }

        function _getCtaVerb(){
            if(state.lang === 'cn') return 'Ê∑ªÂä†';
            if(state.lang === 'pt') return 'Adicionar';
            return 'Add';
        }

        function _formatCtaText(qty, amount){
  const a = `‚Ç¨${Number(amount).toFixed(2)}`;
  const dot = ' ¬∑ ';
  if(state.lang === 'cn') return `Ê∑ªÂä†${qty}${dot}${a}`;
  if(state.lang === 'pt') return `Adicionar ${qty}${dot}${a}`;
  return `Add ${qty}${dot}${a}`;
}

function _formatConfirmText(qty, amount){
  const a = `‚Ç¨${Number(amount).toFixed(2)}`;
  const dot = ' ¬∑ ';
  let base = 'Confirm';
  if(state.lang === 'cn') base = '‰∏ãÂçï';
  else if(state.lang === 'pt') base = 'Confirmar';

  if(state.lang === 'cn') return `${base}${qty}${dot}${a}`;
  return `${base} ${qty}${dot}${a}`;
}       

        function refreshProductModalUI(){
            if(document.getElementById('product-modal').style.display !== 'flex') return;
            const item = state.modal.item;
            if(!item) return;
            document.getElementById('m-title').innerText = item.title[state.lang] || item.title['en'];
            document.getElementById('m-desc').innerText = item.desc[state.lang] || item.desc['en'];
            renderVariantQtyList();
            updateModalPrice();
        }

function openProductModal(catId, itemIdx, editCartItem = null) {
            let item;
            let preset = {};

            if (editCartItem) {
                // ‚úÖ Êåâ productId / variantId ÂØπË¥¶
                item = findItemById(editCartItem.productId);
                if(!item){
                  showToast(texts[state.lang].missing);
                  return;
                }
                preset = getProductQtyMapFromCart(item.id);
                state.modal.editProductId = item.id;
            } else {
                item = db.items[catId][itemIdx];
                state.modal.editProductId = null;
            }

            state.modal.item = item;
            state.modal.variantQty = buildVariantQtyMap(item, preset);

            document.getElementById('m-img').src = item.img;
            document.getElementById('m-title').innerText = item.title[state.lang] || item.title['en'];
            document.getElementById('m-desc').innerText = item.desc[state.lang] || item.desc['en'];

            renderVariantQtyList();
            updateModalPrice();
            
            const modal = document.getElementById('product-modal');
            const shell = document.getElementById('modal-shell');
            modal.style.display = 'flex';
            modal.style.opacity = 1;
            requestAnimationFrame(() => shell.classList.add('open'));
            history.pushState({ modal: true }, '');
        }

        function selectVariant(idx) { /* legacy (no-op) */ }


        function adjustQty(delta) {
            let newQty = state.modal.qty + delta;
            if (newQty < 1) newQty = 1;
            state.modal.qty = newQty;
            const el = document.getElementById('m-qty');
            if(el) el.innerText = newQty;
            updateModalPrice();
        }

        function updateModalPrice() {
            const item = state.modal.item;
            if(!item) return;

            let totalQty = 0;
            let total = 0;
            (item.variants || []).forEach(v => {
              const q = Number(state.modal.variantQty && state.modal.variantQty[v.id]) || 0;
              totalQty += q;
              total += q * (Number(v.price) || 0);
            });

            const label = document.getElementById('txt-add-btn');
            if(label) label.innerText = _formatCtaText(totalQty, total);

            const btn = document.querySelector('#product-modal .btn-add-cart');
            if(btn){
              btn.disabled = totalQty <= 0;
              btn.style.opacity = totalQty <= 0 ? 0.6 : 1;
            }
        }

        function closeModalDirect() {
            const modal = document.getElementById('product-modal');
            const shell = document.getElementById('modal-shell');
            shell.classList.remove('open');
            modal.style.opacity = 0;
            state.modal.editProductId = null;
            state.modal.variantQty = {};
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }
        function closeModal(e) { if(e.target.id === 'product-modal') closeModalDirect(); }

        // --- Cart Logic (ID ÂØπË¥¶) ---
        function confirmAddToCart() {
            const item = state.modal.item;
            const qtyMap = state.modal.variantQty || {};
            if(!item) return;

            const isEdit = !!state.modal.editProductId;

            // ËÆ°ÁÆó‰∏Ä‰∏ãÊú¨Ê¨°ÈÄâÊã©ÁöÑÊÄªÊï∞/ÊÄª‰ª∑ÔºàÁî®‰∫é 0 ÁöÑÊÉÖÂÜµÔºâ
            let picked = 0;
            for(const v of (item.variants || [])){
              picked += (Number(qtyMap[v.id]) || 0);
            }
            if(picked <= 0){
              // ËΩªËΩªÊèêÈÜí‰∏Ä‰∏ãÂ∞±Â•Ω
              showToast(state.lang === 'cn' ? 'ÂÖàÊù•ÁÇπÊï∞ÈáèÂëÄÔΩû' : (state.lang === 'pt' ? 'Escolha uma quantidade üôÇ' : 'Pick a qty üôÇ'));
              return;
            }

            if (isEdit) {
                // ‚úÖ ÁºñËæëÔºöÊåâ‰∫ßÂìÅÁª¥Â∫¶‚ÄúË¶ÜÁõñ‚ÄùËØ•ÂïÜÂìÅÊâÄÊúâËßÑÊ†ºÁöÑÊï∞Èáè
                for (const v of (item.variants || [])) {
                    const desired = Math.max(0, Number(qtyMap[v.id]) || 0);
                    const existing = state.cart.find(c => c.productId === item.id && c.variantId === v.id);
                    if (desired > 0) {
                        if (existing) existing.qty = desired;
                        else state.cart.push({ uid: String(Date.now() + Math.random()), productId: item.id, variantId: v.id, qty: desired });
                    } else {
                        if (existing) state.cart.splice(state.cart.indexOf(existing), 1);
                    }
                }
            } else {
                // ‚úÖ Êñ∞Â¢ûÔºöÂú®Ë¥≠Áâ©ËΩ¶ÈáåÁ¥ØÂä†
                for (const v of (item.variants || [])) {
                    const addQty = Math.max(0, Number(qtyMap[v.id]) || 0);
                    if (addQty <= 0) continue;
                    const existing = state.cart.find(c => c.productId === item.id && c.variantId === v.id);
                    if (existing) existing.qty += addQty;
                    else state.cart.push({ uid: String(Date.now() + Math.random()), productId: item.id, variantId: v.id, qty: addQty });
                }
            }

            closeModalDirect();
            saveCart();
            updateCartBar();
            showToast(isEdit ? texts[state.lang].updated : texts[state.lang].added);
            if(document.getElementById('cart-modal').style.display === 'flex') openCartModal();
        }

        function removeCurrentItem() {
            const pid = state.modal && state.modal.item ? state.modal.item.id : null;
            if(!pid) return;
            state.cart = state.cart.filter(c => c.productId !== pid);
            saveCart();
            closeModalDirect();
            updateCartBar();
            if(document.getElementById('cart-modal').style.display === 'flex') openCartModal();
        }

        function updateCartBar() {
            let totalQty = 0;
            let totalPrice = 0;
            for(const ci of state.cart){
              totalQty += ci.qty;
              const r = resolveCartItem(ci);
              if(!r.missing) totalPrice += (r.price * r.qty);
            }

            const countEl = document.getElementById('cart-count');
            if(countEl) countEl.innerText = totalQty;

            const legacyTotalEl = document.getElementById('cart-bar-total');
            if(legacyTotalEl) legacyTotalEl.innerText = `‚Ç¨ ${totalPrice.toFixed(2)}`;

            const labelEl = document.getElementById('sticky-cart-label');
            if(labelEl){
              const view = texts[state.lang].view || 'View';
              labelEl.innerText = `${view} ${totalQty} ‚Ç¨${totalPrice.toFixed(2)}`;
            }
        }

        function openCartModal() {
  const list = document.getElementById('cart-list');
  list.innerHTML = '';

  if (state.cart.length === 0) {
    list.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">${texts[state.lang].empty}</div>`;
  } else {
    state.cart.forEach((ci) => {
      const r = resolveCartItem(ci);

      const div = document.createElement('div');
      div.className = 'cart-item';

      // ÁÇπÂáªÂç°ÁâáÔºöÊ≠£Â∏∏Êù°ÁõÆ -> ÁºñËæëÔºõmissing Êù°ÁõÆ -> ÊèêÁ§∫
      div.onclick = (e) => {
        if (e.target.closest('.mini-btn')) return;

        if (r.missing) {
          showToast(texts[state.lang].missing);
          return;
        }
        openProductModal(null, null, ci);
      };

      // Â§öËØ≠Ë®ÄÂÖúÂ∫ïÂ±ïÁ§∫Ôºà‰∏çÂÜç hardcodeÔºâ
      const img = r.img || 'https://via.placeholder.com/140x140?text=%20';
      const title = r.title
        ? (r.title[state.lang] || r.title['en'])
        : texts[state.lang].missingTitle;

      const sku = r.variantNames
        ? (r.variantNames[state.lang] || r.variantNames['en'])
        : texts[state.lang].missingVariant;

      const lineTotal = (!r.missing && typeof r.price === 'number')
        ? (r.price * r.qty)
        : 0;

      const hintText = r.missing
        ? texts[state.lang].removeHintMissing
        : texts[state.lang].editHint;

      div.innerHTML = `
        <img src="${img}" class="cart-img">
        <div class="cart-info">
          <div class="c-title">${title}</div>
          <div class="c-sku">${sku}</div>
          <div class="c-price">‚Ç¨ ${lineTotal.toFixed(2)}</div>
        </div>
        <div class="cart-actions">
          <div class="mini-qty">
            <div class="mini-btn" onclick="updateCartItemQty('${ci.uid}', -1)">-</div>
            <span style="margin:0 5px;">${ci.qty}</span>
            <div class="mini-btn" onclick="updateCartItemQty('${ci.uid}', 1)">+</div>
          </div>
          <div class="edit-hint">${hintText}</div>
        </div>
      `;
      list.appendChild(div);
    });
  }

  // ÊÄª‰ª∑ÔºöÂè™ÁªüËÆ°Êú™ missing ÁöÑ
  let total = 0;
  for (const ci of state.cart) {
    const r = resolveCartItem(ci);
    if (!r.missing) total += (r.price * r.qty);
  }
  document.getElementById('cart-modal-total').innerText = `‚Ç¨ ${total.toFixed(2)}`;

  let totalQty = 0;
  for (const ci of state.cart) totalQty += (Number(ci.qty) || 0);

  const modal = document.getElementById('cart-modal');
  const shell = document.getElementById('cart-shell');
  modal.style.display = 'flex';
  modal.style.opacity = 1;
  requestAnimationFrame(() => shell.classList.add('open'));
  history.pushState({ modal: true }, '');
}
        function updateCartItemQty(uid, delta) {
            const item = state.cart.find(c => c.uid === uid);
            if(item) {
                item.qty += delta;
                if(item.qty <= 0) state.cart.splice(state.cart.indexOf(item), 1);
                saveCart();
                updateCartBar();
                openCartModal(); 
            }
        }

        function closeCartDirect() {
            const modal = document.getElementById('cart-modal');
            const shell = document.getElementById('cart-shell');
            shell.classList.remove('open');
            modal.style.opacity = 0;
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }
        function closeCart(e) { if(e.target.id === 'cart-modal') closeCartDirect(); }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 1000);
        }

        // ===== ÊâãÊú∫ËøîÂõûÈîÆÊã¶Êà™ =====
        window.addEventListener('popstate', function () {
          const productModal = document.getElementById('product-modal');
          if (productModal.style.display === 'flex') {
            closeModalDirect();
            history.pushState({ modal: true }, '');
            return;
          }

          const cartModal = document.getElementById('cart-modal');
          if (cartModal.style.display === 'flex') {
            closeCartDirect();
            history.pushState({ modal: true }, '');
            return;
          }

          const isHome = document.getElementById('view-home').classList.contains('active');
          if (!isHome) {
            goBack();
            return;
          }
        });
    </script>
</body>
</html>
