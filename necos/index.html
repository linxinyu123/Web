<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neco's Custom Cake</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* --- 1. 设计系统 --- */
        :root {
            --primary: #102940; /* 深蓝 */
            --accent: #F4C04B; /* 蛋黄 */
            --bg: #F5F5F7; /* 米白 */
            --white: #FFFFFF;
            --text-gray: #666666;
            --border: #F0F0F0;
            --radius-box: 20px;
            --radius-btn: 50px;
            --shadow: 0 8px 24px rgba(16, 41, 64, 0.08);
            --header-h: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, button, input, select, textarea {
            font-family: 'Nunito', sans-serif;
        }
        html {
  overflow-y: scroll;  /* 不管内容够不够，都保留滚动条槽位 */
}
        body {
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding-top: var(--header-h);
            padding-bottom: 100px;
            overflow-x: hidden;
        }

        /* --- 2. Header --- */
        .smart-header {
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-h);
            background: var(--white); z-index: 900;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo-img { height: 54px; width: auto; }
        
        .lang-switch { display: flex; background: #F3F4F6; border-radius: 20px; padding: 3px; }
        .lang-btn {
            border: none; background: transparent; padding: 6px 10px;
            border-radius: 16px; font-size: 12px; font-weight: 800; color: #999;
            cursor: pointer; transition: all 0.2s;
        }
        .lang-btn.active { background: var(--accent); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* --- 3. 布局 --- */
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* [NEW] 常驻搜索框 (Google Style) */
        .search-hero { margin-bottom: 30px; }
        .search-hero-inner {
            display: flex; align-items: center; gap: 12px;
            background: var(--white); border-radius: 18px;
            padding: 18px 18px;
            box-shadow: 0 8px 24px rgba(16, 41, 64, 0.08);
            transition: box-shadow 0.2s;
        }
        .search-hero-inner:focus-within { box-shadow: 0 8px 30px rgba(16, 41, 64, 0.15); }
        
      .search-icon {
  width: 20px;
  height: 20px;
  background-color: #999; /* 默认灰 */

  -webkit-mask: url("https://lestoy.com/love/icones/search.svg") no-repeat center;
  -webkit-mask-size: contain;
  mask: url("https://lestoy.com/love/icones/search.svg") no-repeat center;
  mask-size: contain;

  display: inline-block;
}
.search-hero-inner:has(#search-input:not(:placeholder-shown)) .search-icon{
  background-color: var(--primary);
  color: var(--primary);
}

/* （可选）没文字时隐藏清除按钮 */
#search-input:placeholder-shown ~ .search-clear{
  opacity:0;
  pointer-events:none;
}
         
        .search-input {
            flex: 1; border: none; outline: none; background: transparent;
            font-size: 16px; font-family: 'Nunito', sans-serif; font-weight: 600;
            color: var(--primary);
        }
        .search-input::placeholder { color: #999; }
        
        .search-clear { cursor: pointer; color:var(--primary); font-size: 18px; display: none; }
input[type="search"]::-webkit-search-cancel-button {
  -webkit-appearance: none;
  appearance: none;
  display: none;
}

/* 干掉 Safari 额外装饰 */
input[type="search"]::-webkit-search-decoration {
  -webkit-appearance: none;
}

        /* --- 4. 首页分类 --- */
        .category-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px;
        }
        .cat-card {
            background: var(--white); border-radius: var(--radius-box);
            overflow: hidden; box-shadow: var(--shadow);
            cursor: pointer; transition: transform 0.2s;
            display: flex; flex-direction: column;
        }
        .cat-card:active { transform: scale(0.98); }
        .cat-img-box { width: 100%; height: 200px; overflow: hidden; }
        .cat-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .cat-card:hover .cat-img { transform: scale(1.05); }
        .cat-info { padding: 20px; border-top: 1px solid var(--border); }
        .cat-title { font-size: 20px; font-weight: 900; margin: 0 0 6px 0; color: var(--primary); }
        .cat-desc { font-size: 14px; color: var(--text-gray); line-height: 1.4; }

        /* --- 5. 列表页 --- */
        .back-nav {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px; 
}

.nav-title {
  font-size: 15px;
  font-weight: 600;
  color: #6e6e73;   /* Apple 常用次级文字 */
  white-space: nowrap;
}

        .btn-back {
            background: var(--white); border: 1px solid #E5E7EB;
            padding: 12px 24px 12px 18.5px; border-radius: var(--radius-btn);
            display: inline-flex; align-items: center; gap: 8px;
            font-weight: 800; font-size: 16px; color: var(--primary); cursor: pointer;
              color: var(--primary); /* 文字颜色 = 图标颜色 */
        }


.back-nav {
  /* 默认：Home 状态 */
  --nav-icon: url("https://i.ibb.co/Q3hkmW9x/IMG-20251219-145724.png");
  --nav-icon-size: 22px;   /* Home 图标更大 */
}

.back-icon {
  width: var(--nav-icon-size);
  height: var(--nav-icon-size);
  background-color: currentColor;

  -webkit-mask: var(--nav-icon) no-repeat center;
  -webkit-mask-size: contain;

  mask: var(--nav-icon) no-repeat center;
  mask-size: contain;

  display: inline-block;
}



        .product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .prod-card {
            background: var(--white); border-radius: var(--radius-box); overflow: hidden;
            box-shadow: var(--shadow); display: flex; flex-direction: column;
        }
        .prod-img { width: 100%; height: 220px; object-fit: cover; }
        .prod-body { padding: 18px; flex: 1; display: flex; flex-direction: column; }
        .prod-title { font-size: 18px; font-weight: 800; margin: 0 0 8px 0; color: var(--primary); }
        .prod-desc { 
            font-size: 13px; color: var(--text-gray); line-height: 1.5;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            margin-bottom: 15px;
        }
        .prod-footer { margin-top: auto; display: flex; justify-content: flex-end; }
        .btn-action {
            background: var(--accent); color: var(--primary); border: none;
            padding: 10px 24px; border-radius: var(--radius-btn); font-weight: 800; font-size: 14px; cursor: pointer;
        }

        /* --- 6. 弹窗 (Modal) --- */
        .modal-overlay, .cart-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px); display: none; justify-content: center; align-items: flex-end;
            transition: opacity 0.3s; 
        }
        .cart-overlay { z-index: 2000; }
        .modal-overlay { z-index: 2100; } /* Product above Cart */

        @media(min-width: 768px) {
            .modal-overlay, .cart-overlay { align-items: center; }
            .modal-shell, .cart-shell { max-width: 480px !important; border-radius: 24px !important; height: 85vh !important; }
        }

        /* Animation & Structure */
        .modal-shell, .cart-shell {
            background: var(--white); width: 100%; height: 90vh;
            border-radius: 24px 24px 0 0; display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            transform: translateY(100%); 
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-shell.open, .cart-shell.open { transform: translateY(0); } 
        
        .cart-shell { background: #F5F7FA; }

        .close-btn {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255,255,255,0.9); width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer; z-index: 30;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Modal Content */
        .modal-scroll { flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: 20px; }
        .modal-hero-img { width: 100%; height: 280px; object-fit: cover; display: block; }
        .modal-content-box { padding: 24px; }
        .m-title { font-size: 24px; font-weight: 900; margin-bottom: 12px; color: var(--primary); }
        .m-desc { font-size: 15px; color: var(--text-gray); line-height: 1.6; margin-bottom: 30px; }

        .variant-section { border-top: 1px solid var(--border); padding-top: 20px; }
        .v-label { font-size: 13px; font-weight: 800; color: #999; margin-bottom: 15px; display: block; text-transform: uppercase; letter-spacing: 1px; }
        .v-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; border-bottom: 1px solid var(--border); cursor: pointer;
        }
        .v-radio {
            width: 22px; height: 22px; border: 2px solid #ddd; border-radius: 50%;
            margin-right: 12px; position: relative; flex-shrink: 0;
        }
        .v-item.selected .v-radio { border-color: var(--accent); background: var(--accent); }
        .v-item.selected .v-radio::after {
            content:''; position:absolute; width: 8px; height: 8px;
            background: var(--primary); border-radius: 50%;
            top:50%; left:50%; transform:translate(-50%, -50%);
        }
        .v-info { display: flex; align-items: center; }
        .v-text { font-weight: 700; font-size: 16px; color: var(--primary); }
        .v-price { font-weight: 800; font-size: 16px; color: var(--primary); }

        .modal-footer {
            padding: 15px 20px 30px 20px; background: var(--white);
            border-top: 1.5px solid var(--border); z-index: 20;
            display: flex; flex-direction: column; gap: 15px;
        }
        .qty-control {
            display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 10px;
        }
        .qty-btn {
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid #ddd;
            background: white; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .qty-val { font-size: 20px; font-weight: 800; width: 30px; text-align: center; }
        .btn-add-cart {
            width: 100%; background: var(--accent); color: var(--primary); border: none;
            padding: 18px 27px; border-radius: var(--radius-btn); font-size: 18px; font-weight: 800;
            display: flex; justify-content: space-between; cursor: pointer; box-shadow: 0 5px 15px rgba(244, 192, 75, 0.3);
        }

        /* Cart Content */
        .cart-header {
            padding: 20px; background: white; text-align: center;
            font-weight: 900; font-size: 18px; border-bottom: 1px solid var(--border);
        }
        .cart-list { flex: 1; overflow-y: auto; padding: 20px; background: var(--bg);}
        .cart-item {
            background: white; border-radius: 16px; padding: 15px;
            display: flex; gap: 15px; margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); cursor: pointer;
        }
        .cart-img { width: 70px; height: 70px; border-radius: 12px; object-fit: cover; }
        .cart-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .c-title { font-weight: 800; font-size: 15px; margin-bottom: 4px; }
        .c-sku { font-size: 13px; color: #888; margin-bottom: 4px; }
        .c-price { font-weight: 800; font-size: 15px; color: var(--primary); }
        .cart-actions {
            display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 8px;
        }
        .mini-qty {
            background: #F3F4F6; border-radius: 8px; padding: 2px 8px;
            font-size: 13px; font-weight: 800; display: flex; align-items: center; gap: 8px;
        }
        .mini-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .edit-hint { font-size: 11px; color: #AAA; font-weight: 600; text-transform: uppercase; }

        /* Sticky Cart */
        .sticky-cart {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: var(--primary); color: white;
            padding: 14px 20px; border-radius: 50px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 8px 20px rgba(16, 41, 64, 0.3); z-index: 800;
            cursor: pointer; transition: all 0.2s;
        }
        .sticky-cart:active { transform: translateX(-50%) scale(0.96); }
        .badge { background: var(--accent); color: var(--primary); padding: 4px 10px; border-radius: 20px; font-weight: 800; font-size: 14px; margin-right: 10px; }

        /* Toast */
        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: white; padding: 16px 30px;
            border-radius: 30px; z-index: 3000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; font-weight: 700;
        }
        .btn-remove {
            width: 100%; border: 1px solid #FF6B6B; background: white; color: #FF6B6B;
            padding: 12px; border-radius: var(--radius-btn); font-weight: 800;
            margin-top: 10px; cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="smart-header">
        <div class="header-left">
            <img src="https://i.ibb.co/sJtMRwDB/IMG-20251219-091347.png" class="logo-img" alt="Neco's">
        </div>
        <div class="lang-switch">
            <button class="lang-btn" onclick="setLang('en')">EN</button>
            <button class="lang-btn" onclick="setLang('pt')">PT</button>
            <button class="lang-btn" onclick="setLang('cn')">CN</button>
        </div>
    </div>

    <div class="container">
        <!-- [NEW] Permanent Search Bar -->
        <div class="search-hero">
            <div class="back-nav">
  <button class="btn-back" onclick="goBack()">
    <span class="back-icon"></span>
    <span id="txt-back">Home</span>
  </button>
</div>
            <div class="search-hero-inner">
                <span class="search-icon"></span>
                <input
  type="search"
  id="search-input"
  class="search-input"
  placeholder="Search..."
  enterkeyhint="search"
  oninput="handleSearch()"
  onkeydown="onSearchKeyDown(event)"
>

                <span class="search-clear" id="search-clear" onclick="clearSearch()">✕</span>
            </div>
        </div>

        <!-- 1. 首页 (Home) -->
        <div id="view-home" class="view-section active">
            <div class="category-grid" id="category-grid">
                <!-- JS Inject -->
            </div>
            <div style="height: 60px;"></div>
        </div>

        <!-- 2. 列表页 (Category / Search Results) -->
        <div id="view-category" class="view-section">
            <div id="category-content">
                <!-- JS Inject -->
            </div>
        </div>
    </div>

    <!-- 3. 产品详情弹窗 (Product Modal) -->
    <div class="modal-overlay" id="product-modal" onclick="closeModal(event)">
        <div class="modal-shell" id="modal-shell" onclick="event.stopPropagation()">
            <div class="close-btn" onclick="closeModalDirect()">✕</div>
            
            <div class="modal-scroll">
                <img src="" id="m-img" class="modal-hero-img">
                <div class="modal-content-box">
                    <div class="m-title" id="m-title">Title</div>
                    <div class="m-desc" id="m-desc">Desc</div>
                    <div class="variant-section">
                        <label class="v-label" id="txt-select-size">SELECT SIZE</label>
                        <div id="variant-list"></div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <div class="qty-control">
                    <div class="qty-btn" onclick="adjustQty(-1)">-</div>
                    <div class="qty-val" id="m-qty">1</div>
                    <div class="qty-btn" onclick="adjustQty(1)">+</div>
                </div>
                <button class="btn-add-cart" onclick="confirmAddToCart()">
                    <span id="txt-add-btn">Add to Order</span>
                    <span id="m-total-price">€ 0.00</span>
                </button>
                <button class="btn-remove" id="btn-remove-item" style="display:none;" onclick="removeCurrentItem()">
                    <span id="txt-remove">Remove Item</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 4. 购物车弹窗 (Cart Modal) -->
    <div class="cart-overlay" id="cart-modal" onclick="closeCart(event)">
        <div class="cart-shell" id="cart-shell" onclick="event.stopPropagation()">
            <div class="cart-header">
                <span id="txt-your-order">Your Order</span>
                <div style="position:absolute; right:20px; top:20px; cursor:pointer;" onclick="closeCartDirect()">✕</div>
            </div>
            <div class="cart-list" id="cart-list"></div>
            <div class="modal-footer">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:800; font-size:18px;">
                    <span id="txt-total">Total</span>
                    <span id="cart-modal-total">€ 0.00</span>
                </div>
                <button class="btn-add-cart" onclick="closeCartDirect()">
                    <span style="width:100%; text-align:center;" id="txt-confirm">Confirm</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 5. 底部悬浮条 (Sticky Cart) -->
    <div class="sticky-cart" id="sticky-cart" onclick="openCartModal()">
        <div style="display:flex; align-items:center;">
            <span class="badge" id="cart-count">0</span>
            <span id="txt-view-order" style="font-weight:700;">View Order</span>
        </div>
        <div style="font-weight:800; font-size:18px;" id="cart-bar-total">€ 0.00</div>
    </div>

    <div id="toast" class="toast">Update Success!</div>

    <script>
        // ==========================================
        // 1. 数据中心
        // ==========================================
        const db = {
            categories: [
                { id: "classic", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-5a2f691a-f7d5-4d33-b3be-b84ecea1c831.jpeg", 
                  title: { cn: "永远的经典", en: "Eternal Classic", pt: "Clássico Eterno" },
                  desc: { cn: "黑森林 / 提拉米苏 / 红丝绒", en: "Black Forest / Tiramisu / Red Velvet", pt: "Floresta Negra / Tiramisu" } },
                { id: "layer", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-0038becb-7292-4eea-93f7-9fa986281d21.jpeg", 
                  title: { cn: "招牌千层蛋糕", en: "Signature Layer Cake", pt: "Bolo de Mil Camadas" },
                  desc: { cn: "手工制作，层层美味", en: "Handmade crepe layers", pt: "Camadas de crepe artesanais" } },
                { id: "naked", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-11f1f013-ffc3-4c14-a39e-af3edc99dab8.jpeg", 
                  title: { cn: "原生态裸蛋糕", en: "Naked Fruit Cake", pt: "Bolo Nu" },
                  desc: { cn: "新鲜水果搭配香草戚风", en: "Fresh fruits with vanilla chiffon", pt: "Frutas frescas com chiffon" } },
                { id: "cheese", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-e4e9d0e4-c631-4a71-bd6a-52caa7a42fd2.jpeg", 
                  title: { cn: "芝士与慕斯", en: "Cheesecake & Mousse", pt: "Bolo de queijo e mousse" },
                  desc: { cn: "天然食材，浓郁口感", en: "Natural ingredients", pt: "Ingredientes naturais" } },
                { id: "korean", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-153de66b-9952-45d1-9c9d-09d9b1015029.jpeg", 
                  title: { cn: "韩式奶油调味", en: "Korean Style Cream", pt: "Estilo Coreano" },
                  desc: { cn: "清新风格，独特调味", en: "Fresh style, flavored cream", pt: "Estilo fresco" } },
                { id: "custom", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-0a61f906-d8d7-45b4-b0c2-c240d5b14e80.jpeg", 
                  title: { cn: "造型定制蛋糕", en: "Custom Design Cake", pt: "Bolo Personalizado" },
                  desc: { cn: "有趣外表，好吃好玩", en: "Fun & Delicious", pt: "Divertido e delicioso" } }
            ],
            items: {
                "classic": [
                    { id:"c1", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-b267cf6d-fb4d-4d57-9351-8c69c59c54b2.jpeg",
                      title: { cn: "红丝绒乳酪蛋糕", en: "Red Velvet Cheesecake", pt: "Cheesecake de Veludo Vermelho" },
                      desc: { cn: "鲜艳的红色蛋糕层和白色乳酪层形成鲜明对比。口感柔软湿润，甜而不腻。", en: "Bright red cake layer with white cheese layer. Soft, moist, sweet but not greasy.", pt: "Bolo vermelho vivo com camadas de cream cheese. Macio e úmido." },
                      variants: [ 
                          { id:"v1", names: { cn: "6英寸", en: "6 inches", pt: "6 polegadas" }, price: 42 },
                          { id:"v2", names: { cn: "8英寸", en: "8 inches", pt: "8 polegadas" }, price: 58 } 
                      ] },
                    { id:"c2", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-25ad3750-4ed7-4c4f-a2cc-2d99925374a6.jpeg",
                      title: { cn: "奶酱黑森林蛋糕", en: "Milk Sauce Black Forest", pt: "Bolo Floresta Negra" },
                      desc: { cn: "非常浓郁的巧克力海绵蛋糕，夹层包含白巧奶油及酒渍黑樱桃。", en: "Rich chocolate sponge, white/dark choc cream, cherries.", pt: "Pão de ló de chocolate rico, creme de chocolate branco." },
                      variants: [ 
                          { id:"v1", names: { cn: "6英寸", en: "6 inches", pt: "6 polegadas" }, price: 45 },
                          { id:"v2", names: { cn: "8英寸", en: "8 inches", pt: "8 polegadas" }, price: 60 } 
                      ] }
                ],
                "layer": [
                    { id:"l1", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-38db952a-2ebb-4af1-b733-a223cede14f3.jpeg",
                      title: { cn: "巧克力千层蛋糕", en: "Chocolate Mille Crepe", pt: "Bolo De Melaleuca De Chocolate" },
                      desc: { cn: "浓郁的巧克力可丽饼，夹层为巧克力奶油及慕斯。", en: "Rich chocolate crepe with chocolate mousse.", pt: "Rico crepe de chocolate e mousse." },
                      variants: [ 
                          { id:"v1", names: { cn: "切块", en: "Slice", pt: "Fatia" }, price: 6.5 },
                          { id:"v2", names: { cn: "8寸整圆", en: "Whole (8 inch)", pt: "Inteiro (8 pol)" }, price: 48 } 
                      ] }
                ],
                "custom": [
                    { id:"u1", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-450495cd-b008-4019-9569-55546dc3f80b.jpeg",
                      title: { cn: "情侣兔子蛋糕", en: "Couple Rabbit Cake", pt: "Bolo de Coelho Casal" },
                      desc: { cn: "卡通兔子风格。可选巧克力，柠檬，抹茶等口味。", en: "Cartoon style. Available in 4/6 inch.", pt: "Estilo cartoon. Tamanhos 4/6 pol." },
                      variants: [ 
                          { id:"v1", names: { cn: "4英寸", en: "4 inches", pt: "4 polegadas" }, price: 25 },
                          { id:"v2", names: { cn: "6英寸", en: "6 inches", pt: "6 polegadas" }, price: 38 }
                      ] }
                ]
            }
        };

   let state = {
  lang: 'en',
  isSearchMode: false,
  cart: [],
  modal: { item: null, variant: null, qty: 1, editUid: null },
  scroll: { home: { en: 0, pt: 0, cn: 0 } },
  currentCategoryId: null // NEW：记住当前分类
};



        const texts = {
            cn: { 
                back: "返回分类", homeTitle: "主页", select: "选择规格", add: "加入订单", update: "更新订单", 
                view: "查看订单", more: "查看详情", order: "我的订单", total: "总计", 
                confirm: "确认下单", remove: "移除此商品", empty: "购物车为空", 
                added: "已加入订单", updated: "订单已更新", editHint: "点击编辑", 
                searchPh: "搜索蛋糕...", noResult: "未找到相关商品", fallback: "当前语言无结果，已展示其他语言匹配。"
            },
            en: { 
                back: "Back", homeTitle: "Home", select: "Select Size", add: "Add to Order", update: "Update Order", 
                view: "View Order", more: "More Info", order: "Your Order", total: "Total", 
                confirm: "Confirm", remove: "Remove Item", empty: "Empty Cart", 
                added: "Added to Order", updated: "Order Updated", editHint: "Edit item",
                searchPh: "Search cakes...", noResult: "No results found", fallback: "No results in English, showing matches from other languages."
            },
            pt: { 
                back: "Voltar", homeTitle: "Início", select: "Selecione o Tamanho", add: "Adicionar", update: "Atualizar", 
                view: "Ver Pedido", more: "Mais Info", order: "Seu Pedido", total: "Total", 
                confirm: "Confirmar", remove: "Remover Item", empty: "Carrinho Vazio", 
                added: "Adicionado", updated: "Atualizado", editHint: "Editar item",
                searchPh: "Pesquisar bolos...", noResult: "Nenhum resultado", fallback: "Sem resultados em Português, a mostrar outras línguas."
            }
        };

        init();

        function init() {
            setLang('en'); 
        }

        function setLang(l) {
            state.lang = l;
            document.querySelectorAll('.lang-btn').forEach(b => {
                b.classList.toggle('active', b.innerText.toLowerCase() === l);
            });
            updateUI();
            if(state.isSearchMode) handleSearch();
        }
function onSearchKeyDown(e) {
  if (e.key === 'Enter') {
    e.preventDefault(); // 防止表单默认行为
    const input = e.target;

    // 1) 收起键盘
    input.blur();

    // 2) 执行搜索（用你现成的逻辑）
    handleSearch();
  }
}

function updateTopButtonLabel() {
  const isHome = document.getElementById('view-home').classList.contains('active');
  const t = texts[state.lang];

  const txt = document.getElementById('txt-back');
  if (txt) txt.innerText = isHome ? t.homeTitle : t.back;

  const nav = document.querySelector('.back-nav');
  if (!nav) return;

  if (isHome) {
    // Home：图标大一点
    nav.style.setProperty('--nav-icon', 'url("https://i.ibb.co/kVS4zpC5/IMG-20251219-152124.png")');
    nav.style.setProperty('--nav-icon-size', '22.5px');
  } else {
    // Back：箭头小一点
    nav.style.setProperty('--nav-icon', 'url("https://lestoy.com/love/icones/back.svg")');
    nav.style.setProperty('--nav-icon-size', '18px');
  }
}



        function updateUI() {
            const t = texts[state.lang];
            const ids = {
                'txt-view-order': t.view, 'txt-your-order': t.order,
                'txt-select-size': t.select, 'txt-add-btn': state.modal.editUid ? t.update : t.add,
                'txt-total': t.total, 'txt-confirm': t.confirm, 'txt-remove': t.remove
            };
            for(let id in ids) {
                const el = document.getElementById(id);
                if(el) el.innerText = ids[id];
            }
            document.getElementById('search-input').placeholder = t.searchPh;

           if (document.getElementById('view-home').classList.contains('active') && !state.isSearchMode) {
  // NEW: 语言切换时，保持当前滚动位置
  state.scroll.home[state.lang] = window.scrollY || 0;
  renderHome(true);
}

          else if (!state.isSearchMode) {
  // NEW：分类页切语言 -> 重渲染当前分类，并保持滚动位置
  if (document.getElementById('view-category').classList.contains('active') && state.currentCategoryId) {
    const y = window.scrollY || 0;
    renderCategory(state.currentCategoryId, { skipSaveHome: true, keepScrollY: y });
  }
}
const hint = state.lang === 'cn' ? 'search' : 'search'; // 这里不用改也行
document.getElementById('search-input').setAttribute('enterkeyhint', hint);

            updateCartBar();
            if(document.getElementById('cart-modal').style.display === 'flex') openCartModal();
            updateTopButtonLabel();

        }

      function renderHome(restoreScroll = false) {
  const grid = document.getElementById('category-grid');
  grid.innerHTML = db.categories.map(c => `
      <div class="cat-card" onclick="renderCategory('${c.id}')">
          <div class="cat-img-box"><img src="${c.img}" class="cat-img" loading="lazy"></div>
          <div class="cat-info">
              <div class="cat-title">${c.title[state.lang]}</div>
              <div class="cat-desc">${c.desc[state.lang]}</div>
          </div>
      </div>
  `).join('');

  const saved = state.scroll.home[state.lang] || 0;

  // NEW: 恢复滚动 or 默认顶部
  switchView('view-home', restoreScroll ? { scrollTop: saved } : {});
}


function renderCategory(id, opts = {}) {
  state.currentCategoryId = id; // NEW

  // 只有从首页点进来时才记录首页滚动；语言切换重渲染时别覆盖
  if (!opts.skipSaveHome) {
    state.scroll.home[state.lang] = window.scrollY || window.pageYOffset || 0;
  }

  const items = db.items[id] || [];
  const container = document.getElementById('category-content');
  renderProductList(container, items, id);

  // 如果是在分类页切语言，别滚回顶部
  if (typeof opts.keepScrollY === 'number') {
    switchView('view-category', { scrollTop: opts.keepScrollY });
  } else {
    switchView('view-category');
  }
}


        
        function renderProductList(container, items, catId) {
            container.innerHTML = `
                <div class="product-list">
                    ${items.map((item, idx) => `
                        <div class="prod-card">
                            <img src="${item.img}" class="prod-img" loading="lazy">
                            <div class="prod-body">
                                <div class="prod-title">${item.title[state.lang] || item.title['en']}</div>
                                <div class="prod-desc">${item.desc[state.lang] || item.desc['en']}</div>
                                <div class="prod-footer">
                                    <button class="btn-action" onclick="openProductModal('${item._catId || catId}', ${item._idx !== undefined ? item._idx : idx})">
                                        ${texts[state.lang].more}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

     function switchView(viewId, opts = {}) {
  document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
  document.getElementById(viewId).classList.add('active');
updateTopButtonLabel();

  // 默认滚到顶部；如果传了 opts.scrollTop 就恢复到指定位置；如果 opts.noScroll 就不动
  if (opts.noScroll) return;

  const top = typeof opts.scrollTop === 'number' ? opts.scrollTop : 0;
  requestAnimationFrame(() => window.scrollTo(0, top));
}

        
function goBack() {
  const isHome = document.getElementById('view-home').classList.contains('active');
  if (isHome) return; // 主页点它不做事（你也可以改成滚到顶部）

  if (state.isSearchMode) clearSearch();
  else renderHome(true);
}



        // --- Search Logic ---
        function handleSearch() {
            const query = document.getElementById('search-input').value.trim().toLowerCase();
            document.getElementById('search-clear').style.display = query.length > 0 ? 'block' : 'none';

            if(query.length < 1) {
                if(state.isSearchMode) {
                    state.isSearchMode = false;
                    renderHome();
                }
                return;
            }

            state.isSearchMode = true;
            
            // Flatten all items
            let allItems = [];
            for(let cat in db.items) {
                db.items[cat].forEach((item, idx) => {
                    item._catId = cat; item._idx = idx; // Store ref
                    allItems.push(item);
                });
            }

            // Strategy: 1. Current Lang  2. Fallback
            const lang = state.lang;
            let results = allItems.filter(item => {
                const t = (item.title[lang] || '').toLowerCase();
                const d = (item.desc[lang] || '').toLowerCase();
                return t.includes(query) || d.includes(query);
            });

            let isFallback = false;
            if(results.length === 0) {
                // Fallback search
                results = allItems.filter(item => {
                    return Object.values(item.title).some(v => v.toLowerCase().includes(query)) ||
                           Object.values(item.desc).some(v => v.toLowerCase().includes(query));
                });
                if(results.length > 0) isFallback = true;
            }

            // Render Results
            const container = document.getElementById('category-content');
            if(results.length > 0) {
                renderProductList(container, results, null); // catId null means search mode
            } else {
                container.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">${texts[state.lang].noResult}</div>`;
            }
            
            switchView('view-category');
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-clear').style.display = 'none';
            state.isSearchMode = false;
            renderHome();
        }
        
        // --- Modal Logic ---
        function openProductModal(catId, itemIdx, editCartItem = null) {
            let item, variant, qty = 1;
            
            if (editCartItem) {
                // Find item by ID scan (safe way)
                for(let c in db.items) {
                    const found = db.items[c].find(i => i === editCartItem._rawItem || i.title.en === editCartItem.title.en); // Fallback match
                    if(found) { item = found; break; }
                }
                // Fallback if raw obj stored
                if(!item && editCartItem._rawItem) item = editCartItem._rawItem;
                
                variant = item.variants.find(v => v.price === editCartItem.price); // Simplified match
                qty = editCartItem.qty;
                state.modal.editUid = editCartItem.uid;
                document.getElementById('btn-remove-item').style.display = 'block';
                document.getElementById('txt-add-btn').innerText = texts[state.lang].update;
            } else {
                item = db.items[catId][itemIdx];
                variant = item.variants[0];
                state.modal.editUid = null;
                document.getElementById('btn-remove-item').style.display = 'none';
                document.getElementById('txt-add-btn').innerText = texts[state.lang].add;
            }

            state.modal.item = item;
            state.modal.variant = variant;
            state.modal.qty = qty;

            document.getElementById('m-img').src = item.img;
            document.getElementById('m-title').innerText = item.title[state.lang] || item.title['en'];
            document.getElementById('m-desc').innerText = item.desc[state.lang] || item.desc['en'];
            document.getElementById('m-qty').innerText = qty;

            const vList = document.getElementById('variant-list');
            vList.innerHTML = item.variants.map((v, idx) => {
                const isSelected = (v.id === variant.id) ? 'selected' : '';
                return `
                <div class="v-item ${isSelected}" onclick="selectVariant(${idx})">
                    <div class="v-info">
                        <div class="v-radio"></div>
                        <span class="v-text">${v.names[state.lang] || v.names['en']}</span>
                    </div>
                    <span class="v-price">€ ${v.price}</span>
                </div>
            `}).join('');

            updateModalPrice();
            
            const modal = document.getElementById('product-modal');
            const shell = document.getElementById('modal-shell');
            modal.style.display = 'flex';
            modal.style.opacity = 1;
            // Trigger animation
            requestAnimationFrame(() => shell.classList.add('open'));
        }

        function selectVariant(idx) {
            state.modal.variant = state.modal.item.variants[idx];
            const els = document.querySelectorAll('.v-item');
            els.forEach((el, i) => el.classList.toggle('selected', i === idx));
            updateModalPrice();
        }

        function adjustQty(delta) {
            let newQty = state.modal.qty + delta;
            if (newQty < 1) newQty = 1;
            state.modal.qty = newQty;
            document.getElementById('m-qty').innerText = newQty;
            updateModalPrice();
        }

        function updateModalPrice() {
            const total = state.modal.variant.price * state.modal.qty;
            document.getElementById('m-total-price').innerText = `€ ${total.toFixed(2)}`;
        }

        function closeModalDirect() {
            const modal = document.getElementById('product-modal');
            const shell = document.getElementById('modal-shell');
            shell.classList.remove('open'); // Slide Down
            modal.style.opacity = 0; // Fade Out
            setTimeout(() => { modal.style.display = 'none'; }, 300); // Wait for anim
        }
        function closeModal(e) { if(e.target.id === 'product-modal') closeModalDirect(); }

        // --- Cart Logic ---
        function confirmAddToCart() {
            const { item, variant, qty, editUid } = state.modal;
            if (editUid) {
                const idx = state.cart.findIndex(c => c.uid === editUid);
                if (idx !== -1) {
                    state.cart[idx].variantNames = variant.names;
                    state.cart[idx].price = variant.price;
                    state.cart[idx].qty = qty;
                }
            } else {
                const existing = state.cart.find(c => c.title.en === item.title.en && c.price === variant.price);
                if (existing) existing.qty += qty;
                else state.cart.push({ uid: Date.now(), _rawItem: item, img: item.img, title: item.title, variantNames: variant.names, price: variant.price, qty: qty });
            }
            closeModalDirect();
            updateCartBar();
            showToast(editUid ? texts[state.lang].updated : texts[state.lang].added);
            if(document.getElementById('cart-modal').style.display === 'flex') openCartModal();
        }

        function removeCurrentItem() {
            const idx = state.cart.findIndex(c => c.uid === state.modal.editUid);
            if (idx !== -1) state.cart.splice(idx, 1);
            closeModalDirect();
            updateCartBar();
            if(document.getElementById('cart-modal').style.display === 'flex') openCartModal();
        }

        function updateCartBar() {
            const totalQty = state.cart.reduce((sum, item) => sum + item.qty, 0);
            const totalPrice = state.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            document.getElementById('cart-count').innerText = totalQty;
            document.getElementById('cart-bar-total').innerText = `€ ${totalPrice.toFixed(2)}`;
        }

        function openCartModal() {
            const list = document.getElementById('cart-list');
            list.innerHTML = '';
            if(state.cart.length === 0) list.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">${texts[state.lang].empty}</div>`;
            else {
                state.cart.forEach((cartItem) => {
                    const div = document.createElement('div');
                    div.className = 'cart-item';
                    div.onclick = (e) => { if(!e.target.closest('.mini-btn')) openProductModal(null, null, cartItem); };
                    div.innerHTML = `
                        <img src="${cartItem.img}" class="cart-img">
                        <div class="cart-info">
                            <div class="c-title">${cartItem.title[state.lang] || cartItem.title['en']}</div>
                            <div class="c-sku">${cartItem.variantNames[state.lang] || cartItem.variantNames['en']}</div>
                            <div class="c-price">€ ${(cartItem.price * cartItem.qty).toFixed(2)}</div>
                        </div>
                        <div class="cart-actions">
                            <div class="mini-qty">
                                <div class="mini-btn" onclick="updateCartItemQty(${cartItem.uid}, -1)">-</div>
                                <span style="margin:0 5px;">${cartItem.qty}</span>
                                <div class="mini-btn" onclick="updateCartItemQty(${cartItem.uid}, 1)">+</div>
                            </div>
                            <div class="edit-hint">${texts[state.lang].editHint}</div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
            const total = state.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            document.getElementById('cart-modal-total').innerText = `€ ${total.toFixed(2)}`;
            
            const modal = document.getElementById('cart-modal');
            const shell = document.getElementById('cart-shell');
            modal.style.display = 'flex';
            modal.style.opacity = 1;
            requestAnimationFrame(() => shell.classList.add('open'));
        }

        function updateCartItemQty(uid, delta) {
            const item = state.cart.find(c => c.uid === uid);
            if(item) {
                item.qty += delta;
                if(item.qty <= 0) state.cart.splice(state.cart.indexOf(item), 1);
                updateCartBar();
                openCartModal(); 
            }
        }

        function closeCartDirect() {
            const modal = document.getElementById('cart-modal');
            const shell = document.getElementById('cart-shell');
            shell.classList.remove('open');
            modal.style.opacity = 0;
            setTimeout(() => { modal.style.display = 'none'; }, 300);
        }
        function closeCart(e) { if(e.target.id === 'cart-modal') closeCartDirect(); }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }
    </script>
</body>
</html>
