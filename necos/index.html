<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Neco's Custom Cake</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
        /* --- 1. 设计系统 --- */
        :root {
            --primary: #102940; /* 深蓝 */
            --accent: #F4C04B; /* 蛋黄 */
            --bg: #F5F5F7; /* 米白 */
            --white: #FFFFFF;
            --text-gray: #666666;
            --border: #F0F0F0;
            --radius-box: 20px;
            --radius-btn: 50px;
            --shadow: 0 8px 24px rgba(16, 41, 64, 0.08);
            --header-h: 70px;
        }
        /* ===== 弹窗打开：禁止外层滚动（防穿透） ===== */
html.no-scroll,
body.no-scroll {
  height: 100%;
  overflow: hidden;
}
/* iOS/移动端更稳：锁住 body 位置，避免背景跟着滑 */
body.no-scroll {
  position: fixed;
  width: 100%;
  left: 0;
}
/* 弹窗内部仍可滚动，并阻止滚动链传到外层 */
.modal-scroll,
.cart-list {
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
}
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, button, input, select, textarea {
            font-family: 'Nunito', sans-serif;
        }
        html {
          overflow-y: scroll;
        }
        body {
            background-color: var(--bg);
            color: var(--primary);
            margin: 0;
            padding-top: var(--header-h);
            padding-bottom: 82px;
            overflow-x: hidden;
        }
        /* --- 2. Header --- */
        .smart-header {
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-h);
            background: var(--white); z-index: 900;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo-img { height: 54px; width: auto; }
        .lang-switch { display: flex; background: #F3F4F6; border-radius: 20px; padding: 3px; }
        .lang-btn {
            border: none; background: transparent; padding: 6px 10px;
            border-radius: 16px; font-size: 12px; font-weight: 800; color: #999;
            cursor: pointer; transition: all 0.2s;
        }
        .lang-btn.active { background: var(--accent); color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        /* --- 3. 布局 --- */
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        /* ✅ 改：去掉整页 fadeIn（love 是卡片动，不是整页闪） */
        .view-section { display: none; }
        .view-section.active { display: block; }
        /* [NEW] 常驻搜索框 (Google Style) */
        .search-hero { margin-bottom: 30px; }
        .search-hero-inner {
            display: flex; align-items: center; gap: 12px;
            background: var(--white); border-radius: 18px;
            padding: 18px 18px;
            box-shadow: 0 8px 24px rgba(16, 41, 64, 0.08);
            transition: box-shadow 0.2s;
        }
        .search-hero-inner:focus-within { box-shadow: 0 8px 30px rgba(16, 41, 64, 0.15); }
      .search-icon {
        width: 20px;
        height: 20px;
        background-color: #999;
        -webkit-mask: url("https://lestoy.com/love/icones/search.svg") no-repeat center;
        -webkit-mask-size: contain;
        mask: url("https://lestoy.com/love/icones/search.svg") no-repeat center;
        mask-size: contain;
        display: inline-block;
      }
      .search-hero-inner:has(#search-input:not(:placeholder-shown)) .search-icon{
        background-color: var(--primary);
        color: var(--primary);
      }
      #search-input:placeholder-shown ~ .search-clear{
        opacity:0;
        pointer-events:none;
      }
        .search-input {
            flex: 1; border: none; outline: none; background: transparent;
            font-size: 16px; font-family: 'Nunito', sans-serif; font-weight: 600;
            color: var(--primary);
        }
        .search-input::placeholder { color: #999; }
        .search-clear { cursor: pointer; color:var(--primary); font-size: 18px; display: none; }
        input[type="search"]::-webkit-search-cancel-button {
          -webkit-appearance: none;
          appearance: none;
          display: none;
        }
        input[type="search"]::-webkit-search-decoration {
          -webkit-appearance: none;
        }
        /* --- 4. 首页分类 --- */
        .category-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px;
        }
        .cat-card {
            background: var(--white); border-radius: var(--radius-box);
            overflow: hidden; box-shadow: var(--shadow);
            cursor: pointer; transition: transform 0.2s;
            display: flex; flex-direction: column;
        }
        .cat-card:active { transform: scale(0.98); }
        .cat-img-box { width: 100%; height: 200px; overflow: hidden; }
        .cat-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .cat-card:hover .cat-img { transform: scale(1.05); }
        .cat-info { padding: 20px; border-top: 1px solid var(--border); }
        .cat-title { font-size: 20px; font-weight: 900; margin: 0 0 6px 0; color: var(--primary); }
        .cat-desc { font-size: 14px; color: var(--text-gray); line-height: 1.4; }
        /* --- 5. 列表页 --- */
        .back-nav {
          display: flex;
          align-items: center;
          gap: 12px;
          margin-bottom: 20px;
        }
        .nav-title {
          font-size: 15px;
          font-weight: 600;
          color: #6e6e73;
          white-space: nowrap;
        }
        .btn-back {
            background: var(--white); border: 1px solid #E5E7EB;
            padding: 12px 24px 12px 18.5px; border-radius: var(--radius-btn);
            display: inline-flex; align-items: center; gap: 8px;
            font-weight: 800; font-size: 16px; color: var(--primary); cursor: pointer;
              color: var(--primary);
        }
        .back-nav {
          --nav-icon: url("https://i.ibb.co/Q3hkmW9x/IMG-20251219-145724.png");
          --nav-icon-size: 22px;
        }
        .back-icon {
          width: var(--nav-icon-size);
          height: var(--nav-icon-size);
          background-color: currentColor;
          -webkit-mask: var(--nav-icon) no-repeat center;
          -webkit-mask-size: contain;
          mask: var(--nav-icon) no-repeat center;
          mask-size: contain;
          display: inline-block;
        }
        .product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .prod-card {
            background: var(--white); border-radius: var(--radius-box); overflow: hidden;
            box-shadow: var(--shadow); display: flex; flex-direction: column;
        }
        .prod-img { width: 100%; height: 220px; object-fit: cover; }
        .prod-body { padding: 18px; flex: 1; display: flex; flex-direction: column; }
        .prod-title { font-size: 18px; font-weight: 800; margin: 0 0 8px 0; color: var(--primary); }
        .prod-desc {
            font-size: 13px; color: var(--text-gray); line-height: 1.5;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
            margin-bottom: 15px;
        }
        .prod-footer { margin-top: auto; display: flex; justify-content: flex-end; }
        .btn-action {
            background: var(--accent); color: var(--primary); border: none;
            padding: 10px 24px; border-radius: var(--radius-btn); font-weight: 800; font-size: 14px; cursor: pointer;
        }
        /* --- 6. 弹窗 (Modal) --- */
        .modal-overlay, .cart-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            backdrop-filter: blur(0.5px); display: none; justify-content: center; align-items: flex-end;
            transition: opacity 0.3s;
        }
        .cart-overlay { z-index: 2000; }
        .modal-overlay { z-index: 2100; }
        @media(min-width: 768px) {
            .modal-overlay, .cart-overlay { align-items: center; }
            .modal-shell, .cart-shell { max-width: 480px !important; border-radius: 24px !important; height: 85vh !important; }
        }
        .modal-shell, .cart-shell {
            background: var(--white); width: 100%; height: 91.25%;
            border-radius: 24px 24px 0 0; display: flex; flex-direction: column;
            position: relative; overflow: hidden;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .modal-shell.open, .cart-shell.open { transform: translateY(0); }
        .cart-shell { background: #F5F7FA; }
        .close-btn {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255,255,255,0.9); width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer; z-index: 30;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .modal-scroll { flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: 20px; }
        .modal-hero-img { width: 100%; height: 280px; object-fit: cover; display: block; }
        .modal-content-box { padding: 24px; }
        .m-title { font-size: 24px; font-weight: 900; margin-bottom: 12px; color: var(--primary); }
        .m-desc { font-size: 15px; color: var(--text-gray); line-height: 1.6; margin-bottom: 30px; }
        .variant-section { border-top: 1px solid var(--border); padding-top: 20px; }
        .v-label { font-size: 13px; font-weight: 800; color: #999; margin-bottom: 15px; display: block; text-transform: uppercase; letter-spacing: 1px; }
        .v-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; border-bottom: 1px solid var(--border); cursor: pointer;
        }
        .v-radio {
            width: 22px; height: 22px; border: 2px solid #ddd; border-radius: 50%;
            margin-right: 12px; position: relative; flex-shrink: 0;
        }
        .v-item.selected .v-radio { border-color: var(--accent); background: var(--accent); }
        .v-item.selected .v-radio::after {
            content:''; position:absolute; width: 8px; height: 8px;
            background: var(--primary); border-radius: 50%;
            top:50%; left:50%; transform:translate(-50%, -50%);
        }
        .v-info { display: flex; align-items: center; }
        .v-text { font-weight: 700; font-size: 16px; color: var(--primary); }
        .v-price { font-weight: 800; font-size: 16px; color: var(--primary); }
        .modal-footer {
            padding: 25px 20px 25px 20px; background: var(--white);
            border-top: 0px solid var(--border); z-index: 20;
            display: flex; flex-direction: column; gap: 10px;
        }
        .qty-control {
            display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 10px;
        }
        .qty-btn {
            width: 40px; height: 40px; border-radius: 50%; border: 1px solid #ddd;
            background: white; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .qty-val { font-size: 20px; font-weight: 800; width: 30px; text-align: center; }
        .btn-add-cart {
            width: 100%; background: var(--accent); color: var(--primary); border: none;
            padding: 17px 17px; border-radius: var(--radius-btn); font-size: 17px; font-weight: 900;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            box-shadow: 0 5px 15px rgba(244, 192, 75, 0.3);
        }
        .cart-header {
            padding: 14px 18px; background: white; text-align: center;
            font-weight: 900; font-size: 18px; border-bottom: 1px solid var(--border);
        }
        .cart-list { flex: 1; overflow-y: auto; padding: 16px; background: var(--bg);}
        .cart-item {
            background: white; border-radius: 16px; padding: 15px;
            display: flex; gap: 15px; margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); cursor: pointer;
        }
        .cart-img { width: 70px; height: 70px; border-radius: 12px; object-fit: cover; }
        .cart-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .c-title { font-weight: 800; font-size: 15px; margin-bottom: 4px; }
        .c-sku { font-size: 13px; color: #888; margin-bottom: 4px; }
        .c-price { font-weight: 800; font-size: 15px; color: var(--primary); }
        .cart-actions {
            display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 8px;
        }
        .mini-qty {
            background: #F3F4F6; border-radius: 8px; padding: 2px 8px;
            font-size: 13px; font-weight: 800; display: flex; align-items: center; gap: 8px;
        }
        .mini-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .edit-hint { font-size: 11px; color: #AAA; font-weight: 600; text-transform: uppercase; }
        .sticky-cart {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: var(--primary); color: white;
            padding: 15px 20px; border-radius: 50px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 8px 20px rgba(16, 41, 64, 0.3); z-index: 800;
            cursor: pointer; transition: all 0.2s;
        }
        .sticky-cart:active { transform: translateX(-50%) scale(0.96); }
        .badge { background: var(--accent); color: var(--primary); padding: 4px 10px; border-radius: 20px; font-weight: 800; font-size: 14px; margin-right: 10px; }
        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: white; padding: 16px 30px;
            border-radius: 30px; z-index: 3000; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; font-weight: 700;
        }
        .btn-remove {
            width: 100%; border: 1px solid #FF6B6B; background: white; color: #FF6B6B;
            padding: 12px; border-radius: var(--radius-btn); font-weight: 800;
            margin-top: 10px; cursor: pointer;
        }
        /* [NEW] Variant rows with per-variant quantity */
        .v-item{
            cursor: default;
        }
        .v-left{ display:flex; flex-direction:column; gap:4px; }
        .v-name{ font-weight: 800; font-size: 16px; color: var(--primary); }
        .v-subprice{ font-weight: 800; font-size: 14px; color: var(--primary); opacity: 0.85; }
        .v-qty{
            display:flex; align-items:center; gap:10px;
            background:#F3F4F6; border-radius: 14px; padding: 6px 10px;
            font-weight: 900;
        }
        .v-qty-btn{
            width: 28px; height: 28px; border-radius: 12px;
            display:flex; align-items:center; justify-content:center;
            cursor:pointer; user-select:none;
        }
        .v-qty-val{
            min-width: 18px; text-align:center; font-weight: 900;
        }
        /* [NEW] Cart total row (below items, footer still single button) */
        .cart-total-row{
            padding: 18px 18px 0px 18px;
            background: white;
            border-top: 0px solid var(--border);
            display:flex;
            justify-content:space-between;
            align-items:center;
            font-weight: 900;
            font-size: 17px;
        }
        /* Make modal scroll feel roomier */
        .modal-scroll{ padding-bottom: 10px; }
        /* =========================================================
           [LOVE PORT] Card enter animation + Image skeleton shimmer
           ========================================================= */
        .reveal-card{
            opacity: 0;
            translate: 0 30px;
            transition: opacity .55s ease, translate .55s ease;
            will-change: opacity, translate;
        }
        .reveal-card.is-visible{
            opacity: 1;
            translate: 0 0;
        }
        @supports not (translate: 0 0){
            .reveal-card{
                transform: translateY(30px);
                transition: opacity .55s ease, transform .55s ease;
            }
            .reveal-card.is-visible{
                transform: translateY(0);
            }
        }
        @media (prefers-reduced-motion: reduce){
            .reveal-card{
                opacity: 1 !important;
                translate: 0 0 !important;
                transform: none !important;
                transition: none !important;
            }
        }
        ..skel-img{
  opacity: 0;
  transform: none;                 /* ✅ 去掉缩放 */
  background: #f2f2f2;
  transition: opacity .5s ease;    /* ✅ 只保留透明度过渡 */
  display: block;
}
        .cat-img.skel-img,
        .prod-img.skel-img{
            transition: opacity .5s ease, transform .5s ease;
        }
        .skel-img.is-loading{
            background-image: linear-gradient(
                90deg,
                rgba(242,242,242,1) 0%,
                rgba(255,255,255,1) 20%,
                rgba(242,242,242,1) 40%,
                rgba(242,242,242,1) 100%
            );
            background-size: 400% 100%;
            animation: sk-shimmer 1.2s linear infinite;
        }
        @keyframes sk-shimmer{
            0%{ background-position: 100% 0; }
            100%{ background-position: -100% 0; }
        }
    .skel-img.is-loaded{
  opacity: 1;
  transform: none;                 /* ✅ 保持不缩放 */
  background: none;
  animation: none;
}
        .skel-img.is-error{
            opacity: 1;
            transform: scale(1);
            background: #f2f2f2;
            animation: none;
        }
        .skel-img.is-loaded.is-loading{
            animation: none;
            background: none;
        }
        @supports (scale: 1){
            .cat-card:active { transform: none; scale: 0.98; }
        }
</style>
</head>
<body>
<!-- Header -->
<div class="smart-header">
	<div class="header-left">
		<img src="https://i.ibb.co/sJtMRwDB/IMG-20251219-091347.png" class="logo-img" alt="Neco's">
	</div>
	<div class="lang-switch">
		<button class="lang-btn" onclick="setLang('en', true)">EN</button>
		<button class="lang-btn" onclick="setLang('pt', true)">PT</button>
		<button class="lang-btn" onclick="setLang('cn', true)">CN</button>
	</div>
</div>
<div class="container">
	<!-- [NEW] Permanent Search Bar -->
	<div class="search-hero">
		<div class="back-nav">
			<button class="btn-back" onclick="goBack()">
			<span class="back-icon"></span>
			<span id="txt-back">Home</span>
			</button>
		</div>
		<div class="search-hero-inner">
			<span class="search-icon"></span>
			<input type="search" id="search-input" class="search-input" placeholder="Search..." enterkeyhint="search" oninput="handleSearch()" onkeydown="onSearchKeyDown(event)">
			<span class="search-clear" id="search-clear" onclick="clearSearch()">✕</span>
		</div>
	</div>
	<!-- 1. 首页 (Home) -->
	<div id="view-home" class="view-section active">
		<div class="category-grid" id="category-grid">
		</div>
		<div style="height: 60px;">
		</div>
	</div>
	<!-- 2. 列表页 (Category / Search Results) -->
	<div id="view-category" class="view-section">
		<div id="category-content">
		</div>
	</div>
</div>
<!-- 3. 产品详情弹窗 (Product Modal) -->
<div class="modal-overlay" id="product-modal" onclick="closeModal(event)">
	<div class="modal-shell" id="modal-shell" onclick="event.stopPropagation()">
		<div class="close-btn" onclick="closeModalDirect()">
			 ✕
		</div>
		<div class="modal-scroll">
			<img src="" id="m-img" class="modal-hero-img">
			<div class="modal-content-box">
				<div class="m-title" id="m-title">
					 Title
				</div>
				<div class="m-desc" id="m-desc">
					 Desc
				</div>
				<div class="variant-section">
					<label class="v-label" id="txt-select-size">SELECT SIZE</label>
					<div id="variant-list">
					</div>
				</div>
			</div>
		</div>
		<div class="modal-footer">
			<button class="btn-add-cart" onclick="confirmAddToCart()">
			<span id="txt-add-btn">Add 0 €0.00</span>
			</button>
		</div>
	</div>
</div>
<!-- 4. 购物车弹窗 (Cart Modal) -->
<div class="cart-overlay" id="cart-modal" onclick="closeCart(event)">
	<div class="cart-shell" id="cart-shell" onclick="event.stopPropagation()">
		<div class="cart-header">
			<span id="txt-your-order">Your Order</span>
			<div style="position:absolute; right:20px; top:20px; cursor:pointer;" onclick="closeCartDirect()">
				 ✕
			</div>
		</div>
		<div class="cart-list" id="cart-list">
		</div>
		<div class="cart-total-row">
			<span id="txt-total">Total</span>
			<span id="cart-modal-total">€ 0.00</span>
		</div>
		<div class="modal-footer">
			<button class="btn-add-cart" onclick="closeCartDirect()">
			<span style="width:100%; text-align:center;" id="txt-confirm">Confirm</span>
			</button>
		</div>
	</div>
</div>
<!-- 5. 底部悬浮条 (Sticky Cart) -->
<div class="sticky-cart" id="sticky-cart" onclick="openCartModal()">
	<div style="display:flex; align-items:center;">
		<span class="badge" id="cart-count">0</span>
		<span id="txt-view-order" style="font-weight:700;">View Order</span>
	</div>
	<div style="font-weight:800; font-size:18px;" id="cart-bar-total">
		 € 0.00
	</div>
</div>
<div id="toast" class="toast">
	 Update Success!
</div>
<script>
        // ==========================================
        // 0. Love 风格动效：统一初始化（不改业务逻辑）
        // ✅ 改：render 阶段直接写入 is-loaded/is-visible，避免一帧闪烁
        // ==========================================
        const __fx = {
          seenCards: new Set(),
          loadedSrc: new Set(),
          revealIO: null
        };
        function __ensureRevealIO(){
          if(__fx.revealIO) return __fx.revealIO;
          __fx.revealIO = new IntersectionObserver((entries) => {
            entries.forEach((e) => {
              if(!e.isIntersecting) return;
              const el = e.target;
              el.classList.add('is-visible');
              const key = el.dataset.revealKey || '';
              if(key) __fx.seenCards.add(key);
              __fx.revealIO.unobserve(el);
            });
          }, { threshold: 0.15 });
          return __fx.revealIO;
        }
        function __normUrl(u){
          return (u || '').trim();
        }
        function __isImgLoadedByUrl(url){
          const u = __normUrl(url);
          return u && __fx.loadedSrc.has(u);
        }
        // ✅ 关键：在生成 HTML 时直接给 class（避免插入后 JS 才补 class 的一帧）
        function __imgClass(url, base){
          const loaded = __isImgLoadedByUrl(url);
          return `${base} skel-img js-skel-img ${loaded ? 'is-loaded' : 'is-loading'}`;
        }
        function __imgDataAttrs(url){
          const loaded = __isImgLoadedByUrl(url);
          return loaded ? `data-fx-init="1" data-fx-loaded="1"` : ``;
        }
        function __cardClass(key, base){
          const seen = key && __fx.seenCards.has(key);
          return `${base} reveal-card js-reveal ${seen ? 'is-visible' : ''}`;
        }
        function __markImgLoaded(img){
          if(!img || img.dataset.fxLoaded === '1') return;
          img.dataset.fxLoaded = '1';
          img.classList.remove('is-loading');
          img.classList.add('is-loaded');
          const srcKey = __normUrl(img.currentSrc || img.src);
          if(srcKey) __fx.loadedSrc.add(srcKey);
        }
        function __markImgError(img){
          if(!img) return;
          img.classList.remove('is-loading');
          img.classList.add('is-error');
        }
        function __initReveal(root){
          const io = __ensureRevealIO();
          const cards = (root || document).querySelectorAll('.js-reveal');
          cards.forEach((card) => {
            const key = card.dataset.revealKey || '';
            // ✅ 如果 render 时已 is-visible，也要写入 seenCards，保持一致
            if(key && card.classList.contains('is-visible')){
              __fx.seenCards.add(key);
              return;
            }
            if(key && __fx.seenCards.has(key)){
              card.classList.add('is-visible');
              return;
            }
            if(!card.classList.contains('is-visible')){
              io.observe(card);
            }
          });
        }
        function __initImages(root){
          const imgs = (root || document).querySelectorAll('img.js-skel-img');
          imgs.forEach((img) => {
            // ✅ 如果 render 时已经是 loaded，就直接写缓存并跳过（完全不闪）
            const srcKey = __normUrl(img.currentSrc || img.src);
            if(img.dataset.fxLoaded === '1' || img.classList.contains('is-loaded')){
              if(srcKey) __fx.loadedSrc.add(srcKey);
              img.dataset.fxInit = '1';
              return;
            }
            if(img.dataset.fxInit === '1') return;
            img.dataset.fxInit = '1';
            try { img.decoding = 'async'; } catch(e){}
            // 再保险：如果 url 已在缓存里，立即 loaded（即便 render 时没命中）
            if(srcKey && __fx.loadedSrc.has(srcKey)){
              __markImgLoaded(img);
              return;
            }
            img.classList.add('skel-img');
            img.classList.add('is-loading');
            const done = () => {
              const p = (img.decode ? img.decode() : Promise.resolve());
              Promise.resolve(p).catch(() => {}).then(() => __markImgLoaded(img));
            };
            const fail = () => __markImgError(img);
            if(img.complete && img.naturalWidth > 0){
              done();
              return;
            }
            img.addEventListener('load', done, { once: true });
            img.addEventListener('error', fail, { once: true });
          });
        }
        function initCardFX(root){
          __initReveal(root);
          __initImages(root);
        }
        // ==========================================
        // 1. 数据中心
        // ==========================================
        const db = {
          categories: [
              { id: "classic", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-5a2f691a-f7d5-4d33-b3be-b84ecea1c831.jpeg",
                title: { cn: "永远的经典", en: "Eternal Classic", pt: "Clássico Eterno" },
                desc: { cn: "黑森林 / 提拉米苏 / 红丝绒", en: "Black Forest / Tiramisu / Red Velvet", pt: "Floresta Negra / Tiramisu" } },
              { id: "layer", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-0038becb-7292-4eea-93f7-9fa986281d21.jpeg",
                title: { cn: "招牌千层蛋糕", en: "Signature Layer Cake", pt: "Bolo de Mil Camadas" },
                desc: { cn: "手工制作，层层美味", en: "Handmade crepe layers", pt: "Camadas de crepe artesanais" } },
              { id: "naked", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-11f1f013-ffc3-4c14-a39e-af3edc99dab8.jpeg",
                title: { cn: "原生态裸蛋糕", en: "Naked Fruit Cake", pt: "Bolo Nu" },
                desc: { cn: "新鲜水果搭配香草戚风", en: "Fresh fruits with vanilla chiffon", pt: "Frutas frescas com chiffon" } },
              { id: "cheese", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-e4e9d0e4-c631-4a71-bd6a-52caa7a42fd2.jpeg",
                title: { cn: "芝士与慕斯", en: "Cheesecake & Mousse", pt: "Bolo de queijo e mousse" },
                desc: { cn: "天然食材，浓郁口感", en: "Natural ingredients", pt: "Ingredientes naturais" } },
              { id: "korean", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-153de66b-9952-45d1-9c9d-09d9b1015029.jpeg",
                title: { cn: "韩式奶油调味", en: "Korean Style Cream", pt: "Estilo Coreano" },
                desc: { cn: "清新风格，独特调味", en: "Fresh style, flavored cream", pt: "Estilo fresco" } },
              { id: "custom", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-0a61f906-d8d7-45b4-b0c2-c240d5b14e80.jpeg",
                title: { cn: "造型定制蛋糕", en: "Custom Design Cake", pt: "Bolo Personalizado" },
                desc: { cn: "有趣外表，好吃好玩", en: "Fun & Delicious", pt: "Divertido e delicioso" } }
          ],
          items: {
              "classic": [
                  { id:"c1", img:"https://dyj6gt4964deb.cloudfront.net/images/crop-b267cf6d-fb4d-4d57-9351-8c69c59c54b2.jpeg",
                    title:{ cn:"红丝绒乳酪蛋糕", en:"Red Velvet Cheesecake", pt:"Cheesecake de Veludo Vermelho" },
                    desc:{
                      en:"1. Appearance: The bright red cake layer and the white cheese layer form a sharp contrast, which is very visually attractive and especially suitable for festivals and celebrations.\n2. Taste: Red velvet cake is soft and moist, and paired with the rich cheese layer, it has a delicate taste, sweet but not greasy.\n3. Flavor: Red velvet cake usually has a hint of cocoa aroma, and paired with the slightly sour cheese, the overall taste is richer.",
                      pt:"1. Aparência: As camadas de bolo vermelho vivo contrastam nitidamente com as camadas de cream cheese branco, criando um efeito visual muito atraente, especialmente adequado para feriados e celebrações.\n2. Textura: O bolo de veludo vermelho é macio e úmido, combinado com as camadas ricas de cream cheese, resultando em uma textura delicada que é doce, mas não excessivamente.\n3. Sabor: O bolo de veludo vermelho geralmente tem um leve aroma de cacau, complementado pela leve acidez do cream cheese, tornando o sabor geral mais complexo e agradável.",
                      cn:"1. 外观： 鲜艳的红色蛋糕层和白色乳酪层形成鲜明对比，视觉效果非常吸引人，特别适合节日和庆典场合。\n2. 口感： 红丝绒蛋糕柔软湿润，搭配浓郁的乳酪层，口感细腻，甜而不腻。\n3. 风味： 红丝绒蛋糕通常带有一丝可可的香气，搭配乳酪的微酸，使整体口味更加丰富。"
                    },
                    variants:[
                      { id:"v1", names:{ cn:"6英寸", en:"6 inches", pt:"6 polegadas" }, price:42 },
                      { id:"v2", names:{ cn:"8英寸", en:"8 inches", pt:"8 polegadas" }, price:58 }
                    ]
                  },
                  { id:"c2", img:"https://dyj6gt4964deb.cloudfront.net/images/crop-25ad3750-4ed7-4c4f-a2cc-2d99925374a6.jpeg",
                    title:{ en:"Milk sauce black forest cake", cn:"奶酱黑森林蛋糕", pt:"Bolo floresta negra com molho de leite" },
                    desc:{
                      en:"A very rich chocolate sponge cake, with white chocolate cream, dark chocolate cream, and dark rum-stained black cherries in the middle layer. The improved Chantilly cream has a rich milky aroma. It is a classic handmade cake boutique with a blue ribbon",
                      cn:"非常浓郁的巧克力海绵蛋糕，夹层包含白巧奶油、黑巧奶油，以及黑朗姆酒渍黑樱桃，改良的香缇奶油奶香浓郁，是一款蓝带经典手工蛋糕精品",
                      pt:"Um pão de ló de chocolate muito rico com camadas de creme de chocolate branco, doce de leite de chocolate negro e cerejas pretas embebidas em rum escuro."
                    },
                    variants:[
                      { id:"v1", names:{ en:"6 inches", cn:"6寸", pt:"6 polegadas" }, price:40 },
                      { id:"v2", names:{ en:"8 inches", cn:"8寸", pt:"8 polegadas" }, price:55 }
                    ]
                  },
                  { id:"c3", img:"https://dyj6gt4964deb.cloudfront.net/images/crop-6f9816fc-5d8f-436d-a97c-baea35005112.jpeg",
                    title:{ pt:"Tiramisu Clássico", cn:"经典提拉米苏", en:"Classic Tiramisu" },
                    desc:{
                      pt:"Um bolo tiramisu italiano muito clássico, queijo mascarpone, bolachas, café expresso líquido, feito à mão com ingredientes frescos.",
                      cn:"非常经典的意式提拉米苏蛋糕，马斯卡彭芝士、手指饼干、意式浓缩咖啡液，新鲜食材手工制作，蛋糕上的整体装饰经过我们的蛋糕师的创作，更显得唯美精致",
                      en:"Very classic Italian tiramisu cake, mascarpone cheese, ladyfingers, espresso liquid, handmade with fresh ingredients, the overall decoration on the cake is created by our baker, making it more beautiful and exquisite"
                    },
                    variants:[
                      { id:"v1", names:{ pt:"6 polegadas", cn:"6寸", en:"6 inches" }, price:38 },
                      { id:"v2", names:{ pt:"8 polegadas", cn:"8寸", en:"8 inches" }, price:49 }
                    ]
                  }
              ],
              "layer": [
                  { id:"l1", img:"https://dyj6gt4964deb.cloudfront.net/images/38db952a-2ebb-4af1-b733-a223cede14f3.jpeg",
                    title:{ cn:"巧克力千层蛋糕", en:"Chocolate Melaleuca Cake", pt:"Bolo De Melaleuca De Chocolate" },
                    desc:{
                      cn:"浓郁的巧克力可丽饼，夹层为巧克力奶油，其中还有一层巧克力慕斯，如果你热爱浓郁的巧克力风味，一定不能错过",
                      en:"Rich chocolate crepe, sandwiched with chocolate cream and a layer of chocolate mousse. If you love rich chocolate flavor, you must not miss it.",
                      pt:"Rico crepe de chocolate, prensado com creme de chocolate e uma camada de mousse de chocolate."
                    },
                    variants:[
                      { id:"v1", names:{ cn:"4英寸", en:"4 inches", pt:"4 polegadas" }, price:23 },
                      { id:"v2", names:{ cn:"6英寸", en:"6 inches", pt:"6 polegadas" }, price:38 },
                      { id:"v3", names:{ cn:"8英寸", en:"8 inches", pt:"8 polegadas" }, price:48 }
                    ]
                  },
                  { id:"l2", img:"https://dyj6gt4964deb.cloudfront.net/images/crop-c168cd8a-0bc8-49bc-928e-0ed3239e0ac2.jpeg",
                    title:{ cn:"草莓千层蛋糕", en:"Strawberry Melaleuca Cake", pt:"Bolo De Melaleuca De Morango" },
                    desc:{ cn:"红丝绒口味的可丽饼皮，夹层为新鲜草莓熬制果酱融合白巧克力奶油，新鲜草莓点缀在蛋糕上面，口味清新独特",
                          en:"The red velvet crepe crust is sandwiched with fresh strawberry jam blended with white chocolate cream. Fresh strawberries are dotted on the cake, giving it a fresh and unique taste.",
                          pt:"Crosta de crepe com sabor a veludo vermelho, prensada com geleia de morango fresca e creme de chocolate branco, morangos frescos estão espalhados por cima do bolo e o sabor é fresco e único" },
                    variants:[
                      { id:"v1", names:{ cn:"4英寸", en:"4 inches", pt:"4 polegadas" }, price:23 },
                      { id:"v2", names:{ cn:"6英寸", en:"6 inches", pt:"6 polegadas" }, price:38 },
                      { id:"v3", names:{ cn:"8英寸", en:"8 inches", pt:"8 polegadas" }, price:48 }
                    ] },
                  { id:"l3", img:"https://dyj6gt4964deb.cloudfront.net/images/crop-3854a4fe-b655-42f2-8521-19638e9e5d9c.jpeg",
                    title:{ cn:"抹茶千层蛋糕", en:"Matcha Melaleuca Cake", pt:"Bolo Matcha Melaleuca" },
                    desc:{ cn:"特级日本宇治抹茶粉，夹层为抹茶口味的巧克力奶油，口感细腻，层次丰富",
                          en:"Premium Japanese Uji Matcha powder, with a layer of Matcha-flavored chocolate cream, for a delicate taste and rich layers",
                          pt:"Pó Uji matcha japonês de qualidade especial, prensado com creme de chocolate com sabor a matcha, com um sabor delicado e camadas ricas" },
                    variants:[
                      { id:"v1", names:{ cn:"4英寸", en:"4 inches", pt:"4 polegadas" }, price:25 },
                      { id:"v2", names:{ cn:"6英寸", en:"6 inches", pt:"6 polegadas" }, price:40 },
                      { id:"v3", names:{ cn:"8英寸", en:"8 inches", pt:"8 polegadas" }, price:55 }
                    ] },
                  { id:"l4", img:"https://dyj6gt4964deb.cloudfront.net/images/crop-2d13e6b9-ce8b-4516-a663-f9c90e1935ee.jpeg",
                    title:{ cn:"芒果千层蛋糕", en:"Mango Melaleuca Cake", pt:"Bolo Melaleuca De Manga" },
                    desc:{ cn:"香草口味的可丽饼，夹层包含芒果布丁和白巧奶油，点缀芒果果肉，清新爽口的夏天的感觉",
                          en:"Vanilla-flavored crepes with mango pudding and white chocolate cream in between, dotted with mango pulp, giving you a refreshing summer feel",
                          pt:"Crepe com sabor a baunilha, prensado com pudim de manga e creme de chocolate branco, embelezado com polpa de manga, refrescante sensação de verão" },
                    variants:[
                      { id:"v1", names:{ cn:"4英寸", en:"4 inches", pt:"4 polegadas" }, price:23 },
                      { id:"v2", names:{ cn:"6英寸", en:"6 inches", pt:"6 polegadas" }, price:36 },
                      { id:"v3", names:{ cn:"8英寸", en:"8 inches", pt:"8 polegadas" }, price:48 }
                    ] }
              ],
              "naked": [
                { id:"n1", img:"https://dyj6gt4964deb.cloudfront.net/images/crop-e378d704-2d39-4765-8f46-14c5ece07b85.jpeg",
                  title:{ cn:"香草奶油水果裸蛋糕", en:"Vanilla Cream Fruit Naked Cake", pt:"Bolo Nu De Fruta Com Creme De Baunilha" },
                  desc:{ cn:"香草戚风蛋糕结合白巧克力奶油，融合草莓、蓝莓、芒果等新鲜水果。口感柔软，清爽，层次丰富，非常健康美味。",
                        en:"Vanilla chiffon cake is combined with white chocolate cream and fresh fruits such as strawberries, blueberries, and mangoes. It has a soft, refreshing texture, rich layers, and is very healthy and delicious.",
                        pt:"O bolo chiffon de baunilha combina creme de chocolate branco com morangos, mirtilos, manga e outras frutas frescas. O sabor é suave, refrescante, rico em camadas, muito saudável e delicioso." },
                  variants:[
                    { id:"v1", names:{ cn:"6英寸", en:"6 inches", pt:"6 polegadas" }, price:32 },
                    { id:"v2", names:{ cn:"8英寸", en:"8 inches", pt:"8 polegadas" }, price:42 }
                  ] },
                { id:"n2", img:"https://dyj6gt4964deb.cloudfront.net/images/crop-414cc726-60e9-4bb5-a145-776fdbb67e13.jpeg",
                  title:{ cn:"抹茶青提裸蛋糕", en:"Matcha Grape Naked Cake", pt:"Bolo nu de chá verde Matcha" },
                  desc:{ cn:"抹茶青提裸蛋糕是一款非常典型的日式蛋糕。结合了清新抹茶奶油风味和爽口青提。简约自然，口感丰富多层次，清新茶香和水果融合后，充满质感和品位。",
                        en:"Matcha Grape Naked Cake is a very typical Japanese cake. It combines the fresh flavor of matcha cream and refreshing grapes. It is simple and natural, with a rich and multi-layered taste. The fusion of fresh tea fragrance and fruit is full of texture and taste.",
                        pt:"O bolo nu de chá verde Matcha é um bolo japonês muito típico. Combinando o sabor refrescante do creme matcha com as refrescantes uvas verdes. Simples e natural, o sabor é rico e multifacetado. O aroma do chá fresco e a fruta combinam-se para o tornar cheio de textura e sabor." },
                  variants:[
                    { id:"v1", names:{ cn:"6英寸", en:"6 inches", pt:"6 polegadas" }, price:33 },
                    { id:"v2", names:{ cn:"8英寸", en:"8 inches", pt:"8 polegadas" }, price:45 }
                  ] },
                { id:"n3", img:"https://dyj6gt4964deb.cloudfront.net/images/crop-175c858c-f49c-4209-bfbc-a3ea7bb6a109.jpeg",
                  title:{ cn:"巧克力水果奶油裸蛋糕", en:"Chocolate Fruit Cream Naked Cake", pt:"Bolo Nu De Creme De Frutas De Chocolate" },
                  desc:{ cn:"巧克力水果奶油裸蛋糕是一款结合了巧克力的浓郁香味、奶油的丝滑口感和新鲜水果清爽风味的美味蛋糕。非常适合用于生日、婚礼、节日聚会等各种庆祝活动。",
                        en:"Chocolate Fruit Cream Naked Cake is a delicious cake that combines the rich aroma of chocolate, the smooth taste of cream and the refreshing flavor of fresh fruit. It is very suitable for various celebrations such as birthdays, weddings, holiday parties, etc.",
                        pt:"Chocolate Cream Fruit Naked Cake é um delicioso bolo que combina o rico aroma do chocolate, a textura sedosa do creme e o sabor refrescante da fruta fresca. Perfeito para diversas celebrações, como aniversários, casamentos, festas de fim de ano e muito mais." },
                  variants:[
                    { id:"v1", names:{ cn:"6英寸", en:"6 inches", pt:"6 polegadas" }, price:33 },
                    { id:"v2", names:{ cn:"8英寸", en:"8 inches", pt:"8 polegadas" }, price:48 }
                  ] }
              ],
              "custom": [
                { id:"u1", img: "https://dyj6gt4964deb.cloudfront.net/images/crop-450495cd-b008-4019-9569-55546dc3f80b.jpeg",
                  title: { cn: "情侣兔子蛋糕", en: "Couple Rabbit Cake", pt: "Bolo de Coelho Casal" },
                  desc: { cn: "卡通兔子风格。可选巧克力，柠檬，抹茶等口味。", en: "Cartoon style. Available in 4/6 inch.", pt: "Estilo cartoon. Tamanhos 4/6 pol." },
                  variants: [
                    { id:"v1", names: { cn: "4英寸", en: "4 inches", pt: "4 polegadas" }, price: 25 },
                    { id:"v2", names: { cn: "6英寸", en: "6 inches", pt: "6 polegadas" }, price: 38 }
                  ] }
              ]
          }
        };
        let state = {
          lang: 'en',
          isSearchMode: false,
          cart: [],
          modal: { item: null, variant: null, qty: 1, editUid: null, editProductId: null, variantQty: {} },
          scroll: { home: { en: 0, pt: 0, cn: 0 } },
          currentCategoryId: null
        };
// ==========================================
// [NEW] Auto language detect + persist
// en / pt / cn, else en
const LANG_KEY = 'neco_lang_v1';
const LANG_LOCK_KEY = 'neco_lang_lock_v1';
function isLangLocked(){
  try{ return localStorage.getItem(LANG_LOCK_KEY) === '1'; }catch(e){ return false; }
}
function lockLang(){
  try{ localStorage.setItem(LANG_LOCK_KEY, '1'); }catch(e){}
}
function unlockLang(){
  // 可选：给“跟随系统”用
  try{
    localStorage.removeItem(LANG_LOCK_KEY);
    localStorage.removeItem(LANG_KEY);
  }catch(e){}
}
function _normLocale(s){
  return String(s || '')
    .trim()
    .toLowerCase()
    .replace('_', '-');
}
function detectSystemLang(){
  const candidates = [];
  // 优先 navigator.languages（更准确）
  if (Array.isArray(navigator.languages)) candidates.push(...navigator.languages);
  if (navigator.language) candidates.push(navigator.language);
  // 再保险：Intl locale
  try{
    const loc = Intl.DateTimeFormat().resolvedOptions().locale;
    if (loc) candidates.push(loc);
  }catch(e){}
  for (const raw of candidates) {
    const l = _normLocale(raw);
    if (!l) continue;
    // Portuguese
    if (l.startsWith('pt')) return 'pt';
    // Chinese (zh-CN / zh-Hans / zh-Hant / zh-TW ...)
    if (l.startsWith('zh')) return 'cn';
    // English
    if (l.startsWith('en')) return 'en';
    // 极少数情况：直接给 cn
    if (l.startsWith('cn')) return 'cn';
  }
  return 'en';
}
function loadPreferredLang(){
  // 只有用户手动选择过（锁定）才用缓存
  try{
    if (isLangLocked()){
      const saved = localStorage.getItem(LANG_KEY);
      if (saved && ['en','pt','cn'].includes(saved)) return saved;
    }
  }catch(e){}
  // 否则每次都重新按系统语言检测（不缓存）
  return detectSystemLang();
}
function persistLang(l){
  try{ localStorage.setItem(LANG_KEY, l); }catch(e){}
}
        // ==========================================
        // 2. Cart persistence
        // ==========================================
        const CART_KEY = 'neco_cart_v2';
        function _isValidCartItem(it){
          return it && typeof it === 'object'
            && typeof it.uid === 'string'
            && typeof it.productId === 'string'
            && typeof it.variantId === 'string'
            && typeof it.qty === 'number';
        }
        function saveCart(){
          try{
            const data = state.cart.map(it => ({
              uid: it.uid,
              productId: it.productId,
              variantId: it.variantId,
              qty: it.qty
            }));
            localStorage.setItem(CART_KEY, JSON.stringify({
              v: 2,
              updatedAt: Date.now(),
              cart: data
            }));
          }catch(e){
            console.warn('saveCart failed', e);
          }
        }
        function loadCart(){
          try{
            const raw = localStorage.getItem(CART_KEY);
            if(!raw) return;
            const obj = JSON.parse(raw);
            const arr = (obj && obj.cart) ? obj.cart : obj;
            if(!Array.isArray(arr)) return;
            state.cart = arr
              .filter(_isValidCartItem)
              .map(it => ({
                uid: it.uid,
                productId: it.productId,
                variantId: it.variantId,
                qty: Math.max(1, Number(it.qty) || 1)
              }));
          }catch(e){
            console.warn('loadCart failed', e);
          }
        }
        function findItemById(productId){
          for(const cat in db.items){
            const hit = (db.items[cat] || []).find(p => p.id === productId);
            if(hit) return hit;
          }
          return null;
        }
        function resolveCartItem(ci){
          const item = findItemById(ci.productId);
          if(!item){
            return { missing: true, uid: ci.uid, qty: ci.qty, productId: ci.productId, variantId: ci.variantId };
          }
          const variant = (item.variants || []).find(v => v.id === ci.variantId);
          if(!variant){
            return { missing: true, uid: ci.uid, qty: ci.qty, productId: ci.productId, variantId: ci.variantId, img: item.img, title: item.title };
          }
          return {
            missing: false,
            uid: ci.uid,
            qty: ci.qty,
            productId: ci.productId,
            variantId: ci.variantId,
            img: item.img,
            title: item.title,
            variantNames: variant.names,
            price: variant.price,
            _item: item,
            _variant: variant
          };
        }
        // ==========================================
        // 3. 多语言文案
        // ==========================================
        const texts = {
          cn: {
            back: "返回分类", homeTitle: "主页", select: "选择规格", add: "加入订单", update: "更新订单",
            view: "查看订单", more: "查看详情", order: "我的订单", total: "总计",
            confirm: "确认下单", remove: "移除此商品", empty: "购物车为空",
            added: "已加入订单", updated: "订单已更新", editHint: "点击编辑",
            searchPh: "搜索蛋糕...", noResult: "未找到相关商品", fallback: "当前语言无结果，已展示其他语言匹配。",
            missing: "该商品已下架或规格已变更，请移除后重新选择。",
            missingTitle: "已下架商品",
            missingVariant: "规格不可用",
            removeHintMissing: "请移除"
          },
          en: {
            back: "Back", homeTitle: "Home", select: "Select Size", add: "Add to Order", update: "Update Order",
            view: "View Order", more: "More Info", order: "Your Order", total: "Total",
            confirm: "Confirm", remove: "Remove Item", empty: "Empty Cart",
            added: "Added to Order", updated: "Order Updated", editHint: "Edit item",
            searchPh: "Search cakes...", noResult: "No results found", fallback: "No results in English, showing matches from other languages.",
            missing: "Item unavailable (menu updated). Please remove and re-add.",
            missingTitle: "Unavailable item",
            missingVariant: "Variant unavailable",
            removeHintMissing: "REMOVE"
          },
          pt: {
            back: "Voltar", homeTitle: "Início", select: "Selecione o Tamanho", add: "Adicionar", update: "Atualizar",
            view: "Ver Pedido", more: "Mais Info", order: "Seu Pedido", total: "Total",
            confirm: "Confirmar", remove: "Remover Item", empty: "Carrinho Vazio",
            added: "Adicionado", updated: "Atualizado", editHint: "Editar item",
            searchPh: "Pesquisar bolos...", noResult: "Nenhum resultado", fallback: "Sem resultados em Português, a mostrar outras línguas.",
            missing: "Item indisponível (menu atualizado). Remova e adicione novamente.",
            missingTitle: "Item indisponível",
            missingVariant: "Variante indisponível",
            removeHintMissing: "REMOVER"
          }
        };
let __lastSystemLang = detectSystemLang();
function applySystemLangIfUnlocked(){
  if (isLangLocked()) return;
  const sys = detectSystemLang();
  if (sys !== state.lang){
    // 自动切换：不写缓存
    setLang(sys, false);
  }
  __lastSystemLang = sys;
}
function startAutoLangWatch(){
  // 有些浏览器支持
  window.addEventListener('languagechange', applySystemLangIfUnlocked);
  // 双保险：轮询检测变化（你可以改成 2000/3000ms）
  setInterval(() => {
    if (isLangLocked()) return;
    const now = detectSystemLang();
    if (now !== __lastSystemLang){
      applySystemLangIfUnlocked();
    }
  }, 2000);
}
function bindOverlayTouchBlock() {
  ['product-modal', 'cart-modal'].forEach((id) => {
    const overlay = document.getElementById(id);
    if (!overlay) return;
    overlay.addEventListener('touchmove', (e) => {
      const inModalScroll = e.target.closest('.modal-scroll') || e.target.closest('.cart-list');
      if (!inModalScroll) e.preventDefault();
    }, { passive: false });
  });
}
        init();
        function init() {
  loadCart();
  const initialLang = loadPreferredLang();
  setLang(initialLang, false); // 自动：不缓存
  startAutoLangWatch();
  updateCartBar();
  // ✅ 只在“首次进入/没有state”时写入 home 状态，避免覆盖其它状态
  if (!history.state || !history.state.view) {
    history.replaceState({ view: 'home' }, '');
  }
  bindOverlayTouchBlock();
}
        function setLang(l, userChosen = false) {
  if (!['en','pt','cn'].includes(l)) l = 'en';
  state.lang = l;
  // ✅ 只有用户手动切换才持久化 + 锁定
  if (userChosen){
    persistLang(l);
    lockLang();
  }
  document.documentElement.lang = (l === 'cn') ? 'zh-CN' : l;
  document.querySelectorAll('.lang-btn').forEach(b => {
    b.classList.toggle('active', b.innerText.toLowerCase() === l);
  });
  updateUI();
  if(state.isSearchMode) handleSearch();
}
        function onSearchKeyDown(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            const input = e.target;
            input.blur();
            handleSearch();
          }
        }
        function updateTopButtonLabel() {
          const isHome = document.getElementById('view-home').classList.contains('active');
          const t = texts[state.lang];
          const txt = document.getElementById('txt-back');
          if (txt) txt.innerText = isHome ? t.homeTitle : t.back;
          const nav = document.querySelector('.back-nav');
          if (!nav) return;
          if (isHome) {
            nav.style.setProperty('--nav-icon', 'url("https://i.ibb.co/kVS4zpC5/IMG-20251219-152124.png")');
            nav.style.setProperty('--nav-icon-size', '22.5px');
          } else {
            nav.style.setProperty('--nav-icon', 'url("https://lestoy.com/love/icones/back.svg")');
            nav.style.setProperty('--nav-icon-size', '18px');
          }
        }
        function updateUI() {
            const t = texts[state.lang];
            const ids = {
                'txt-view-order': t.view, 'txt-your-order': t.order,
                'txt-select-size': t.select,
                'txt-total': t.total, 'txt-remove': t.remove
            };
            for(let id in ids) {
                const el = document.getElementById(id);
                if(el) el.innerText = ids[id];
            }
            document.getElementById('search-input').placeholder = t.searchPh;
            if (document.getElementById('view-home').classList.contains('active') && !state.isSearchMode) {
              state.scroll.home[state.lang] = window.scrollY || 0;
              renderHome(true);
            } else if (!state.isSearchMode) {
              if (document.getElementById('view-category').classList.contains('active') && state.currentCategoryId) {
                const y = window.scrollY || 0;
                renderCategory(state.currentCategoryId, { skipSaveHome: true, keepScrollY: y });
              }
            }
            const hint = state.lang === 'cn' ? 'search' : 'search';
            document.getElementById('search-input').setAttribute('enterkeyhint', hint);
            updateCartBar();
            if(document.getElementById('cart-modal').style.display === 'flex') openCartModal();
            refreshProductModalUI();
            updateTopButtonLabel();
        }
        function renderHome(restoreScroll = false) {
          const grid = document.getElementById('category-grid');
          grid.innerHTML = db.categories.map(c => {
              const key = `home-cat-${c.id}`;
              return `
                <div class="${__cardClass(key,'cat-card')}" data-reveal-key="${key}" onclick="renderCategory('${c.id}')">
                    <div class="cat-img-box">
                      <img src="${c.img}" class="${__imgClass(c.img,'cat-img')}" ${__imgDataAttrs(c.img)} loading="lazy" alt="">
                    </div>
                    <div class="cat-info">
                        <div class="cat-title">${c.title[state.lang]}</div>
                        <div class="cat-desc">${c.desc[state.lang]}</div>
                    </div>
                </div>
              `;
          }).join('');
          initCardFX(grid);
          const saved = state.scroll.home[state.lang] || 0;
          switchView('view-home', restoreScroll ? { scrollTop: saved } : {});
        }
        function renderCategory(id, opts = {}) {
          state.currentCategoryId = id;
          history.pushState({ view: 'category' }, '');
          if (!opts.skipSaveHome) {
            state.scroll.home[state.lang] = window.scrollY || window.pageYOffset || 0;
          }
          const items = db.items[id] || [];
          const container = document.getElementById('category-content');
          renderProductList(container, items, id);
          if (typeof opts.keepScrollY === 'number') {
            switchView('view-category', { scrollTop: opts.keepScrollY });
          } else {
            switchView('view-category');
          }
        }
        function renderProductList(container, items, catId) {
            container.innerHTML = `
                <div class="product-list">
                    ${items.map((item, idx) => {
                      const key = `prod-${item.id}`;
                      return `
                        <div class="${__cardClass(key,'prod-card')}" data-reveal-key="${key}">
                            <img src="${item.img}" class="${__imgClass(item.img,'prod-img')}" ${__imgDataAttrs(item.img)} loading="lazy" alt="">
                            <div class="prod-body">
                                <div class="prod-title">${item.title[state.lang] || item.title['en']}</div>
                                <div class="prod-desc">${item.desc[state.lang] || item.desc['en']}</div>
                                <div class="prod-footer">
                                    <button class="btn-action" onclick="openProductModal('${item._catId || catId}', ${item._idx !== undefined ? item._idx : idx})">
                                        ${texts[state.lang].more}
                                    </button>
                                </div>
                            </div>
                        </div>
                      `;
                    }).join('')}
                </div>
            `;
            initCardFX(container);
        }
        function switchView(viewId, opts = {}) {
          document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
          document.getElementById(viewId).classList.add('active');
          updateTopButtonLabel();
          if (opts.noScroll) return;
          const top = typeof opts.scrollTop === 'number' ? opts.scrollTop : 0;
          requestAnimationFrame(() => window.scrollTo(0, top));
        }
        function goBack() {
          const isHome = document.getElementById('view-home').classList.contains('active');
          if (isHome) return;
          if (state.isSearchMode) clearSearch();
          else renderHome(true);
        }
        // --- Search Logic ---
        function handleSearch() {
            const query = document.getElementById('search-input').value.trim().toLowerCase();
            document.getElementById('search-clear').style.display = query.length > 0 ? 'block' : 'none';
            if(query.length < 1) {
                if(state.isSearchMode) {
                    state.isSearchMode = false;
                    renderHome();
                }
                return;
            }
            if (!state.isSearchMode) {
              history.pushState({ view: 'search' }, '');
            }
            state.isSearchMode = true;
            let allItems = [];
            for(let cat in db.items) {
                db.items[cat].forEach((item, idx) => {
                    item._catId = cat; item._idx = idx;
                    allItems.push(item);
                });
            }
            const lang = state.lang;
            let results = allItems.filter(item => {
                const t = (item.title[lang] || '').toLowerCase();
                const d = (item.desc[lang] || '').toLowerCase();
                return t.includes(query) || d.includes(query);
            });
            if(results.length === 0) {
                results = allItems.filter(item => {
                    return Object.values(item.title).some(v => v.toLowerCase().includes(query)) ||
                           Object.values(item.desc).some(v => v.toLowerCase().includes(query));
                });
            }
            const container = document.getElementById('category-content');
            if(results.length > 0) {
                renderProductList(container, results, null);
            } else {
                container.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">${texts[state.lang].noResult}</div>`;
            }
            switchView('view-category');
        }
        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-clear').style.display = 'none';
            state.isSearchMode = false;
            renderHome();
        }
        // ===== Scroll Lock (防弹窗打开时外层还能滚) =====
let __scrollLockCount = 0;
let __lockedScrollY = 0;
function lockBodyScroll() {
  __scrollLockCount++;
  if (__scrollLockCount > 1) return;
  __lockedScrollY = window.scrollY || window.pageYOffset || 0;
  document.documentElement.classList.add('no-scroll');
  document.body.classList.add('no-scroll');
  // 关键：固定 body 时用 top 抵消当前滚动位置，避免页面跳回顶部
  document.body.style.top = `-${__lockedScrollY}px`;
}
function unlockBodyScroll() {
  if (__scrollLockCount === 0) return;
  __scrollLockCount--;
  if (__scrollLockCount > 0) return;
  document.documentElement.classList.remove('no-scroll');
  document.body.classList.remove('no-scroll');
  document.body.style.top = '';
  window.scrollTo(0, __lockedScrollY);
}
        // --- Modal Logic ---
        function getProductQtyMapFromCart(productId){
            const preset = {};
            for(const ci of state.cart){
              if(ci.productId === productId){
                preset[ci.variantId] = (preset[ci.variantId] || 0) + (Number(ci.qty) || 0);
              }
            }
            return preset;
        }
        function buildVariantQtyMap(item, preset){
            const m = {};
            (item.variants || []).forEach(v => {
              const q = preset && preset[v.id] !== undefined ? Number(preset[v.id]) : 0;
              m[v.id] = Math.max(0, isFinite(q) ? q : 0);
            });
            return m;
        }
        function renderVariantQtyList(){
            const item = state.modal.item;
            const vList = document.getElementById('variant-list');
            if(!item || !vList) return;
            vList.innerHTML = (item.variants || []).map(v => {
                const name = v.names[state.lang] || v.names['en'];
                const priceText = `€ ${Number(v.price).toFixed(2)}`;
                const q = state.modal.variantQty[v.id] || 0;
                return `
                <div class="v-item" data-vid="${v.id}">
                    <div class="v-left">
                        <span class="v-name">${name}</span>
                        <span class="v-subprice">${priceText}</span>
                    </div>
                    <div class="v-qty">
                        <div class="v-qty-btn" onclick="event.stopPropagation(); adjustVariantQty('${v.id}', -1)">-</div>
                        <span class="v-qty-val" id="v-qty-${v.id}">${q}</span>
                        <div class="v-qty-btn" onclick="event.stopPropagation(); adjustVariantQty('${v.id}', 1)">+</div>
                    </div>
                </div>
                `;
            }).join('');
        }
        function adjustVariantQty(variantId, delta){
            if(!state.modal || !state.modal.variantQty) return;
            const cur = Number(state.modal.variantQty[variantId]) || 0;
            let next = cur + delta;
            if(next < 0) next = 0;
            state.modal.variantQty[variantId] = next;
            const el = document.getElementById('v-qty-' + variantId);
            if(el) el.innerText = next;
            updateModalPrice();
        }
        function _formatCtaText(qty, amount){
          const a = `€${Number(amount).toFixed(2)}`;
          const dot = ' · ';
          if(state.lang === 'cn') return `添加${qty}${dot}${a}`;
          if(state.lang === 'pt') return `Adicionar ${qty}${dot}${a}`;
          return `Add ${qty}${dot}${a}`;
        }
        function refreshProductModalUI(){
            if(document.getElementById('product-modal').style.display !== 'flex') return;
            const item = state.modal.item;
            if(!item) return;
            document.getElementById('m-title').innerText = item.title[state.lang] || item.title['en'];
            document.getElementById('m-desc').innerText = item.desc[state.lang] || item.desc['en'];
            renderVariantQtyList();
            updateModalPrice();
        }
        function openProductModal(catId, itemIdx, editCartItem = null) {
            let item;
            let preset = {};
            if (editCartItem) {
                item = findItemById(editCartItem.productId);
                if(!item){
                  showToast(texts[state.lang].missing);
                  return;
                }
                preset = getProductQtyMapFromCart(item.id);
                state.modal.editProductId = item.id;
            } else {
                item = db.items[catId][itemIdx];
                state.modal.editProductId = null;
            }
            state.modal.item = item;
            state.modal.variantQty = buildVariantQtyMap(item, preset);
            document.getElementById('m-img').src = item.img;
            document.getElementById('m-title').innerText = item.title[state.lang] || item.title['en'];
            document.getElementById('m-desc').innerText = item.desc[state.lang] || item.desc['en'];
            renderVariantQtyList();
            updateModalPrice();
            const modal = document.getElementById('product-modal');
            const shell = document.getElementById('modal-shell');
            modal.style.display = 'flex';
lockBodyScroll();
            modal.style.opacity = 1;
            requestAnimationFrame(() => shell.classList.add('open'));
            history.pushState({ modal: true }, '');
        }
        function updateModalPrice() {
            const item = state.modal.item;
            if(!item) return;
            let totalQty = 0;
            let total = 0;
            (item.variants || []).forEach(v => {
              const q = Number(state.modal.variantQty && state.modal.variantQty[v.id]) || 0;
              totalQty += q;
              total += q * (Number(v.price) || 0);
            });
            const label = document.getElementById('txt-add-btn');
            if(label) label.innerText = _formatCtaText(totalQty, total);
            const btn = document.querySelector('#product-modal .btn-add-cart');
            if(btn){
              btn.disabled = totalQty <= 0;
              btn.style.opacity = totalQty <= 0 ? 0.6 : 1;
            }
        }
        function _hideProductModal() {
  const modal = document.getElementById('product-modal');
  const shell = document.getElementById('modal-shell');
  shell.classList.remove('open');
  modal.style.opacity = 0;
  state.modal.editProductId = null;
  state.modal.variantQty = {};
  setTimeout(() => {
    modal.style.display = 'none';
    unlockBodyScroll();
  }, 300);
}
function closeModalDirect() {
  _hideProductModal();
}
        function closeModal(e) { if(e.target.id === 'product-modal') closeModalDirect(); }
        // --- Cart Logic ---
        function confirmAddToCart() {
            const item = state.modal.item;
            const qtyMap = state.modal.variantQty || {};
            if(!item) return;
            const isEdit = !!state.modal.editProductId;
            let picked = 0;
            for(const v of (item.variants || [])){
              picked += (Number(qtyMap[v.id]) || 0);
            }
            if(picked <= 0){
              showToast(state.lang === 'cn' ? '先来点数量呀～' : (state.lang === 'pt' ? 'Escolha uma quantidade 🙂' : 'Pick a qty 🙂'));
              return;
            }
            if (isEdit) {
                for (const v of (item.variants || [])) {
                    const desired = Math.max(0, Number(qtyMap[v.id]) || 0);
                    const existing = state.cart.find(c => c.productId === item.id && c.variantId === v.id);
                    if (desired > 0) {
                        if (existing) existing.qty = desired;
                        else state.cart.push({ uid: String(Date.now() + Math.random()), productId: item.id, variantId: v.id, qty: desired });
                    } else {
                        if (existing) state.cart.splice(state.cart.indexOf(existing), 1);
                    }
                }
            } else {
                for (const v of (item.variants || [])) {
                    const addQty = Math.max(0, Number(qtyMap[v.id]) || 0);
                    if (addQty <= 0) continue;
                    const existing = state.cart.find(c => c.productId === item.id && c.variantId === v.id);
                    if (existing) existing.qty += addQty;
                    else state.cart.push({ uid: String(Date.now() + Math.random()), productId: item.id, variantId: v.id, qty: addQty });
                }
            }
            closeModalDirect();
            saveCart();
            updateCartBar();
            showToast(isEdit ? texts[state.lang].updated : texts[state.lang].added);
            if(document.getElementById('cart-modal').style.display === 'flex') openCartModal();
        }
        function updateCartBar() {
            let totalQty = 0;
            let totalPrice = 0;
            for(const ci of state.cart){
              totalQty += ci.qty;
              const r = resolveCartItem(ci);
              if(!r.missing) totalPrice += (r.price * r.qty);
            }
            const countEl = document.getElementById('cart-count');
            if(countEl) countEl.innerText = totalQty;
            const legacyTotalEl = document.getElementById('cart-bar-total');
            if(legacyTotalEl) legacyTotalEl.innerText = `€ ${totalPrice.toFixed(2)}`;
            const labelEl = document.getElementById('sticky-cart-label');
            if(labelEl){
              const view = texts[state.lang].view || 'View';
              labelEl.innerText = `${view} ${totalQty} €${totalPrice.toFixed(2)}`;
            }
        }
        function openCartModal() {
          const list = document.getElementById('cart-list');
          list.innerHTML = '';
          if (state.cart.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:40px; color:#999;">${texts[state.lang].empty}</div>`;
          } else {
            state.cart.forEach((ci) => {
              const r = resolveCartItem(ci);
              const div = document.createElement('div');
              div.className = 'cart-item';
              div.onclick = (e) => {
                if (e.target.closest('.mini-btn')) return;
                if (r.missing) {
                  showToast(texts[state.lang].missing);
                  return;
                }
                openProductModal(null, null, ci);
              };
              const img = r.img || 'https://via.placeholder.com/140x140?text=%20';
              const title = r.title ? (r.title[state.lang] || r.title['en']) : texts[state.lang].missingTitle;
              const sku = r.variantNames ? (r.variantNames[state.lang] || r.variantNames['en']) : texts[state.lang].missingVariant;
              const lineTotal = (!r.missing && typeof r.price === 'number') ? (r.price * r.qty) : 0;
              const hintText = r.missing ? texts[state.lang].removeHintMissing : texts[state.lang].editHint;
              div.innerHTML = `
                <img src="${img}" class="cart-img">
                <div class="cart-info">
                  <div class="c-title">${title}</div>
                  <div class="c-sku">${sku}</div>
                  <div class="c-price">€ ${lineTotal.toFixed(2)}</div>
                </div>
                <div class="cart-actions">
                  <div class="mini-qty">
                    <div class="mini-btn" onclick="updateCartItemQty('${ci.uid}', -1)">-</div>
                    <span style="margin:0 5px;">${ci.qty}</span>
                    <div class="mini-btn" onclick="updateCartItemQty('${ci.uid}', 1)">+</div>
                  </div>
                  <div class="edit-hint">${hintText}</div>
                </div>
              `;
              list.appendChild(div);
            });
          }
          let total = 0;
          for (const ci of state.cart) {
            const r = resolveCartItem(ci);
            if (!r.missing) total += (r.price * r.qty);
          }
          document.getElementById('cart-modal-total').innerText = `€ ${total.toFixed(2)}`;
          const modal = document.getElementById('cart-modal');
          const shell = document.getElementById('cart-shell');
          modal.style.display = 'flex';
lockBodyScroll();
          modal.style.opacity = 1;
          requestAnimationFrame(() => shell.classList.add('open'));
          history.pushState({ modal: true }, '');
        }
        function updateCartItemQty(uid, delta) {
            const item = state.cart.find(c => c.uid === uid);
            if(item) {
                item.qty += delta;
                if(item.qty <= 0) state.cart.splice(state.cart.indexOf(item), 1);
                saveCart();
                updateCartBar();
                openCartModal();
            }
        }
        function _hideCartModal() {
  const modal = document.getElementById('cart-modal');
  const shell = document.getElementById('cart-shell');
  shell.classList.remove('open');
  modal.style.opacity = 0;
  setTimeout(() => {
    modal.style.display = 'none';
    unlockBodyScroll();
  }, 300);
}
function closeCartDirect() {
  _hideCartModal();
}
        function closeCart(e) { if(e.target.id === 'cart-modal') closeCartDirect(); }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 1000);
        }
        // ===== 手机返回键拦截（修复版）=====
window.addEventListener('popstate', function (e) {
  const productModal = document.getElementById('product-modal');
  if (productModal.style.display === 'flex') {
    _hideProductModal();   // 只关UI，不要pushState
    return;
  }
  const cartModal = document.getElementById('cart-modal');
  if (cartModal.style.display === 'flex') {
    _hideCartModal();      // 只关UI，不要pushState
    return;
  }
  // 没有弹窗，才做页面级返回
  const isHome = document.getElementById('view-home').classList.contains('active');
  if (!isHome) {
    goBack();              // 你现有逻辑
    return;
  }
});
    </script>
</body>
</html>