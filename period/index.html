<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>ç»æœŸ & æ’åµé¢„æµ‹</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* â€”â€”â€” 1. æ ¸å¿ƒè®¾è®¡è¯­è¨€ â€”â€”â€” */
:root{
  --primary:#FF7EAE;       /* ç»æœŸç²‰ */
  --primary-bg: #FFF0F5;
  --birthday:#FF9B7E;      /* è¾…åŠ©æ©™ */
  --fertile:#B19CD9;       /* æ’åµç´« */
  --fertile-bg:#F3EFFF;    /* æ’åµæ·¡ç´«èƒŒæ™¯ */
  --bg:#F9FAFB;
  --card-bg:#fff;
  --text:#343434;
  --gray-text: #888;
  --gutter:1rem;
  --topH:3.5rem;
  --radius: 1.2rem;
}

*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}

body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif;
    background:var(--bg);
    color:var(--text);
    line-height:1.6;
    padding-bottom: 2rem;
}

body.noscroll { overflow: hidden; }

/* é¡¶æ  */
#topbar{
    position:sticky;top:0;z-index:200;
    display:flex;align-items:center;justify-content:center;
    height:var(--topH);
    font-weight:700;font-size:1.1rem;
    background:rgba(255,255,255,0.95);
    backdrop-filter: blur(10px);
    border-bottom:1px solid rgba(0,0,0,0.05);
}
#toolbar{position:absolute;right:1rem;display:flex;gap:1rem}
#toolbar img{width:1.4rem;height:1.4rem;cursor:pointer; opacity: 0.7; }

/* å¡ç‰‡ç³»ç»Ÿ */
main{max-width:600px;margin:0 auto;padding:1.2rem 1rem 0}

.card{
    background:var(--card-bg);
    border-radius:var(--radius);
    box-shadow:0 4px 16px rgba(0,0,0,0.04);
    overflow:hidden;
    margin-bottom: 1.5rem;
    padding: 1.2rem;
    animation: fadeUp 0.5s ease backwards;
}
@keyframes fadeUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }

.card-header { margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; }
.card-title { font-size: 1.1rem; font-weight: 700; color: var(--primary); }

/* â€”â€”â€” é¦–é¡µçŠ¶æ€å¡ç‰‡ â€”â€”â€” */
.status-box { text-align: center; padding: 1rem 0; }
.empty-tip { color: var(--gray-text); font-size: 0.95rem; margin-bottom: 1.5rem; }
.btn-main-action {
    background: var(--primary); color: #fff; border: none;
    padding: 0.8rem 2rem; border-radius: 2rem; font-size: 1rem; font-weight: 600;
    box-shadow: 0 4px 12px rgba(255, 126, 174, 0.4); cursor: pointer;
    transition: transform 0.2s; display: inline-flex; align-items: center; gap: 8px;
}
.btn-main-action:active { transform: scale(0.96); }
.btn-icon-small { width: 1.1rem; height: 1.1rem; filter: brightness(0) invert(1); }

/* â€”â€”â€” é¢„æµ‹ç»“æœ â€”â€”â€” */
.prediction-highlight { text-align: center; padding: 0.5rem 0; }
.prediction-highlight .date { font-size: 2.5rem; font-weight: 700; color: var(--primary); line-height: 1.2; margin: 0.5rem 0; }
.prediction-highlight .label { font-size: 0.9rem; color: #888; }
.prediction-highlight .range-badge { 
    display: inline-block; background: #f4f4f4; color: #666; 
    padding: 0.3rem 1rem; border-radius: 2rem; font-size: 0.85rem; margin-top: 0.5rem; 
}

/* â€”â€”â€” æ’åµä¸æ˜“å­•æœŸ â€”â€”â€” */
.ovulation-card .card-title, .ovulation-highlight .date { color: var(--fertile); }
.fertile-window-box {
    background: var(--fertile-bg); border-radius: 1rem; padding: 1rem; margin-top: 1rem;
    display: flex; align-items: center; justify-content: space-between;
}
.fertile-info h4 { color: var(--fertile); font-size: 0.95rem; margin-bottom: 0.2rem; }
.fertile-info div { font-size: 0.85rem; color: #666; }
.icon-heart { font-size: 1.5rem; color: var(--fertile); animation: pulse 2s infinite; }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }

.timeline-container { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #f5f5f5; }
.timeline-bar { display: flex; height: 10px; border-radius: 5px; overflow: hidden; background: #eee; }
.t-seg { height: 100%; }
.t-safe { background: #E0E0E0; flex: 2; }
.t-fertile { background: var(--fertile); opacity: 0.6; flex: 1; }
.t-ovulation { background: var(--fertile); flex: 0.4; }
.t-period { background: var(--primary); flex: 1; }
.timeline-legend { display: flex; gap: 1rem; justify-content: center; margin-top: 0.8rem; font-size: 0.75rem; color: #888; }
.dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px;}

/* â€”â€”â€” å‘¨æœŸåˆ†æ â€”â€”â€” */
.card.analysis { border-top: none; } 
.card.analysis .card-title { color: var(--birthday); }
.stats-grid { display: flex; justify-content: space-between; gap: 0.8rem; margin-top: 2.25rem; }
.stat-box {
    flex: 1; background: #FAFAFA; border-radius: 1rem; padding: 1rem 0.2rem;
    text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center;
}
.stat-label { font-size: 0.75rem; color: #999; margin-bottom: 0.4rem; }
.stat-value { font-size: 1.3rem; font-weight: 700; color: var(--text); line-height: 1.2; }
.stat-value.highlight { color: var(--birthday); }


/* â€”â€”â€” 5. å¼¹çª—æ—¥å†æ ·å¼ â€”â€”â€” */
.modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.45);
    display: none; align-items: center; justify-content: center; z-index: 999;
    backdrop-filter: blur(3px);
}
.modal.show { display: flex; }
.modal-box {
    background: #fff; border-radius: 1.5rem;
    width: 350px; max-width: 92vw;
    padding: 1.5rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* æ—¥å†å¤´éƒ¨ */
.cal-ctrl-bar {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 1rem; padding: 0 0.2rem;
}
.cal-month-label { font-size: 1.1rem; font-weight: 700; color: var(--text); }
.btn-month-nav {
    background: none; border: none; padding: 0.5rem; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    opacity: 0.6;
}
/* å»é™¤ç‚¹å‡»åçš„é«˜äº®æ•ˆæœ */
.btn-month-nav:active, .btn-month-nav:focus { outline: none; transform: none; opacity: 0.6; }
.btn-month-nav:hover { opacity: 1; }

.nav-icon { width: 1.2rem; height: 1.2rem; }
.rotate-180 { transform: rotate(180deg); }

/* æ—¥å†ç½‘æ ¼ */
.cal-header-row, .cal-body-grid {
    display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 0.5rem;
}
.cal-head { 
    text-align: center; color: #bbb; font-size: 0.8rem; font-weight: 600; 
    display: flex; align-items: center; justify-content: center;
}
.cal-cell {
    aspect-ratio: 1/1; display: flex; justify-content: center; align-items: center;
    border-radius: 50%; font-size: 0.95rem; cursor: pointer;
    transition: all 0.15s; position: relative; margin: 1px;
}
.cal-cell.today { border: 1.5px solid var(--primary); color: var(--primary); font-weight: 700; }
.cal-cell.has-data { background: var(--primary); color: #fff; box-shadow: 0 2px 6px rgba(255, 126, 174, 0.4); }
.cal-cell.other-month { color: #eee; font-weight: 400; }
.cal-cell:active { transform: scale(0.9); }

/* åº•éƒ¨æ“ä½œæ  (New Layout) */
.cal-action-bar {
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    margin-top: 1.5rem; 
    padding-top: 1rem; 
    border-top: 1px solid #f5f5f5;
}

/* å·¦ä¾§æŒ‰é’®ç»„ */
.cal-nav-group {
    display: flex;
    gap: 0.5rem;
}

.btn-jump {
    font-size: 0.85rem; 
    color: var(--gray-text); 
    background: #f7f7f7;
    border: none; 
    padding: 0.5rem 1rem; 
    border-radius: 2rem;
    cursor: pointer; 
    font-weight: 500;
}
.btn-jump:disabled { opacity: 0.4; cursor: not-allowed; background: #fafafa; }
/* å»é™¤ç‚¹å‡»é«˜äº®/ç¼©æ”¾ */
.btn-jump:active, .btn-jump:focus { transform: none; outline: none; background: #f7f7f7; } 

/* å³ä¾§å…³é—­æŒ‰é’® (ç²‰è‰²é£æ ¼) */
.btn-close-primary {
    background: var(--primary);
    color: #fff;
    border: none;
    padding: 0.5rem 1.2rem;
    border-radius: 2rem;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(255, 126, 174, 0.3);
}
.btn-close-primary:active { transform: scale(0.96); }

footer{text-align:center;padding:2rem 1rem;color:#d9d9d9;font-size:.8rem}
</style>
</head>
<body>

<div id="topbar">
    ç»æœŸé¢„æµ‹å·¥å…·
    <div id="toolbar">
                       
    </div>    
</div>

<main>
    <article class="card">
        <div class="card-header">
            <div class="card-title">ç»æœŸè®°å½•</div>
        </div>
        <div class="status-box">
            <p id="status-text" class="empty-tip">è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ æ•°æ®</p>
            
            <button class="btn-main-action" id="mainAddBtn">
                <img src="https://lestoy.com/love/icones/calendar.svg" class="btn-icon-small">
                ç®¡ç†æˆ‘çš„è®°å½•
            </button>
        </div>
    </article>

    <div id="results-wrapper" style="display:none;">
        <article class="card">
            <div class="card-header"><div class="card-title">ä¸‹ä¸€æ¬¡ç»æœŸ</div></div>
            <div class="prediction-highlight">
                <p class="label">é¢„è®¡å¼€å§‹æ—¶é—´</p>
                <div class="date" id="predicted-date">--</div>
                <div class="range-badge" id="predicted-range">é¢„æµ‹èŒƒå›´: --</div>
            </div>
        </article>

        <article class="card ovulation-card">
            <div class="card-header"><div class="card-title">æ’åµä¸å¤‡å­•</div></div>
            <div class="prediction-highlight ovulation-highlight">
                <p class="label">æ’åµæ—¥ (å—å­•æ¦‚ç‡é«˜)</p>
                <div class="date" id="ovulation-date">--</div>
            </div>
            
            <div class="fertile-window-box">
                <div class="fertile-info">
                    <h4>æ˜“å­•çª—å£æœŸ</h4>
                    <div id="fertile-range">-- è‡³ --</div>
                </div>
                <div class="icon-heart">ğŸ’œ</div>
            </div>

            <div class="timeline-container">
                <div class="timeline-bar">
                    <div class="t-seg t-safe"></div>
                    <div class="t-seg t-fertile"></div>
                    <div class="t-seg t-ovulation"></div>
                    <div class="t-seg t-fertile"></div>
                    <div class="t-seg t-safe"></div>
                    <div class="t-seg t-period"></div>
                </div>
                <div class="timeline-legend">
                    <div class="legend-item"><div class="dot" style="background:var(--fertile)"></div>æ’åµæœŸ</div>
                    <div class="legend-item"><div class="dot" style="background:var(--primary)"></div>ç»æœŸ</div>
                </div>
            </div>
        </article>

        <article class="card analysis">
            <div class="card-header"><div class="card-title">å‘¨æœŸæ•°æ®åˆ†æ</div></div>
            <div style="height: 200px; width: 100%;">
                <canvas id="cycle-chart"></canvas>
            </div>
            <div class="stats-grid">
                <div class="stat-box">
                    <span class="stat-label">å¹³å‡å‘¨æœŸ</span>
                    <strong class="stat-value highlight" id="stat-avg">--</strong>
                </div>
                <div class="stat-box">
                    <span class="stat-label">æœ€çŸ­</span>
                    <strong class="stat-value" id="stat-shortest">--</strong>
                </div>
                <div class="stat-box">
                    <span class="stat-label">æœ€é•¿</span>
                    <strong class="stat-value" id="stat-longest">--</strong>
                </div>
            </div>
        </article>
    </div>
</main>

<footer>â”€â”€ â€¢ â”€â”€</footer>

<div id="calendarModal" class="modal">
    <div class="modal-box">
        <div class="cal-ctrl-bar">
            <button class="btn-month-nav" id="prevMonthBtn">
                <img src="https://lestoy.com/love/icones/back.svg" class="nav-icon">
            </button>
            <div class="cal-month-label" id="calMonthLabel">--</div>
            <button class="btn-month-nav" id="nextMonthBtn">
                <img src="https://lestoy.com/love/icones/back.svg" class="nav-icon rotate-180">
            </button>
        </div>

        <div class="cal-header-row">
            <div class="cal-head">æ—¥</div><div class="cal-head">ä¸€</div><div class="cal-head">äºŒ</div>
            <div class="cal-head">ä¸‰</div><div class="cal-head">å››</div><div class="cal-head">äº”</div><div class="cal-head">å…­</div>
        </div>
        <div class="cal-body-grid" id="calBodyGrid"></div>

        <div class="cal-action-bar">
            <div class="cal-nav-group">
                <button class="btn-jump" id="jumpPrevBtn">ä¸Šä¸ªè®°å½•</button>
                <button class="btn-jump" id="jumpNextBtn">ä¸‹ä¸ªè®°å½•</button>
            </div>
            <button class="btn-close-primary" id="closeModalBtn">å®Œæˆ</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- æ•°æ® ---
    let records = new Set(); 
    let displayDate = new Date();
    let cycleChart = null;

    // --- DOM ---
    const mainAddBtn = document.getElementById('mainAddBtn');
    
    const statusText = document.getElementById('status-text');
    const resultsWrapper = document.getElementById('results-wrapper');
    
    // Modal
    const calendarModal = document.getElementById('calendarModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const calMonthLabel = document.getElementById('calMonthLabel');
    const calBodyGrid = document.getElementById('calBodyGrid');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const jumpPrevBtn = document.getElementById('jumpPrevBtn');
    const jumpNextBtn = document.getElementById('jumpNextBtn');

    // Results
    const predictedDateEl = document.getElementById('predicted-date');
    const predictedRangeEl = document.getElementById('predicted-range');
    const ovulationDateEl = document.getElementById('ovulation-date');
    const fertileRangeEl = document.getElementById('fertile-range');
    const statAvg = document.getElementById('stat-avg');
    const statShortest = document.getElementById('stat-shortest');
    const statLongest = document.getElementById('stat-longest');
    const chartCanvas = document.getElementById('cycle-chart');

    // --- å·¥å…· ---
    const formatDate = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const formatDateShort = d => `${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
    const parseDate = s => new Date(s + 'T00:00:00');

    // --- 1. åˆå§‹åŒ– ---
    function loadData() {
        try {
            const saved = localStorage.getItem('periodRecords_v5');
            if (saved) records = new Set(JSON.parse(saved));
        } catch(e){ records = new Set(); }
        updateUI();
    }

    function saveData() {
        localStorage.setItem('periodRecords_v5', JSON.stringify(Array.from(records)));
        updateUI();
    }

    // --- 2. UI æ›´æ–° ---
    function updateUI() {
        const sorted = Array.from(records).map(parseDate).sort((a,b) => a - b);

        if (sorted.length === 0) {
            statusText.textContent = "è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ æ•°æ®";
            resultsWrapper.style.display = 'none';
        } else {
            const lastDate = sorted[sorted.length-1];
            statusText.textContent = `æœ€è¿‘ä¸€æ¬¡è®°å½•ï¼š${formatDate(lastDate)}`;
            
            if (sorted.length >= 1) { 
                resultsWrapper.style.display = 'block';
                calculatePrediction(sorted);
            }
        }
        updateJumpButtons();
    }

    // --- 3. é¢„æµ‹ ---
    function calculatePrediction(sortedDates) {
        let avg = 28;
        let cycleLengths = [];

        if (sortedDates.length >= 2) {
            let wSum = 0, wDiv = 0;
            for(let i=1; i<sortedDates.length; i++){
                const diff = Math.abs(sortedDates[i] - sortedDates[i-1]);
                const days = Math.round(diff / 864e5);
                cycleLengths.push(days);
                wSum += days * i; wDiv += i;
            }
            avg = Math.round(wSum / wDiv);
        }

        const lastDate = sortedDates[sortedDates.length - 1];
        const nextDate = new Date(lastDate);
        nextDate.setDate(nextDate.getDate() + avg);
        
        const buffer = cycleLengths.length ? Math.ceil((Math.max(...cycleLengths) - Math.min(...cycleLengths))/2) : 2;
        const rStart = new Date(nextDate); rStart.setDate(rStart.getDate() - Math.min(buffer, 3));
        const rEnd = new Date(nextDate); rEnd.setDate(rEnd.getDate() + Math.min(buffer, 3));

        const ovDate = new Date(nextDate); ovDate.setDate(ovDate.getDate() - 14);
        const fStart = new Date(ovDate); fStart.setDate(fStart.getDate() - 5);
        const fEnd = new Date(ovDate); fEnd.setDate(fEnd.getDate() + 1);

        predictedDateEl.textContent = formatDate(nextDate);
        predictedRangeEl.textContent = `æœ€å¯èƒ½å¼€å§‹äºï¼š${formatDateShort(rStart)} è‡³ ${formatDateShort(rEnd)}`;
        ovulationDateEl.textContent = formatDate(ovDate);
        fertileRangeEl.textContent = `${formatDateShort(fStart)} è‡³ ${formatDateShort(fEnd)}`;

        statAvg.textContent = avg + ' å¤©';
        statShortest.textContent = (cycleLengths.length ? Math.min(...cycleLengths) : '--') + ' å¤©';
        statLongest.textContent = (cycleLengths.length ? Math.max(...cycleLengths) : '--') + ' å¤©';

        renderChart(cycleLengths, avg);
    }

    function renderChart(dataArr, avgVal) {
        if(cycleChart) cycleChart.destroy();
        const ctx = chartCanvas.getContext('2d');
        if(dataArr.length === 0) return;

        const avgData = Array(dataArr.length).fill(avgVal);

        cycleChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dataArr.map((_, i) => `${i+1}`),
                datasets: [
                    {
                        label: 'å‘¨æœŸå¤©æ•°', data: dataArr,
                        borderColor: '#FF7EAE', backgroundColor: '#FF7EAE',
                        tension: 0.3, pointRadius: 4,
                    },
                    {
                        label: 'å¹³å‡å¤©æ•°', data: avgData,
                        borderColor: '#FF9B7E', borderDash: [5, 5],
                        pointRadius: 3, pointBackgroundColor: '#fff', pointBorderColor: '#FF9B7E',
                        pointBorderWidth: 2, borderWidth: 2, fill: false, tension: 0
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,                               
                plugins: { legend: { display: true, position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 8, font: { size: 11 } } } },
                scales: {
    y: { 
        grid: { color: '#f5f5f5' }, 
        ticks: { stepSize: 1, color: '#bbb' } 
    },
    x: { 
        grid: { display: false }, 
        ticks: { 
            color: '#bbb',
            maxRotation: 0,  // <--- æ·»åŠ è¿™ä¸€è¡Œï¼šå¼ºåˆ¶æœ€å¤§æ—‹è½¬ä¸º0åº¦
            minRotation: 0   // <--- æ·»åŠ è¿™ä¸€è¡Œï¼šå¼ºåˆ¶æœ€å°æ—‹è½¬ä¸º0åº¦
        } 
    }
}
            }
        });
    }

    // --- 4. Modal ---
    function openModal() {
        const sorted = Array.from(records).map(parseDate).sort((a,b) => a-b);
        if(sorted.length > 0) displayDate = new Date(sorted[sorted.length-1]);
        else displayDate = new Date();
        renderCalendar();
        calendarModal.classList.add('show');
        document.body.classList.add('noscroll');
    }
    
    function closeModal() {
        calendarModal.classList.remove('show');
        document.body.classList.remove('noscroll');
    }

    function renderCalendar() {
        const year = displayDate.getFullYear();
        const month = displayDate.getMonth();
        calMonthLabel.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        calBodyGrid.innerHTML = '';

        const firstDay = new Date(year, month, 1).getDay(); 
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();
        const todayStr = formatDate(new Date());

        for (let i = 0; i < 42; i++) {
            const el = document.createElement('div');
            el.className = 'cal-cell';
            const dayOffset = i - firstDay + 1;

            if (dayOffset <= 0) {
                el.textContent = daysInPrevMonth + dayOffset;
                el.classList.add('other-month');
                el.onclick = () => prevMonthBtn.click();
            } else if (dayOffset > daysInMonth) {
                el.textContent = dayOffset - daysInMonth;
                el.classList.add('other-month');
                el.onclick = () => nextMonthBtn.click();
            } else {
                const d = new Date(year, month, dayOffset);
                const dStr = formatDate(d);
                el.textContent = dayOffset;
                if(dStr === todayStr) el.classList.add('today');
                if(records.has(dStr)) el.classList.add('has-data');

                el.onclick = () => {
                    if(records.has(dStr)) records.delete(dStr);
                    else records.add(dStr);
                    saveData();
                    el.classList.toggle('has-data');
                    updateJumpButtons();
                };
            }
            calBodyGrid.appendChild(el);
        }
        updateJumpButtons();
    }

    // --- 5. Controls ---
    prevMonthBtn.onclick = () => { displayDate.setMonth(displayDate.getMonth()-1); renderCalendar(); };
    nextMonthBtn.onclick = () => { displayDate.setMonth(displayDate.getMonth()+1); renderCalendar(); };
    
    let tx = 0;
    calBodyGrid.addEventListener('touchstart', e => tx = e.changedTouches[0].screenX, {passive:true});
    calBodyGrid.addEventListener('touchend', e => {
        if(Math.abs(e.changedTouches[0].screenX - tx) > 50) {
            (e.changedTouches[0].screenX - tx) > 0 ? prevMonthBtn.click() : nextMonthBtn.click();
        }
    }, {passive:true});

    function updateJumpButtons() {
        const sorted = Array.from(records).map(parseDate).sort((a,b) => a - b);
        if(sorted.length === 0) {
            jumpPrevBtn.disabled = true; jumpNextBtn.disabled = true; return;
        }
        const viewStart = new Date(displayDate.getFullYear(), displayDate.getMonth(), 1);
        const viewEnd = new Date(displayDate.getFullYear(), displayDate.getMonth() + 1, 0);
        
        jumpPrevBtn.disabled = !sorted.some(d => d < viewStart);
        jumpNextBtn.disabled = !sorted.some(d => d > viewEnd);
    }

    jumpPrevBtn.onclick = () => {
        const sorted = Array.from(records).map(parseDate).sort((a,b) => b - a);
        const viewStart = new Date(displayDate.getFullYear(), displayDate.getMonth(), 1);
        const target = sorted.find(d => d < viewStart);
        if(target) { displayDate = new Date(target); renderCalendar(); }
    };

    jumpNextBtn.onclick = () => {
        const sorted = Array.from(records).map(parseDate).sort((a,b) => a - b);
        const viewEnd = new Date(displayDate.getFullYear(), displayDate.getMonth() + 1, 0);
        const target = sorted.find(d => d > viewEnd);
        if(target) { displayDate = new Date(target); renderCalendar(); }
    };

    mainAddBtn.onclick = openModal;
    
    closeModalBtn.onclick = closeModal;
    calendarModal.onclick = (e) => { if(e.target === calendarModal) closeModal(); };

    loadData();
});
</script>
</body>
</html>

